# ✅ 信用点购买 API CREEM 参数修复完成

**修复时间**: 2025-10-18  
**分支**: public-beta  
**状态**: ✅ 已完成

---

## 🐛 问题描述

信用点购买按钮点击后，CREEM API 返回 403 Forbidden 错误。

**错误日志**:
```
❌ CREEM API error: {
  status: 403,
  error: 'Forbidden',
  timestamp: 1760768392653
}
```

**根本原因**：
信用点购买 API (`api/purchase-credits.js`) 使用了错误的参数格式，而订阅 API 已经修复过了。

---

## ✅ 修复内容

### 1️⃣ **移除 `cancel_url` 参数**

```javascript
// ❌ 修复前
const creemPayload = {
  product_id: pack.productId,
  success_url: successUrl,
  cancel_url: cancelUrl,  // ❌ CREEM 不支持此参数
  // ...
};
```

```javascript
// ✅ 修复后
const creemPayload = {
  product_id: pack.productId,
  success_url: successUrl,
  // ✅ 移除了 cancel_url
  // ...
};
```

---

### 2️⃣ **将 `custom_field` 改为 `metadata`**

```javascript
// ❌ 修复前
custom_field: {
  type: 'credits',
  pack_type: packType,
  // ...
}
```

```javascript
// ✅ 修复后
metadata: {
  type: 'credits',
  pack_type: packType,
  // ...
}
```

---

### 3️⃣ **使用正确的认证方式**

```javascript
// ❌ 修复前
headers: {
  'Authorization': `Bearer ${creemApiKey}`,
  'Content-Type': 'application/json',
}
```

```javascript
// ✅ 修复后
headers: {
  'x-api-key': creemApiKey,
  'Content-Type': 'application/json',
}
```

---

### 4️⃣ **增强 Checkout URL 检测**

```javascript
// ✅ 支持多种可能的 URL 字段名
const checkoutUrl = session.url 
  || session.checkout_url 
  || session.payment_url 
  || session.link;

if (!checkoutUrl) {
  throw new Error('No checkout URL in CREEM response');
}
```

---

### 5️⃣ **添加详细调试日志**

```javascript
console.log('========== CREEM API Response ==========');
console.log('🔍 Full Response:', JSON.stringify(session, null, 2));
console.log('🔍 Response Keys:', Object.keys(session));
console.log('🔍 session.url:', session.url);
console.log('🔍 session.checkout_url:', session.checkout_url);
console.log('🔍 session.payment_url:', session.payment_url);
console.log('========================================');
```

---

## 📊 修改对比

| 项目 | 修复前 | 修复后 |
|------|--------|--------|
| **认证方式** | `Authorization: Bearer` | `x-api-key` |
| **成功 URL** | 包含 `cancel_url` | 仅 `success_url` |
| **自定义数据** | `custom_field` | `metadata` |
| **URL 检测** | 仅 `session.url` | 支持多种字段名 |
| **调试日志** | 基础 | 详细的响应调试 |

---

## 🔗 相关文件

| 文件 | 修改内容 |
|------|---------|
| `api/purchase-credits.js` | 应用与订阅 API 相同的 CREEM 参数修复 |

---

## 📋 测试清单

请在 Vercel 预览环境测试：

### **1. 信用点购买流程**
- [ ] 点击任一信用点购买按钮（100/300/1000）
- [ ] 应该成功跳转到 CREEM 支付页面
- [ ] Vercel Logs 不应再有 403 错误

### **2. 订阅流程（回归测试）**
- [ ] 点击订阅按钮
- [ ] 应该成功跳转到 CREEM 支付页面
- [ ] 不应受到本次修改的影响

### **3. 检查 Vercel Logs**
- [ ] 信用点购买：确认无 403/400 错误
- [ ] 订阅：确认依然正常工作
- [ ] 查看详细的 CREEM API 响应日志

---

## 📊 部署状态

- ✅ 代码已提交到 `public-beta` 分支
- ✅ 已推送到 GitHub
- ⏳ 等待 Vercel 自动部署

---

## 🎯 下一步

1. **等待 Vercel 部署完成**（约 1-2 分钟）
2. **测试信用点购买流程**
3. **回归测试订阅流程**
4. **验证两个流程都能成功跳转到 CREEM 支付页面**

---

## 💡 经验总结

### **保持 API 一致性**
- 订阅 API 和信用点购买 API 使用相同的 CREEM 集成方式
- 修复一个时要检查其他类似的 API
- 统一的错误处理和调试日志

### **CREEM API 集成要点**
1. ✅ 使用 `x-api-key` 认证（不是 Bearer Token）
2. ✅ 只使用 `success_url`（不要 `cancel_url`）
3. ✅ 使用 `metadata`（不是 `custom_field`）
4. ✅ 支持多种可能的 URL 字段名

---

**状态**: ✅ 修复完成，待测试验证

