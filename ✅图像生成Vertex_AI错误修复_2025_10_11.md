# ✅ 图像生成 Vertex AI 错误修复

**修复日期**: 2025年10月11日  
**状态**: ✅ 已完成

## 问题描述

部署后图像生成功能报错：
```
Error: This method is only supported by the Vertex AI.
at Models.editImage (file:///var/task/node_modules/@google/genai/dist/node/index.mjs:12207:31)
```

### 错误原因

代码使用了 `editImage` 方法，但该方法只在 **Vertex AI** 中支持，不在 **Google GenAI SDK**（使用 API Key）中支持。

## 解决方案

根据 Google GenAI SDK 文档，应该使用 `generateContent` 方法配合 **gemini-2.5-flash-image** 模型来进行图像编辑。

### 修改内容

#### 1. 更新导入 (`api/generate-image.ts`)

```typescript
// 之前
import { GoogleGenAI, RawReferenceImage } from '@google/genai';

// 修改后
import { GoogleGenAI, Part } from '@google/genai';
```

#### 2. 重构图像处理函数

```typescript
// 之前: buildReferenceImages() 返回 RawReferenceImage[]
const buildReferenceImages = (normalizedImages: string[]): RawReferenceImage[] => {
  // ... 构建 RawReferenceImage 对象
}

// 修改后: buildImageParts() 返回 Part[]
const buildImageParts = (normalizedImages: string[]): Part[] => {
  return normalizedImages.map((imgData) => {
    const buffer = Buffer.from(imgData, 'base64');
    const { mimeType } = detectImageType(buffer);
    
    return {
      inlineData: {
        data: imgData,
        mimeType,
      },
    } as Part;
  }).filter((value): value is Part => value !== null);
}
```

#### 3. 更新 API 调用

```typescript
// 之前: 使用 editImage 或 generateImages
const response = await aiClient.models.editImage({
  model: modelName,
  prompt: instruction,
  referenceImages,
  config: { ... },
});

// 修改后: 使用 generateContent
const imageParts = buildImageParts(normalizedImages);
const contents = [...imageParts, instruction];

const response = await aiClient.models.generateContent({
  model: 'gemini-2.5-flash-image',
  contents,
});
```

#### 4. 更新响应解析

```typescript
// 之前
const generatedImage = response.generatedImages?.find((image) => image.image?.imageBytes);
const base64 = generatedImage?.image?.imageBytes;

// 修改后
const generatedImagePart = response.candidates?.[0]?.content?.parts?.find(
  (part: any) => part.inlineData
);
const base64 = generatedImagePart?.inlineData?.data;
```

## 技术说明

### Google GenAI SDK vs Vertex AI

| 特性 | Google GenAI SDK | Vertex AI |
|------|------------------|-----------|
| 认证方式 | API Key | Service Account |
| 图像编辑方法 | `generateContent` | `editImage` |
| 适用场景 | 简单应用 | 企业级应用 |

### 使用的模型

- **模型名称**: `gemini-2.5-flash-image`
- **功能**: 支持图像生成和编辑
- **输入**: 图像 Part[] + 文本 Prompt
- **输出**: 包含生成图像的 Content Parts

## 验证步骤

1. 部署到 Vercel：`git push`
2. 打开应用并登录
3. 选择房间类型和设计风格
4. 上传参考图片
5. 点击"Generate"按钮
6. 检查日志确认无错误：
   - ✅ 用户认证成功
   - ✅ 扣除信用点
   - ✅ 调用 Gemini API
   - ✅ 返回生成的图片

## 相关文件

- `api/generate-image.ts` - 主要修改文件
- `package.json` - 依赖包配置（使用 `@google/genai`）

## 参考文档

- [Google GenAI SDK Documentation](https://github.com/googleapis/js-genai)
- [Gemini API - Image Editing](https://github.com/googleapis/js-genai/blob/main/codegen_instructions.md)

