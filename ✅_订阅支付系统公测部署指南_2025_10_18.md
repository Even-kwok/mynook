# ✅ 订阅支付系统公测部署指南

**日期**: 2025-10-18  
**分支**: `public-beta`  
**状态**: 🟡 等待配置 CREEM 和 Vercel 环境变量

---

## 📊 当前进度

### ✅ 已完成
- ✅ 数据库迁移完成 - `subscriptions` 表和相关配置已就绪
- ✅ `public-beta` 分支已创建并推送到 GitHub
- ✅ Vercel 预览部署已自动触发

### 🟡 待完成（需要您手动操作）
- 🟡 配置 Vercel 环境变量
- 🟡 验证 CREEM Product IDs
- 🟡 配置 CREEM Webhook URL
- 🟡 测试支付流程

---

## 🚀 接下来的步骤

### **第一步：获取 Vercel 预览部署 URL** ⏱️ 2分钟

1. 访问 [Vercel Dashboard](https://vercel.com/dashboard)
2. 进入您的项目（mynook）
3. 点击 **Deployments** 标签
4. 找到 `public-beta` 分支的最新部署
5. 复制部署 URL（类似：`https://mynook-xxxxx.vercel.app`）

**记下这个 URL**，后续步骤会用到！

---

### **第二步：配置 Vercel 环境变量** ⏱️ 5分钟

在 Vercel Dashboard → Settings → Environment Variables：

#### 需要添加的环境变量：

| 变量名 | 值 | 环境 |
|--------|-----|------|
| `CREEM_API_KEY` | 您的 CREEM API Key（以 `sk_` 开头） | Production, Preview, Development |
| `CREEM_WEBHOOK_SECRET` | 您的 CREEM Webhook Secret | Production, Preview, Development |
| `CREEM_API_URL` | `https://api.creem.io` | Production, Preview, Development |

#### 如何获取 CREEM 凭证：

1. 访问 [CREEM Dashboard](https://dashboard.creem.io)
2. **获取 API Key**：
   - Settings → API Keys
   - 复制 **Secret Key**（以 `sk_` 开头）
3. **获取 Webhook Secret**：
   - Developers → Webhooks
   - 复制 **Signing Secret**

#### 重要提示：
- ⚠️ 不要在这些变量名前加 `VITE_` 前缀（安全考虑）
- ✅ 确保选择所有环境：**Production, Preview, Development**
- ✅ 添加完后点击 **Save**

配置完成后，**重新部署** preview 分支：
- Deployments → 找到 `public-beta` → 点击 **⋯** → **Redeploy**

---

### **第三步：验证 CREEM Product IDs** ⏱️ 3分钟

在 CREEM Dashboard → Products 页面，验证以下 Product IDs 是否正确：

#### 当前代码中配置的 Product IDs：

```javascript
Pro 月付:      prod_2JlRhCPx3dJVaQUNLRgo6D
Pro 年付:      prod_43bA82tdR38NzQksz6fHxH

Premium 月付:  prod_3wRnKHJa6LSF5afsd1QjEG
Premium 年付:  prod_18rfRuIGJVtWPeIIfZpLWA

Business 月付: prod_wMGy2WQe6Kv5PmTZLjcsn
Business 年付: prod_6065m1QjyimGZ8lg15pqB5
```

#### 验证步骤：
1. 在 CREEM Dashboard 找到对应的 6 个产品
2. 检查每个产品的 Product ID 是否与上述一致
3. 如果不一致，记录下正确的 Product IDs（稍后需要更新代码）

---

### **第四步：配置 CREEM Webhook** ⏱️ 3分钟

在 CREEM Dashboard → Developers → Webhooks：

1. 点击 **Add Endpoint** 或 **Create Webhook**
2. 输入 Webhook URL：
   ```
   https://您的预览部署URL.vercel.app/api/webhook
   ```
   
   例如：`https://mynook-abc123.vercel.app/api/webhook`

3. 选择要监听的事件（全选以下）：
   - ✅ `checkout.session.completed`
   - ✅ `payment.succeeded`
   - ✅ `payment_intent.succeeded`
   - ✅ `subscription.created`
   - ✅ `customer.subscription.created`
   - ✅ `subscription.updated`
   - ✅ `customer.subscription.updated`
   - ✅ `subscription.deleted`
   - ✅ `customer.subscription.deleted`

4. 点击 **Save** 或 **Create**

5. 复制 **Webhook Signing Secret**（如果之前没有复制）

---

### **第五步：测试支付流程** ⏱️ 10分钟

#### 测试订阅购买：

1. 访问您的预览部署：`https://您的URL.vercel.app`
2. 登录您的测试账户
3. 进入 Pricing 页面：`https://您的URL.vercel.app/pricing`
4. 选择任意订阅计划（建议先测试 Pro 月付）
5. 点击 **Subscribe** 按钮

#### 预期结果：
- ✅ 页面应该跳转到 CREEM 支付页面
- ✅ 如果没有跳转，检查浏览器控制台的错误信息

#### 完成测试支付：

使用 CREEM 测试卡：
- **卡号**：`4242 4242 4242 4242`
- **过期日期**：任意未来日期（如 12/25）
- **CVC**：任意 3 位数（如 123）
- **邮编**：任意（如 12345）

#### 支付成功后：
- ✅ 应该重定向回您的网站
- ✅ URL 中应该包含 `?message=subscription-success`

---

### **第六步：验证订阅激活** ⏱️ 5分钟

#### 检查前端状态：
1. 刷新页面
2. 查看右上角用户信息
3. 会员等级应该已更新（Pro/Premium/Business）
4. 信用点应该已充值（1000/5000/25000）

#### 检查 Vercel Logs：
1. Vercel Dashboard → Functions
2. 搜索 `/api/webhook`
3. 查看最近的日志

**应该看到：**
```
✅ Webhook signature verified
📨 Event type: checkout.session.completed
📋 Activating premium subscription for user xxx
✅ Subscription activated: premium
✅ Credits updated: 0 → 5000
```

#### 检查数据库（通过 Supabase SQL Editor）：

```sql
-- 检查用户会员等级和信用点
SELECT id, email, membership_tier, credits, subscription_status
FROM users
WHERE email = '您的测试邮箱';

-- 检查订阅记录
SELECT id, plan_type, status, amount, created_at
FROM subscriptions
WHERE user_id = '您的用户ID'
ORDER BY created_at DESC;
```

**预期结果：**
- ✅ `membership_tier` 已更新为您购买的等级
- ✅ `credits` 已充值
- ✅ `subscription_status` = 'active'
- ✅ `subscriptions` 表中有新记录

---

## 🐛 常见问题排查

### 问题 1：点击 Subscribe 后没有跳转

**可能原因：**
- CREEM API Key 未配置或错误
- Product ID 不正确

**排查步骤：**
1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签的错误信息
3. 查看 Network 标签，找到 `/api/subscribe` 请求
4. 检查响应内容

**解决方法：**
- 验证 Vercel 环境变量是否正确配置
- 检查 CREEM API Key 是否有效
- 验证 Product IDs

---

### 问题 2：Webhook 未触发

**可能原因：**
- Webhook URL 配置错误
- Webhook Secret 不匹配
- CREEM 端发送失败

**排查步骤：**
1. 在 CREEM Dashboard → Webhooks 查看发送历史
2. 检查 Webhook 状态（成功/失败）
3. 查看失败原因

**解决方法：**
- 确认 Webhook URL 正确（包含 `/api/webhook`）
- 重新配置 Webhook Secret
- 在 CREEM Dashboard 手动重发 Webhook

---

### 问题 3：订阅状态未更新

**可能原因：**
- Webhook 处理失败
- 数据库更新失败
- Webhook Secret 验证失败

**排查步骤：**
1. 查看 Vercel Function Logs
2. 搜索 "webhook" 或 "error"
3. 查看具体错误信息

**解决方法：**
- 检查 `CREEM_WEBHOOK_SECRET` 环境变量
- 确认 Supabase Service Key 配置正确
- 在 CREEM Dashboard 重新发送 Webhook

---

## 📝 测试清单

完成以下所有测试后，即可合并到主分支：

### 订阅功能测试
- [ ] Pro 月付订阅购买成功
- [ ] Pro 年付订阅购买成功
- [ ] Premium 月付订阅购买成功
- [ ] Premium 年付订阅购买成功
- [ ] Business 月付订阅购买成功
- [ ] Business 年付订阅购买成功

### Webhook 测试
- [ ] `checkout.session.completed` 事件接收成功
- [ ] `payment.succeeded` 事件接收成功
- [ ] Webhook 签名验证通过
- [ ] 数据库订阅记录创建成功

### 数据验证
- [ ] 用户会员等级正确更新
- [ ] 信用点正确充值
- [ ] `subscription_status` = 'active'
- [ ] `subscriptions` 表记录完整

### 功能验证
- [ ] 付费功能正常解锁（如 Free Canvas）
- [ ] 图片生成正常工作
- [ ] 信用点正确扣除

---

## 🎯 完成后的下一步

测试全部通过后：

1. **创建 Pull Request**
   ```bash
   # 访问 GitHub
   https://github.com/Even-kwok/mynook/pull/new/public-beta
   ```

2. **审查代码变更**
   - 确认所有文件变更正确
   - 检查是否有遗漏

3. **合并到主分支**
   ```bash
   # 在 GitHub PR 页面点击 Merge
   # 或使用命令行：
   git checkout main
   git merge public-beta
   git push origin main
   ```

4. **配置生产环境 Webhook**
   - 在 CREEM Dashboard 添加生产环境的 Webhook URL
   - URL: `https://您的生产域名.vercel.app/api/webhook`

5. **监控生产环境**
   - 查看 Vercel Logs
   - 监控用户反馈
   - 准备上线公告

---

## 📞 需要帮助？

如果遇到问题：

1. **查看日志**
   - Vercel Function Logs
   - Supabase Logs
   - CREEM Webhook 历史

2. **验证配置**
   - 环境变量是否正确
   - Webhook URL 是否正确
   - Product IDs 是否匹配

3. **联系支持**
   - CREEM 官方文档
   - Supabase 社区
   - 或向我提问

---

## 📚 相关文档

- [订阅功能摘要](./SUBSCRIPTION_FEATURE_SUMMARY.md)
- [订阅部署指南](./SUBSCRIPTION_DEPLOYMENT_GUIDE.md)
- [会员等级配置](./MEMBERSHIP_CREDITS_UPDATE.md)

---

**祝部署顺利！** 🚀

有任何问题随时找我！

