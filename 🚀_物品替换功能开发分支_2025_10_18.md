# 🚀 物品替换功能开发分支创建

**日期**: 2025-10-18  
**分支名**: `feature/item-replace`  
**状态**: ✅ 已创建并推送到远程

---

## 📋 分支信息

- **分支名称**: `feature/item-replace`
- **基于分支**: `public-beta` (提交 `887b95b`)
- **远程仓库**: `origin/feature/item-replace`
- **创建时间**: 2025-10-18

---

## 🎯 功能目标

### Item Replace（物品替换）功能

这是一个允许用户在现有设计中替换特定物品的功能，类似于：
- 替换房间中的家具
- 更换墙上的装饰品
- 修改特定区域的设计元素

### 预期工作流程

1. **上传图片** - 用户上传包含物品的图片
2. **选择区域** - 用户圈选或标记要替换的物品
3. **描述新物品** - 用户描述想要的替换物品
4. **AI 生成** - 系统生成替换后的效果图
5. **预览对比** - 显示替换前后的对比

---

## 🛠️ 技术架构规划

### 前端组件（需要创建）

```
components/
  └── ItemReplacePage.tsx          # 主页面组件
  └── ItemReplaceCanvas.tsx        # 画布组件（圈选区域）
  └── ItemReplacePreview.tsx       # 预览对比组件
  └── ItemReplaceHistory.tsx       # 历史记录组件
```

### API 端点（需要创建）

```
api/
  └── item-replace/
      ├── upload.ts                # 图片上传
      ├── generate.ts              # AI 生成替换
      └── history.ts               # 历史记录管理
```

### 数据库表（需要创建）

```sql
-- 物品替换历史表
CREATE TABLE item_replace_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  original_image_url TEXT NOT NULL,
  result_image_url TEXT,
  mask_data JSONB,                 -- 圈选区域数据
  replace_prompt TEXT,              -- 替换描述
  status VARCHAR(20),               -- pending, processing, completed, failed
  credits_used INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 📦 依赖库考虑

### 前端画布操作
- **Fabric.js** - 画布操作和区域选择
- **React Konva** - 另一个画布库选项
- **canvas-selector** - 专门的区域选择库

### 图像处理
- **image-mask-editor** - 遮罩编辑
- **react-image-annotate** - 图像标注

### AI 集成
- **Vertex AI Vision API** - 物品识别和替换
- **Stable Diffusion Inpainting** - 图像修复技术

---

## 🎨 UI/UX 设计要点

### 用户界面布局

```
┌─────────────────────────────────────────┐
│  Header (MyNook Logo + User Menu)       │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────┐   ┌──────────────┐  │
│  │               │   │              │  │
│  │  Image Upload │   │  Description │  │
│  │  & Selection  │   │  & Controls  │  │
│  │               │   │              │  │
│  │  [Canvas]     │   │  - Prompt    │  │
│  │               │   │  - Replace   │  │
│  │               │   │  - Reset     │  │
│  └───────────────┘   └──────────────┘  │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  Preview (Before / After)       │   │
│  │  ├─────────────┬──────────────┤  │   │
│  │  │   Before    │    After     │  │   │
│  │  └─────────────┴──────────────┘  │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### 交互流程

1. **Step 1: Upload**
   - 拖放或点击上传图片
   - 显示预览

2. **Step 2: Select**
   - 使用画笔或套索工具圈选物品
   - 实时显示选中区域

3. **Step 3: Describe**
   - 输入替换物品描述
   - 可选：选择预设样式

4. **Step 4: Generate**
   - 点击"Replace"按钮
   - 显示进度条
   - 消耗信用点

5. **Step 5: Review**
   - 前后对比查看
   - 保存或重新生成

---

## 💳 信用点系统集成

### 消耗规则（建议）

| 操作 | 信用点消耗 | 说明 |
|-----|----------|------|
| 小面积替换 (< 25%) | 5 credits | 小物品，如相框、台灯 |
| 中面积替换 (25-50%) | 10 credits | 中型家具，如椅子、桌子 |
| 大面积替换 (> 50%) | 15 credits | 大型家具或多物品 |

### 会员权益

- **FREE**: 不可用（提示升级）
- **PRO**: 可用，标准价格
- **PREMIUM**: 可用，8折优惠
- **BUSINESS**: 可用，5折优惠 + 优先处理

---

## 🔐 权限控制

```typescript
// 权限检查
const canUseItemReplace = (user: User) => {
  return user.permissionLevel >= 2; // Pro 及以上
};

// 信用点检查
const hasEnoughCredits = (user: User, area: number) => {
  const required = calculateCredits(area);
  return user.credits >= required;
};
```

---

## 📊 开发任务清单

### Phase 1: 基础架构 (预计 2-3 天)
- [ ] 创建 `ItemReplacePage.tsx` 主页面
- [ ] 设计页面布局和样式
- [ ] 实现图片上传功能
- [ ] 创建路由和导航

### Phase 2: 画布功能 (预计 2-3 天)
- [ ] 集成画布库（Fabric.js 或 React Konva）
- [ ] 实现区域选择工具
- [ ] 实现画笔工具
- [ ] 实现橡皮擦工具
- [ ] 区域数据序列化

### Phase 3: AI 集成 (预计 3-4 天)
- [ ] 创建 `/api/item-replace/generate` 端点
- [ ] 集成 Vertex AI Vision API
- [ ] 实现图像修复（Inpainting）
- [ ] 实现生成状态追踪
- [ ] 错误处理和重试机制

### Phase 4: 数据库 (预计 1-2 天)
- [ ] 创建 `item_replace_history` 表
- [ ] 实现历史记录保存
- [ ] 实现历史记录查询
- [ ] 实现图片存储（Supabase Storage）

### Phase 5: UI/UX 优化 (预计 2-3 天)
- [ ] 前后对比预览
- [ ] 加载动画和进度条
- [ ] 历史记录展示
- [ ] 响应式设计
- [ ] 错误提示优化

### Phase 6: 测试 & 部署 (预计 1-2 天)
- [ ] 功能测试
- [ ] 信用点扣除测试
- [ ] 权限控制测试
- [ ] 性能优化
- [ ] 部署到测试环境

**总预计开发时间**: 11-17 天

---

## 🎯 成功指标

### 功能指标
- [ ] 用户可以成功上传图片
- [ ] 用户可以精确选择替换区域
- [ ] AI 生成结果准确度 > 80%
- [ ] 生成时间 < 30 秒

### 性能指标
- [ ] 页面加载时间 < 2 秒
- [ ] 图片上传响应 < 1 秒
- [ ] 画布操作流畅（60fps）

### 业务指标
- [ ] 功能使用率 > 20%（Pro+ 用户）
- [ ] 用户满意度 > 4.0/5.0
- [ ] 信用点转化率提升

---

## 🔄 Git 工作流程

### 开发流程

```bash
# 1. 确保在 feature/item-replace 分支
git checkout feature/item-replace

# 2. 开发功能并提交
git add .
git commit -m "feat: implement upload functionality"

# 3. 定期推送到远程
git push origin feature/item-replace

# 4. 开发完成后，合并到 public-beta
git checkout public-beta
git merge feature/item-replace

# 5. 测试通过后，推送到主分支
git push origin public-beta
```

### 提交规范

使用语义化提交信息：
- `feat:` - 新功能
- `fix:` - 修复 bug
- `ui:` - UI/样式更新
- `refactor:` - 代码重构
- `test:` - 测试相关
- `docs:` - 文档更新

---

## 📝 相关资源

### 参考实现
- Photoshop 内容感知填充
- Canva 魔术橡皮擦
- Runway ML Inpainting

### API 文档
- [Vertex AI Vision API](https://cloud.google.com/vision/docs)
- [Fabric.js Documentation](http://fabricjs.com/docs/)
- [Supabase Storage Guide](https://supabase.com/docs/guides/storage)

---

## 🚀 快速开始

```bash
# 切换到功能分支
git checkout feature/item-replace

# 安装可能需要的依赖
npm install fabric
npm install react-konva konva

# 启动开发服务器
npm run dev

# 开始开发！
```

---

## 📞 下一步行动

1. ✅ 创建功能分支 - 完成
2. ⏳ 需求细化和设计评审
3. ⏳ UI/UX 原型设计
4. ⏳ 技术方案评审
5. ⏳ 开始 Phase 1 开发

---

**分支状态**: ✅ 已创建  
**准备开始开发**: 等待需求确认  
**预计完成时间**: 2-3 周  

---

## 💬 讨论要点

在开始开发前，需要确认：

1. **功能范围**
   - 是否支持多物品同时替换？
   - 是否需要 AI 自动识别物品？
   - 是否支持自定义样式预设？

2. **技术选型**
   - 使用 Fabric.js 还是 React Konva？
   - 使用 Vertex AI 还是其他 AI 服务？
   - 图片存储策略？

3. **定价策略**
   - 信用点消耗如何定价？
   - 是否提供免费试用？
   - 会员折扣比例？

---

**准备就绪，等待开始开发！** 🎉

