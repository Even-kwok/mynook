# 🔧 订阅支付问题快速排查指南

**问题**: 点击订阅按钮后没有跳转到支付页面

---

## 🎯 立即检查（3个步骤）

### **步骤 1: 检查浏览器控制台错误** ⚡ 最重要！

1. 打开您的应用 Pricing 页面
2. 按 **F12** 打开开发者工具
3. 切换到 **Console** 标签
4. 点击订阅按钮
5. 查看控制台输出的错误信息

#### 📸 应该看到的正常日志：
```
✅ Session obtained, calling subscription API...
```

#### ❌ 可能的错误信息：

**错误 1: 401 Unauthorized**
```
❌ Auth error: Invalid token
```
**解决**: 重新登录账户

**错误 2: 500 Server Error**
```
❌ Server error: 500
❌ CREEM_API_KEY not configured
```
**解决**: 检查 Vercel 环境变量

**错误 3: CREEM API Error**
```
❌ CREEM API error: Invalid product_id
```
**解决**: Product ID 配置错误

**错误 4: Network Error**
```
❌ Failed to fetch
```
**解决**: 检查网络连接或 API 端点

---

### **步骤 2: 检查 Vercel Function Logs** 🔍

1. 访问 [Vercel Dashboard](https://vercel.com/dashboard)
2. 进入您的项目
3. 点击顶部的 **Logs** 或 **Functions** 标签
4. 搜索 `/api/subscribe`
5. 查看最近的请求日志

#### 应该看到的日志：
```
✅ Session obtained
✅ Supabase credentials found
✅ User authenticated: xxx-xxx-xxx
✅ Calling CREEM API...
✅ Using Product ID: prod_xxxxx for premium yearly
✅ CREEM checkout session created: cs_xxxxx
```

#### 可能的错误日志：

**错误 1: 环境变量缺失**
```
❌ CREEM_API_KEY not configured
```
**解决**: 
- 进入 Vercel → Settings → Environment Variables
- 确认 `CREEM_API_KEY` 已添加
- 确保选择了 **Preview** 环境
- 重新部署

**错误 2: CREEM API 调用失败**
```
❌ CREEM API error: Authentication failed
```
**解决**: 
- 检查 CREEM_API_KEY 是否正确
- 确认 API Key 以 `sk_` 开头
- 在 CREEM Dashboard 验证 Key 是否有效

**错误 3: Product ID 无效**
```
❌ Product ID not found for: premium yearly
```
**解决**: 
- 在 CREEM Dashboard 验证 Product ID
- 更新代码中的 Product IDs

---

### **步骤 3: 使用调试工具** 🛠️

我已经为您创建了一个专用调试工具！

1. 访问: `https://您的域名/debug-subscription.html`
2. 确保已登录
3. 选择订阅计划和计费周期
4. 点击 **开始测试**
5. 查看详细的步骤执行结果

调试工具会显示：
- ✅ 每个步骤是否成功
- ❌ 具体哪个步骤失败
- 📋 详细的错误信息
- 💡 解决建议

---

## 🔎 深度排查

### 检查 1: Vercel 环境变量配置

在 Vercel Dashboard → Settings → Environment Variables 中确认：

| 变量名 | 值检查 | 状态 |
|--------|--------|------|
| `CREEM_API_KEY` | 以 `sk_` 开头，长度约 40+ 字符 | ⬜ |
| `CREEM_WEBHOOK_SECRET` | 以 `whsec_` 开头 | ⬜ |
| `CREEM_API_URL` | `https://api.creem.io` | ⬜ |
| `SUPABASE_SERVICE_KEY` | 以 `eyJ` 开头，非常长 | ⬜ |

**重要提示**:
- ⚠️ 添加/修改环境变量后**必须重新部署**
- ✅ 确保选择了 **Production, Preview, Development** 所有环境
- ✅ 变量名不要有 `VITE_` 前缀

---

### 检查 2: CREEM Product IDs

在 CREEM Dashboard → Products 中验证：

```javascript
当前代码中的配置：

Pro 月付:      prod_2JlRhCPx3dJVaQUNLRgo6D
Pro 年付:      prod_43bA82tdR38NzQksz6fHxH

Premium 月付:  prod_3wRnKHJa6LSF5afsd1QjEG
Premium 年付:  prod_18rfRuIGJVtWPeIIfZpLWA

Business 月付: prod_wMGy2WQe6Kv5PmTZLjcsn
Business 年付: prod_6065m1QjyimGZ8lg15pqB5
```

如果 Product IDs 不匹配，需要更新 `api/subscribe.js` 文件：
1. 找到第 115-128 行的 `PRODUCT_IDS` 配置
2. 替换为正确的 Product ID
3. 提交并推送更改

---

### 检查 3: CREEM API 端点

确认 CREEM API URL 是否正确：

```javascript
// 在 api/subscribe.js 第 102 行
const creemApiUrl = process.env.CREEM_API_URL || 'https://api.creem.io';
```

可能的 API 端点：
- ✅ `https://api.creem.io`
- ⚠️ `https://api.creem.io/v1` (如果 CREEM 使用版本化 API)
- ⚠️ 其他自定义端点

---

### 检查 4: 网络请求分析

在浏览器开发者工具的 **Network** 标签中：

1. 点击订阅按钮
2. 找到 `subscribe` 请求
3. 查看请求详情：

#### 请求头检查：
```
Content-Type: application/json
Authorization: Bearer eyJhbGc...
```

#### 请求体检查：
```json
{
  "planType": "premium",
  "billingCycle": "yearly"
}
```

#### 响应检查：

**正常响应 (200 OK):**
```json
{
  "success": true,
  "checkoutUrl": "https://checkout.creem.io/...",
  "sessionId": "cs_..."
}
```

**错误响应 (500):**
```json
{
  "error": "Payment system not configured",
  "message": "CREEM API key is missing"
}
```

---

## 💡 常见问题和解决方案

### 问题 1: 点击后没有任何反应

**可能原因:**
- JavaScript 错误导致代码中断
- 用户未登录
- Session 过期

**解决方法:**
1. 打开控制台查看是否有 JavaScript 错误
2. 尝试重新登录
3. 清除浏览器缓存并刷新

---

### 问题 2: 显示 "Processing..." 但一直不跳转

**可能原因:**
- API 调用超时
- CREEM API 响应缓慢
- 网络问题

**解决方法:**
1. 查看 Network 标签中 subscribe 请求的状态
2. 检查 Vercel Function Logs
3. 验证 CREEM API 状态（可能 CREEM 服务本身有问题）

---

### 问题 3: 显示错误消息

**如果显示:**
> "You already have an active premium subscription"

**解决**: 这是正常的，说明您已经有活跃订阅了

**如果显示:**
> "Failed to create checkout session"

**解决**: 
1. 检查 Vercel Function Logs 获取详细错误
2. 验证环境变量配置
3. 检查 CREEM API Key 有效性

---

### 问题 4: 跳转到错误的 URL

**如果跳转到:**
> `https://您的域名/pricing?message=subscription-pending`

这是**降级模式**（fallback），说明 CREEM API 调用失败了：

**解决步骤:**
1. 检查 CREEM_API_KEY 是否正确
2. 验证 CREEM API URL
3. 确认 Product IDs 正确
4. 查看 Vercel Logs 中的错误详情

---

## 🚀 快速测试命令

### 测试 API 端点（使用 cURL）:

在终端运行（需要先获取 access_token）:

```bash
# 替换 YOUR_ACCESS_TOKEN 为实际的 token
curl -X POST https://您的域名/api/subscribe \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{"planType":"premium","billingCycle":"yearly"}'
```

**预期响应:**
```json
{
  "success": true,
  "checkoutUrl": "https://checkout.creem.io/...",
  "sessionId": "cs_..."
}
```

---

## 📞 还是解决不了？

### 收集以下信息并告诉我：

1. **浏览器控制台的完整错误信息**
   - 截图或复制文本

2. **Vercel Function Logs 中的日志**
   - 最近的 `/api/subscribe` 请求日志

3. **Network 标签中的请求详情**
   - 请求头
   - 请求体
   - 响应内容

4. **环境变量配置截图**
   - 确认所有必需的变量都已配置

5. **CREEM Dashboard 中的 Product 配置**
   - Product IDs 列表

有了这些信息，我可以精确定位问题并提供解决方案！

---

## ✅ 测试成功的标志

当一切正常时，您会看到：

1. **浏览器控制台:**
```
✅ Session obtained, calling subscription API...
```

2. **页面行为:**
   - 按钮显示 "Processing..."
   - 页面跳转到 CREEM 支付页面
   - URL 类似: `https://checkout.creem.io/...`

3. **Vercel Logs:**
```
✅ CREEM checkout session created: cs_xxxxx
```

---

**加油！我相信您很快就能解决这个问题！** 💪

