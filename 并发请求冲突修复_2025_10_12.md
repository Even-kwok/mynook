# å¹¶å‘è¯·æ±‚å†²çªä¿®å¤ - 2025å¹´10æœˆ12æ—¥

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šäº†ä¸¥é‡çš„å¹¶å‘è¯·æ±‚å†²çªé—®é¢˜ï¼š

### é—®é¢˜ç°è±¡
1. **Interior Designç¬¬ä¸€æ¬¡ç”Ÿå›¾**ï¼š40ç§’æˆåŠŸ âœ…
2. **Interior Designç¬¬äºŒæ¬¡ç”Ÿå›¾**ï¼šæäº¤å2åˆ†é’Ÿæ²¡ååº” âŒ
3. **åˆ‡æ¢åˆ°Free Canvas**ï¼šç¬¬ä¸€ã€äºŒæ¬¡éƒ½æˆåŠŸ âœ…  
4. **Interior Designç»“æœå»¶è¿Ÿè¿”å›**ï¼šå‡ åˆ†é’Ÿåæ‰æ˜¾ç¤º â°
5. **Free Canvasç¬¬ä¸‰æ¬¡ç”Ÿå›¾**ï¼šåˆå¡ä½Nåˆ†é’Ÿ âŒ

### é—®é¢˜æ ¹æº

**å¤šä¸ªç”Ÿæˆè¯·æ±‚å¹¶å‘æ‰§è¡Œï¼Œå¯¼è‡´èµ„æºç«äº‰å’Œç›¸äº’é˜»å¡ï¼**

#### æŠ€æœ¯åˆ†æ
1. **æ— å…¨å±€å¹¶å‘æ§åˆ¶**ï¼šInterior Designå’ŒFree Canvaså„è‡ªç‹¬ç«‹è°ƒç”¨API
2. **è¯·æ±‚å¯èƒ½é‡å **ï¼š
   - ç”¨æˆ·æäº¤Interior Designç¬¬äºŒæ¬¡è¯·æ±‚
   - åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­åˆ‡æ¢åˆ°Free Canvas
   - Free Canvasè¯·æ±‚ä¹Ÿå¼€å§‹æ‰§è¡Œ
   - å¤šä¸ªè¯·æ±‚åŒæ—¶è®¿é—®Vertex AIï¼Œå¯¼è‡´èµ„æºç«äº‰
3. **Vertex AIé™æµ**ï¼šGoogle Cloudå¯èƒ½æœ‰å¹¶å‘é™åˆ¶ï¼Œå¯¼è‡´åç»­è¯·æ±‚è¢«é˜»å¡
4. **æ— é˜Ÿåˆ—ç®¡ç†**ï¼šæ²¡æœ‰æœºåˆ¶ç¡®ä¿è¯·æ±‚æŒ‰é¡ºåºæ‰§è¡Œ

## è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºå…¨å±€è¯·æ±‚é˜Ÿåˆ—ç®¡ç†å™¨

åˆ›å»º `utils/requestQueue.ts`ï¼š

```typescript
class RequestQueueManager {
  private queue: QueuedRequest[] = [];
  private isProcessing: boolean = false;
  private currentRequestId: string | null = null;

  // æ ¸å¿ƒåŠŸèƒ½ï¼š
  // 1. ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªè¯·æ±‚åœ¨å¤„ç†
  // 2. è‡ªåŠ¨ç®¡ç†é˜Ÿåˆ—ï¼ŒæŒ‰é¡ºåºå¤„ç†è¯·æ±‚
  // 3. é˜²æ­¢é‡å¤è¯·æ±‚
  // 4. æä¾›é˜Ÿåˆ—çŠ¶æ€æŸ¥è¯¢
}
```

### 2. å…³é”®åŠŸèƒ½

#### è¯·æ±‚æ’é˜Ÿ (enqueue)
```typescript
async enqueue<T>(requestId: string, requestFn: () => Promise<T>): Promise<T>
```
- æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤è¯·æ±‚ï¼Œé˜²æ­¢é‡å¤æäº¤
- å°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—
- å¦‚æœæ²¡æœ‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚ï¼Œç«‹å³å¼€å§‹å¤„ç†
- è¿”å›Promiseï¼Œç­‰å¾…è¯·æ±‚å®Œæˆ

#### é˜Ÿåˆ—å¤„ç† (processQueue)
```typescript
private async processQueue()
```
- ä¸²è¡Œå¤„ç†é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰è¯·æ±‚
- ä¸€ä¸ªè¯·æ±‚å®Œæˆåæ‰å¼€å§‹ä¸‹ä¸€ä¸ª
- è®°å½•è¯¦ç»†çš„å¤„ç†æ—¥å¿—

#### è¯·æ±‚å–æ¶ˆ (cancel)
```typescript
cancel(requestId: string)
```
- å¦‚æœè¯·æ±‚è¿˜åœ¨é˜Ÿåˆ—ä¸­ï¼Œå¯ä»¥å–æ¶ˆ
- æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ— æ³•å–æ¶ˆï¼ˆå·²å‘é€åˆ°æœåŠ¡å™¨ï¼‰

#### çŠ¶æ€æŸ¥è¯¢ (getStatus)
```typescript
getStatus() {
  return {
    isProcessing: boolean,
    currentRequestId: string | null,
    queueLength: number,
    queuedRequests: string[]
  }
}
```

### 3. é›†æˆåˆ°å›¾ç‰‡ç”ŸæˆæœåŠ¡

ä¿®æ”¹ `services/geminiService.ts`ï¼š

```typescript
export const generateImage = async (
    instruction: string, 
    base64Images: string[],
    onProgress?: (message: string) => void
): Promise<string> => {
    // ç”Ÿæˆå”¯ä¸€è¯·æ±‚ID
    const requestId = `img_gen_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // å°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—
    return requestQueue.enqueue(requestId, async () => {
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ’é˜Ÿç­‰å¾…
        const queueStatus = requestQueue.getStatus();
        if (queueStatus.queueLength > 0) {
            onProgress(`Waiting in queue... (${queueStatus.queueLength} request(s) ahead)`);
        }
        
        // æ‰§è¡Œå®é™…çš„APIè°ƒç”¨...
    });
};
```

## å·¥ä½œæµç¨‹

### ä¿®å¤å‰ï¼ˆé—®é¢˜ï¼‰

```
æ—¶é—´è½´ï¼š
0s   - ç”¨æˆ·æäº¤Interior Designè¯·æ±‚1 â†’ å¼€å§‹å¤„ç†
40s  - è¯·æ±‚1å®Œæˆ âœ…

45s  - ç”¨æˆ·æäº¤Interior Designè¯·æ±‚2 â†’ å¼€å§‹å¤„ç†
50s  - ç”¨æˆ·åˆ‡æ¢åˆ°Free Canvasï¼Œæäº¤è¯·æ±‚3 â†’ åŒæ—¶å¼€å§‹å¤„ç† âŒ
      ã€é—®é¢˜ï¼šè¯·æ±‚2å’Œè¯·æ±‚3å¹¶å‘ï¼Œèµ„æºç«äº‰ã€‘
      
180s - è¯·æ±‚2è¶…æ—¶æˆ–å¤±è´¥ âŒ
185s - è¯·æ±‚3æ‰å¼€å§‹çœŸæ­£å¤„ç†
250s - è¯·æ±‚3å®Œæˆï¼Œä½†ç”¨æˆ·å·²ç­‰å¾…å¤ªä¹… â°
```

### ä¿®å¤åï¼ˆè§£å†³ï¼‰

```
æ—¶é—´è½´ï¼š
0s   - ç”¨æˆ·æäº¤Interior Designè¯·æ±‚1
      [RequestQueue] è¯·æ±‚1æ’é˜Ÿ â†’ ç«‹å³å¼€å§‹å¤„ç†

40s  - è¯·æ±‚1å®Œæˆ âœ…

45s  - ç”¨æˆ·æäº¤Interior Designè¯·æ±‚2
      [RequestQueue] è¯·æ±‚2æ’é˜Ÿ â†’ ç«‹å³å¼€å§‹å¤„ç†

50s  - ç”¨æˆ·åˆ‡æ¢åˆ°Free Canvasï¼Œæäº¤è¯·æ±‚3
      [RequestQueue] è¯·æ±‚3æ’é˜Ÿ
      [UIæç¤º] "Waiting in queue... (1 request ahead)" ğŸ’¡

90s  - è¯·æ±‚2å®Œæˆ âœ…
      [RequestQueue] è‡ªåŠ¨å¼€å§‹å¤„ç†è¯·æ±‚3

130s - è¯·æ±‚3å®Œæˆ âœ…
      [ç”¨æˆ·ä½“éªŒ] æ˜ç¡®çŸ¥é“åœ¨æ’é˜Ÿï¼Œå¿ƒç†é¢„æœŸåˆç†
```

## ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| å¹¶å‘æ§åˆ¶ | âŒ æ—  | âœ… ä¸¥æ ¼ä¸²è¡Œ |
| è¯·æ±‚å†²çª | âŒ ç»å¸¸å‘ç”Ÿ | âœ… å®Œå…¨é¿å… |
| ç”¨æˆ·åé¦ˆ | âŒ æ— æç¤ºï¼Œä»¥ä¸ºå¡æ­» | âœ… æ˜¾ç¤ºæ’é˜ŸçŠ¶æ€ |
| é‡å¤æäº¤ | âŒ å¯èƒ½é‡å¤ | âœ… è‡ªåŠ¨æ‹’ç» |
| æ—¥å¿—è¿½è¸ª | âŒ éš¾ä»¥å®šä½ | âœ… å®Œæ•´è¿½è¸ª |
| è¶…æ—¶æ—¶é—´ | âŒ å¯èƒ½ç´¯ç§¯è¶…é•¿ | âœ… æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ |

## æ§åˆ¶å°æ—¥å¿—ç¤ºä¾‹

### æ­£å¸¸å•ä¸ªè¯·æ±‚
```
[ImageGen] Creating request: img_gen_1728745200000_abc123
[RequestQueue] Request queued: img_gen_1728745200000_abc123, Queue length: 1
[RequestQueue] Processing request: img_gen_1728745200000_abc123, Remaining: 0
[API Call] Attempt 1/1, Timeout: 100000ms
ğŸ“¡ Starting Vertex AI API call...
âœ… Vertex AI responded in 45.0s
[ImageGen] Request img_gen_1728745200000_abc123 completed successfully
[RequestQueue] Request completed: img_gen_1728745200000_abc123 in 45200ms
[RequestQueue] Queue empty, all requests processed
```

### å¤šä¸ªè¯·æ±‚æ’é˜Ÿ
```
[ImageGen] Creating request: img_gen_1728745200000_req1
[RequestQueue] Request queued: img_gen_1728745200000_req1, Queue length: 1
[RequestQueue] Processing request: img_gen_1728745200000_req1, Remaining: 0

ã€ç”¨æˆ·åœ¨ç­‰å¾…æ—¶æäº¤ç¬¬äºŒä¸ªè¯·æ±‚ã€‘
[ImageGen] Creating request: img_gen_1728745210000_req2
[RequestQueue] Request queued: img_gen_1728745210000_req2, Queue length: 1
[ImageGen] Waiting in queue... (1 request(s) ahead)

ã€ç¬¬ä¸€ä¸ªè¯·æ±‚å®Œæˆã€‘
âœ… Vertex AI responded in 42.0s
[RequestQueue] Request completed: img_gen_1728745200000_req1 in 42300ms
[RequestQueue] Processing request: img_gen_1728745210000_req2, Remaining: 0

ã€ç¬¬äºŒä¸ªè¯·æ±‚å¼€å§‹å¤„ç†ã€‘
[API Call] Attempt 1/1, Timeout: 100000ms
ğŸ“¡ Starting Vertex AI API call...
âœ… Vertex AI responded in 38.0s
[RequestQueue] Request completed: img_gen_1728745210000_req2 in 38500ms
[RequestQueue] Queue empty, all requests processed
```

### æ‹’ç»é‡å¤è¯·æ±‚
```
[ImageGen] Creating request: img_gen_1728745200000_abc123
[RequestQueue] Request queued: img_gen_1728745200000_abc123, Queue length: 1
[RequestQueue] Processing request: img_gen_1728745200000_abc123, Remaining: 0

ã€ç”¨æˆ·ä¸è€çƒ¦ï¼Œå†æ¬¡ç‚¹å‡»ç”ŸæˆæŒ‰é’®ã€‘
[ImageGen] Creating request: img_gen_1728745200000_abc123
[RequestQueue] Duplicate request detected: img_gen_1728745200000_abc123, rejecting...
âŒ Error: A generation request is already in progress. Please wait for it to complete.
```

## ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ç•Œé¢æç¤º

å½“è¯·æ±‚æ’é˜Ÿæ—¶ï¼Œç”¨æˆ·ä¼šçœ‹åˆ°ï¼š
```
Step 3: Sending to AI...
â³ Waiting in queue... (1 request ahead)
Usually takes 20-60 seconds
```

### é¢„æœŸç®¡ç†

- **é€æ˜åº¦**ï¼šç”¨æˆ·çŸ¥é“è¯·æ±‚åœ¨æ’é˜Ÿï¼Œä¸ä¼šä»¥ä¸ºç³»ç»Ÿå¡æ­»
- **é¢„æœŸåˆç†**ï¼šæ˜¾ç¤ºå‰é¢æœ‰å¤šå°‘è¯·æ±‚ï¼Œå¯ä»¥ä¼°ç®—ç­‰å¾…æ—¶é—´
- **é˜²æ­¢è¯¯æ“ä½œ**ï¼šé‡å¤ç‚¹å‡»ä¼šè¢«é˜»æ­¢å¹¶æç¤º

## éƒ¨ç½²æ­¥éª¤

1. **æäº¤ä»£ç **
```bash
git add .
git commit -m "æ·»åŠ å…¨å±€è¯·æ±‚é˜Ÿåˆ—ç®¡ç†å™¨ï¼Œè§£å†³å¹¶å‘è¯·æ±‚å†²çª"
git push
```

2. **Vercelè‡ªåŠ¨éƒ¨ç½²**
   - ç­‰å¾…æ„å»ºå®Œæˆ
   - æ–°çš„é˜Ÿåˆ—ç®¡ç†å™¨ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ

3. **æµ‹è¯•éªŒè¯**
   - å¿«é€Ÿè¿ç»­æäº¤å¤šä¸ªç”Ÿæˆè¯·æ±‚
   - è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤è¯·æ±‚æŒ‰é¡ºåºå¤„ç†
   - éªŒè¯UIæ˜¾ç¤ºæ’é˜Ÿæç¤º

## ç›‘æ§æŒ‡æ ‡

éƒ¨ç½²ååœ¨æ§åˆ¶å°è§‚å¯Ÿï¼š

### æˆåŠŸåœºæ™¯
- çœ‹åˆ° `[RequestQueue] Processing request`
- çœ‹åˆ° `[RequestQueue] Request completed`
- çœ‹åˆ° `[RequestQueue] Queue empty, all requests processed`

### æ’é˜Ÿåœºæ™¯
- çœ‹åˆ° `Waiting in queue... (N request(s) ahead)`
- ç¡®è®¤ç¬¬äºŒä¸ªè¯·æ±‚åœ¨ç¬¬ä¸€ä¸ªå®Œæˆåæ‰å¼€å§‹

### é‡å¤è¯·æ±‚è¢«é˜»æ­¢
- çœ‹åˆ° `Duplicate request detected`
- ç”¨æˆ·å¾—åˆ°æ˜ç¡®çš„é”™è¯¯æç¤º

## æ³¨æ„äº‹é¡¹

### 1. é˜Ÿåˆ—æŒä¹…åŒ–
å½“å‰é˜Ÿåˆ—åœ¨å†…å­˜ä¸­ï¼Œåˆ·æ–°é¡µé¢ä¼šæ¸…ç©ºé˜Ÿåˆ—ã€‚å¦‚éœ€æŒä¹…åŒ–ï¼š
- å¯ä»¥å­˜å‚¨åˆ° localStorage
- æˆ–åœ¨ç”¨æˆ·ç¦»å¼€é¡µé¢æ—¶æç¤º"æœ‰è¯·æ±‚æ­£åœ¨å¤„ç†"

### 2. è·¨é¡µé¢çŠ¶æ€
å¦‚æœç”¨æˆ·åœ¨ä¸åŒé¡µé¢ï¼ˆInterior Design vs Free Canvasï¼‰é—´åˆ‡æ¢ï¼š
- é˜Ÿåˆ—æ˜¯å…¨å±€çš„ï¼Œä¸¤ä¸ªé¡µé¢å…±äº«
- ç¡®ä¿æ— è®ºåœ¨å“ªä¸ªé¡µé¢ï¼Œè¯·æ±‚éƒ½æŒ‰é¡ºåºå¤„ç†

### 3. è¶…æ—¶å¤„ç†
å•ä¸ªè¯·æ±‚çš„100ç§’è¶…æ—¶ç‹¬ç«‹è®¡ç®—ï¼Œä¸å—é˜Ÿåˆ—å½±å“ï¼š
- è¯·æ±‚1ï¼š40ç§’å®Œæˆ
- è¯·æ±‚2æ’é˜Ÿç­‰å¾…ï¼š0ç§’ï¼ˆå› ä¸ºè¯·æ±‚1å·²å®Œæˆï¼‰
- è¯·æ±‚2å¤„ç†ï¼šæœ€å¤š100ç§’

### 4. å¹¶å‘ä¼˜åŒ–ï¼ˆæœªæ¥ï¼‰
å¦‚æœéœ€è¦æ”¯æŒå¤šä¸ªå¹¶å‘è¯·æ±‚ï¼š
- å¯ä»¥è®¾ç½® `maxConcurrent = 2`
- å…è®¸2ä¸ªè¯·æ±‚åŒæ—¶å¤„ç†
- ä½†è¦ç¡®ä¿ä¸è¶…è¿‡APIé…é¢é™åˆ¶

## åç»­æ”¹è¿›æ–¹å‘

### 1. é˜Ÿåˆ—ä¼˜å…ˆçº§
```typescript
enqueue(requestId, requestFn, priority: 'high' | 'normal' | 'low')
```
- ä»˜è´¹ç”¨æˆ·è¯·æ±‚ä¼˜å…ˆçº§æ›´é«˜
- Freeç”¨æˆ·è¯·æ±‚åœ¨é˜Ÿå°¾

### 2. é¢„ä¼°ç­‰å¾…æ—¶é—´
```typescript
getEstimatedWaitTime(): number // è¿”å›é¢„ä¼°ç§’æ•°
```
- åŸºäºå†å²æ•°æ®é¢„ä¼°æ¯ä¸ªè¯·æ±‚å¹³å‡æ—¶é•¿
- è®¡ç®—é˜Ÿåˆ—ä¸­æ‰€æœ‰è¯·æ±‚çš„æ€»ç­‰å¾…æ—¶é—´

### 3. è¯·æ±‚æ‰¹å¤„ç†
```typescript
enqueueBatch(requests: Array<{id, fn}>): Promise<Array<result>>
```
- æ”¯æŒä¸€æ¬¡æäº¤å¤šä¸ªæ¨¡æ¿ç”Ÿæˆ
- å†…éƒ¨ä¸²è¡Œå¤„ç†ï¼Œä½†å¯¹å¤–è¡¨ç°ä¸ºæ‰¹é‡

### 4. å®æ—¶é˜Ÿåˆ—çŠ¶æ€æ˜¾ç¤º
- åœ¨UIä¸Šæ˜¾ç¤ºå½“å‰é˜Ÿåˆ—çŠ¶æ€
- å®æ—¶æ›´æ–°ï¼š"æ‚¨çš„è¯·æ±‚æ’åœ¨ç¬¬3ä½..."

## ç›¸å…³æ–‡ä»¶

- âœ… `utils/requestQueue.ts` - æ–°å»ºï¼šè¯·æ±‚é˜Ÿåˆ—ç®¡ç†å™¨
- âœ… `services/geminiService.ts` - ä¿®æ”¹ï¼šé›†æˆé˜Ÿåˆ—ç®¡ç†

## çŠ¶æ€

âœ… **å·²å®Œæˆ** - 2025å¹´10æœˆ12æ—¥

å…¨å±€è¯·æ±‚é˜Ÿåˆ—ç®¡ç†å™¨å·²å®ç°å¹¶é›†æˆï¼Œç¡®ä¿æ‰€æœ‰å›¾ç‰‡ç”Ÿæˆè¯·æ±‚ä¸²è¡Œå¤„ç†ï¼Œå®Œå…¨è§£å†³å¹¶å‘å†²çªé—®é¢˜ã€‚

## æŠ€æœ¯äº®ç‚¹

1. **å•ä¾‹æ¨¡å¼**ï¼šå…¨å±€å”¯ä¸€çš„é˜Ÿåˆ—ç®¡ç†å™¨å®ä¾‹
2. **Promiseé˜Ÿåˆ—**ï¼šä¼˜é›…çš„å¼‚æ­¥è¯·æ±‚ç®¡ç†
3. **é˜²é‡å¤**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œæ‹’ç»é‡å¤è¯·æ±‚
4. **è¯¦ç»†æ—¥å¿—**ï¼šå®Œæ•´çš„è¯·æ±‚ç”Ÿå‘½å‘¨æœŸè¿½è¸ª
5. **ç”¨æˆ·å‹å¥½**ï¼šæ¸…æ™°çš„æ’é˜ŸçŠ¶æ€æç¤º

è¿™ä¸ªè§£å†³æ–¹æ¡ˆä»æ ¹æœ¬ä¸Šè§£å†³äº†å¹¶å‘è¯·æ±‚å†²çªé—®é¢˜ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚

