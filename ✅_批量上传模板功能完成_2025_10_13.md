# ✅ 批量上传模板功能完成

**日期**: 2025年10月13日  
**功能**: 后台批量上传模板（从图片元数据提取提示词）  
**状态**: ✅ 开发完成，等待测试

---

## 🎯 功能概述

在 Admin Panel 后台添加了批量上传模板功能，支持：

- ✅ **拖放或点击上传多张图片**
- ✅ **自动从文件名识别分类和房间类型**
- ✅ **从图片元数据提取提示词**（不自动生成）
- ✅ **实时预览识别结果**
- ✅ **只上传包含提示词的图片**
- ✅ **批量创建模板到数据库**

---

## 📁 文件变更

### 新增文件

1. **`components/BatchTemplateUpload.tsx`** (498 行)
   - 批量上传界面组件
   - 智能文件名解析
   - PNG 元数据提取
   - 拖放上传支持
   - 进度显示和错误处理

### 修改文件

1. **`components/AdminPage.tsx`**
   - 添加 `IconUpload` 导入
   - 添加 `BatchTemplateUpload` 组件导入
   - 添加 `isBatchUploadOpen` 状态
   - 添加 "Batch Upload" 按钮
   - 集成批量上传组件

2. **`components/Icons.tsx`**
   - 更新 `IconUpload` 支持 `className` 参数
   - 新增 `IconAlertCircle` 图标

---

## 🎨 界面设计

### 入口位置

**Admin Panel → Template Management → "Batch Upload" 按钮**

```
┌─────────────────────────────────────────┐
│ Template Management                      │
│ ┌──────────┬──────────────┬────────────┐│
│ │Add       │ Batch Upload │ Import     ││
│ │Category  │              │ Default    ││
│ └──────────┴──────────────┴────────────┘│
└─────────────────────────────────────────┘
```

### 上传界面

```
┌──────────────────────────────────────────────┐
│  批量上传模板                           ✕    │
│  拖放图片或点击选择，系统会从元数据提取提示词│
├──────────────────────────────────────────────┤
│                                              │
│   📤                                         │
│   拖放图片到这里                             │
│   或者点击下方按钮选择文件                   │
│                                              │
│   [ 选择图片 ]                               │
│                                              │
│   文件名示例: "Modern Minimalist Living      │
│   Room.png"                                  │
│   ⚠️ 图片必须包含提示词元数据                │
│                                              │
├──────────────────────────────────────────────┤
│  可上传: 0   成功: 0   失败: 0   [ 取消 ]   │
└──────────────────────────────────────────────┘
```

### 预览界面

```
┌──────────────────────────────────────────────┐
│  已选择 3 个文件 (可上传: 2)    [ 添加更多 ] │
├──────────────────────────────────────────────┤
│ ┌────┬──────────────────────────────┬──┐   │
│ │[图]│Modern Minimalist Living Room │✅│   │
│ │    │📁 Interior Design > Modern   │  │   │
│ │    │🏠 Living Room                │  │   │
│ │    │✅ 已提取提示词 (256 字符)    │  │   │
│ └────┴──────────────────────────────┴──┘   │
│                                              │
│ ┌────┬──────────────────────────────┬──┐   │
│ │[图]│Contemporary Kitchen          │✅│   │
│ │    │📁 Interior Design > Contemp. │  │   │
│ │    │🏠 Kitchen                    │  │   │
│ │    │✅ 已提取提示词 (312 字符)    │  │   │
│ └────┴──────────────────────────────┴──┘   │
│                                              │
│ ┌────┬──────────────────────────────┬──┐   │
│ │[图]│Garden Landscape              │❌│   │
│ │    │📁 Exterior Design > Garden   │  │   │
│ │    │❌ 未找到提示词元数据          │  │   │
│ └────┴──────────────────────────────┴──┘   │
├──────────────────────────────────────────────┤
│  ✅ 可上传: 2  ❌ 失败: 1   [取消][上传 2个]│
└──────────────────────────────────────────────┘
```

---

## 🔍 智能识别逻辑

### 1. 文件名解析

系统会从文件名自动识别：

#### Interior Design（室内设计）

检测房间类型关键词：

```
living-room, bedroom, kitchen, bathroom
dining-room, home-office, master-bedroom
guest-bedroom, kids-room, teen-room
laundry-room, walk-in-closet, pantry
home-theater, game-room, home-gym
yoga, meditation, craft, hobby
hallway, corridor, staircase, balcony
sunroom, conservatory, garage
```

**示例**：
- `Modern Minimalist Living Room.png`
  - 名称: Modern Minimalist Living Room
  - 主分类: Interior Design
  - 子分类: Modern Minimalist
  - 房间: Living Room

#### Exterior Design（外观设计）

检测关键词：`exterior, facade, house, villa, bungalow`

**示例**：
- `Mediterranean Villa Exterior.png`
  - 名称: Mediterranean Villa Exterior
  - 主分类: Exterior Design
  - 子分类: Architectural Styles

#### Garden（花园）

检测关键词：`garden, landscape, backyard, outdoor`

**示例**：
- `Zen Garden.png`
  - 名称: Zen Garden
  - 主分类: Exterior Design
  - 子分类: Garden

#### 其他分类

- **Wall Paint**: `wall paint, paint color`
- **Floor Style**: `floor, flooring`

### 2. 提示词提取

#### 支持的格式

系统会从 PNG 元数据的以下字段提取提示词：

```javascript
// 查找这些关键字
'prompt'
'Prompt'
'PROMPT'
'parameters'
'Parameters'
'description'
'Description'
```

#### 提取过程

1. **读取 PNG 文件** → 检查文件签名
2. **解析 PNG chunks** → 查找 `tEXt` 或 `iTXt` chunks
3. **搜索关键字** → 在文本块中查找提示词字段
4. **提取内容** → 获取关键字后的文本
5. **清理格式** → 移除分隔符和空白

#### 标记状态

- ✅ **有提示词** → `status: 'pending'` → 可以上传
- ❌ **无提示词** → `status: 'error'` → 不会上传

---

## 📝 文件命名规范

### 推荐格式

```
{风格名称} {房间类型}.png

示例：
- Modern Minimalist Living Room.png
- Contemporary Farmhouse Kitchen.png
- Scandinavian Master Bedroom.png
- Mediterranean Villa Exterior.png
- Zen Garden.png
```

### 注意事项

- ✅ 文件名会作为模板名称（去掉扩展名）
- ✅ 系统会自动识别分类和房间类型
- ⚠️ 必须在图片元数据中包含提示词
- ⚠️ 如果识别错误，可以在预览界面看到

---

## 🚀 使用流程

### 步骤 1：准备图片

1. 确保图片包含提示词元数据
2. 使用规范的文件名格式
3. 支持 PNG、JPG、JPEG 格式

### 步骤 2：进入后台

1. 登录 MyNook
2. 进入 **Admin Panel**
3. 点击 **Template Management** 标签
4. 点击 **"Batch Upload"** 按钮

### 步骤 3：上传图片

**方法 A：拖放上传**
- 将图片文件拖放到上传区域

**方法 B：点击选择**
- 点击 "选择图片" 按钮
- 在文件选择器中选择多张图片

### 步骤 4：预览检查

系统会显示：
- ✅ 识别的分类和房间类型
- ✅ 提示词状态（已提取 / 未找到）
- ✅ 文件缩略图预览

### 步骤 5：上传确认

- 检查识别结果是否正确
- 移除不需要的图片
- 点击 **"上传 N 个模板"** 按钮

### 步骤 6：等待完成

- 查看实时进度
- 等待所有图片上传完成
- 系统会自动刷新模板列表

---

## 💾 数据库操作

### 上传流程

```
1. 读取图片文件
   ↓
2. 提取元数据（提示词）
   ↓
3. 上传到 Supabase Storage
   路径: {category}/{room-type}/{name}-{timestamp}.png
   ↓
4. 获取公开 URL
   ↓
5. 创建模板记录
   INSERT INTO design_templates (...)
   ↓
6. 更新前端状态
```

### Storage 路径规则

**Interior Design**:
```
interior-design/
  ├── living-room/
  │   ├── modern-minimalist-living-room-1760360000000.png
  │   └── scandinavian-living-room-1760360001000.png
  ├── kitchen/
  │   └── farmhouse-kitchen-1760360002000.png
  └── bedroom/
      └── contemporary-bedroom-1760360003000.png
```

**Exterior Design**:
```
exterior-design/
  ├── architectural-styles/
  │   ├── mediterranean-villa-exterior-1760360004000.png
  │   └── modern-house-1760360005000.png
  └── garden/
      └── zen-garden-1760360006000.png
```

### 模板记录字段

```sql
INSERT INTO design_templates (
  name,              -- 文件名（无扩展名）
  image_url,         -- Supabase Storage URL
  prompt,            -- 从元数据提取的提示词
  main_category,     -- 主分类（自动识别）
  sub_category,      -- 子分类（自动识别）
  room_type,         -- 房间类型ID（Interior Design）
  enabled,           -- true
  sort_order         -- 0
)
```

---

## 🎨 技术实现

### PNG 元数据读取

```typescript
const extractPromptFromImage = async (file: File): Promise<string | null> => {
  // 1. 读取文件为 ArrayBuffer
  const arrayBuffer = await file.arrayBuffer();
  const bytes = new Uint8Array(arrayBuffer);
  
  // 2. 检查 PNG 签名
  if (bytes[0] === 0x89 && bytes[1] === 0x50 && 
      bytes[2] === 0x4E && bytes[3] === 0x47) {
    
    // 3. 遍历 PNG chunks
    let i = 8; // 跳过 PNG 签名
    while (i < bytes.length - 12) {
      const length = readInt32(bytes, i);
      const type = readChunkType(bytes, i + 4);
      
      // 4. 查找 tEXt 或 iTXt chunks
      if (type === 'tEXt' || type === 'iTXt') {
        const chunkData = bytes.slice(i + 8, i + 8 + length);
        const text = new TextDecoder().decode(chunkData);
        
        // 5. 搜索提示词关键字
        if (text.includes('prompt') || text.includes('parameters')) {
          return extractPromptText(text);
        }
      }
      
      i += 12 + length;
    }
  }
  
  return null;
}
```

### 文件名智能解析

```typescript
const parseFileName = (fileName: string) => {
  const name = fileName.replace(/\.(png|jpg|jpeg)$/i, '');
  
  // 检查房间类型（优先级排序）
  for (const room of ROOM_TYPE_PATTERNS) {
    if (room.pattern.test(name)) {
      return {
        name: name,
        mainCategory: 'Interior Design',
        subCategory: name.replace(room.pattern, '').trim(),
        roomType: room.displayName,
        roomTypeId: room.roomTypeId,
      };
    }
  }
  
  // 检查其他分类
  for (const cat of CATEGORY_PATTERNS) {
    if (cat.pattern.test(name)) {
      return {
        name: name,
        mainCategory: cat.mainCategory,
        subCategory: cat.subCategory,
      };
    }
  }
  
  // 默认为 Interior Design - Living Room
  return {
    name: name,
    mainCategory: 'Interior Design',
    subCategory: name,
    roomType: 'Living Room',
    roomTypeId: 'living-room',
  };
}
```

---

## ⚠️ 注意事项

### 图片要求

1. **格式**: PNG、JPG、JPEG
2. **元数据**: 必须包含提示词
3. **文件名**: 建议使用规范格式
4. **大小**: 无限制（但建议 < 5MB）

### 提示词来源

- ✅ **AI 生成的图片** → 通常自动包含提示词元数据
  - Stable Diffusion
  - Midjourney (导出时选择保存元数据)
  - DALL-E (部分支持)
  
- ❌ **普通图片** → 需要手动添加元数据
  - 可以使用 ExifTool 等工具添加

### 常见问题

**Q: 图片显示"未找到提示词元数据"？**
- A: 检查图片是否包含元数据，使用 metadata 查看工具验证

**Q: 分类识别错误？**
- A: 检查文件名是否符合规范，或者包含特定关键词

**Q: 上传失败？**
- A: 检查网络连接、Supabase Storage 配置、文件大小

**Q: 可以编辑提示词吗？**
- A: 批量上传不支持编辑，只能使用元数据中的提示词

---

## 🔧 开发信息

### 组件结构

```
BatchTemplateUpload/
├── State Management
│   ├── templates[]          // 所有选择的图片
│   ├── isDragging           // 拖放状态
│   └── isUploading          // 上传进度
│
├── File Processing
│   ├── handleFiles()        // 处理文件选择
│   ├── extractPromptFromImage()  // 提取提示词
│   └── parseFileName()      // 解析文件名
│
├── Upload Logic
│   ├── handleUpload()       // 批量上传
│   ├── supabase.storage.upload()  // 上传文件
│   └── batchImportTemplates()     // 创建记录
│
└── UI Components
    ├── Drop Zone            // 拖放区域
    ├── File List            // 文件预览列表
    └── Progress Bar         // 进度显示
```

### 依赖项

- `@supabase/supabase-js` - Supabase 客户端
- `framer-motion` - 动画效果
- `react` - UI 框架

### 关键函数

1. **`extractPromptFromImage`** - PNG 元数据读取
2. **`parseFileName`** - 智能文件名解析
3. **`handleFiles`** - 文件处理和预览
4. **`handleUpload`** - 批量上传逻辑

---

## 📊 统计数据

### 代码量

- **BatchTemplateUpload.tsx**: 498 行
- **AdminPage.tsx** (修改): +15 行
- **Icons.tsx** (修改): +1 行
- **总计**: ~514 行新代码

### 功能覆盖

- ✅ 支持 32+ 房间类型识别
- ✅ 支持 4 个主分类
- ✅ 支持 PNG 元数据读取
- ✅ 支持拖放上传
- ✅ 支持批量处理

---

## 🎯 测试清单

### 功能测试

- [ ] 打开批量上传界面
- [ ] 拖放图片文件
- [ ] 点击选择图片文件
- [ ] 验证文件名识别正确
- [ ] 验证提示词提取成功
- [ ] 验证提示词缺失检测
- [ ] 移除单个文件
- [ ] 批量上传（成功）
- [ ] 批量上传（部分失败）
- [ ] 查看上传进度
- [ ] 验证模板创建成功
- [ ] 验证图片 URL 可访问
- [ ] 关闭上传界面

### 边缘情况

- [ ] 上传非图片文件
- [ ] 上传超大文件（> 10MB）
- [ ] 上传相同文件名
- [ ] 网络断开时上传
- [ ] 快速重复上传
- [ ] Storage 容量满

### 浏览器兼容性

- [ ] Chrome
- [ ] Firefox
- [ ] Safari
- [ ] Edge

---

## 🚀 下一步

### 可能的增强

1. **编辑功能**
   - 在预览界面编辑提示词
   - 修改分类和房间类型

2. **批量编辑**
   - 批量设置分类
   - 批量修改提示词

3. **模板预览**
   - 使用 AI 生成预览图
   - 验证提示词质量

4. **历史记录**
   - 查看上传历史
   - 重新上传失败的项目

5. **CSV 导入**
   - 支持 CSV 批量导入
   - 映射文件名到模板

---

## 📝 更新日志

### 2025-10-13

- ✅ 创建 `BatchTemplateUpload.tsx` 组件
- ✅ 添加 PNG 元数据提取功能
- ✅ 实现智能文件名解析
- ✅ 集成到 Admin Panel
- ✅ 添加 `IconUpload` 和 `IconAlertCircle` 图标
- ✅ 编写完整文档

---

## 🎓 使用提示

### 最佳实践

1. **图片准备**
   - 使用 AI 工具生成图片（自动包含元数据）
   - 导出时选择保存元数据选项
   - 使用规范的文件命名

2. **批量操作**
   - 一次上传 10-20 张图片
   - 避免一次上传过多（> 50）
   - 分批上传不同分类

3. **错误处理**
   - 先在测试模式验证
   - 检查预览结果再上传
   - 保存失败的文件重试

### 工作流程建议

```
1. 使用 AI 工具生成图片 (Stable Diffusion等)
   ↓
2. 下载图片（保留元数据）
   ↓
3. 重命名文件（规范格式）
   ↓
4. 进入 Admin Panel
   ↓
5. 批量上传
   ↓
6. 验证结果
   ↓
7. 在前端测试新模板
```

---

## 🔗 相关文档

- [📋 项目进度总结](./📋_项目进度总结_2025_10_13.md)
- [📋 模板系统完整总结](./📋_模板系统完整总结_2025_10_12.md)
- [🚀 测试上传指南](./🚀_测试上传指南.md)

---

**创建时间**: 2025年10月13日  
**开发者**: AI Assistant + User  
**状态**: 🎉 Ready for Testing!

---

## 💡 提示

现在您可以：
1. 进入 Admin Panel
2. 点击 Template Management
3. 点击 "Batch Upload" 按钮
4. 上传您的图片文件
5. 查看自动识别的结果
6. 一键批量创建模板

**注意**: 图片必须包含提示词元数据才能成功上传！

