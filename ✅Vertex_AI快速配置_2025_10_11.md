# ✅ Vertex AI 快速配置 - gemini-2.5-flash-image

**日期**: 2025年10月11日  
**状态**: ✅ 代码已更新，等待配置

## 为什么需要 Vertex AI？

`gemini-2.5-flash-image` 模型**只支持 Vertex AI 认证**，不支持普通的 API Key。这是 Google 最新的图像生成模型，支持：

- ✅ 基于参考图像的编辑
- ✅ 高质量图像生成
- ✅ 更好的风格迁移

## 快速配置步骤（5步）

### 第 1 步：创建 Google Cloud 项目

1. 访问 https://console.cloud.google.com/
2. 点击右上角 "Select a project" → "NEW PROJECT"
3. 输入项目名称（如 `mynook-ai`）
4. 记下 **项目 ID**（如 `mynook-ai-123456`）

### 第 2 步：启用必要的 API

在 Google Cloud Console 中：

1. 搜索框输入 "Vertex AI API" → 点击 "ENABLE"
2. 搜索 "Generative Language API" → 点击 "ENABLE"

⏱️ 这一步需要 1-2 分钟

### 第 3 步：创建服务账号

1. 进入 **IAM & Admin** → **Service Accounts**
2. 点击 "**+ CREATE SERVICE ACCOUNT**"
3. 填写：
   - Name: `mynook-vertex-ai`
   - 点击 "CREATE AND CONTINUE"
4. 选择角色：
   - 搜索并选择 "**Vertex AI User**"
   - 点击 "CONTINUE" → "DONE"

### 第 4 步：下载服务账号密钥

1. 在服务账号列表中，点击刚创建的账号
2. 切换到 "**KEYS**" 标签
3. 点击 "**ADD KEY**" → "**Create new key**"
4. 选择格式：**JSON**
5. 点击 "**CREATE**"

⚠️ **重要**：会自动下载一个 JSON 文件，类似：
```
mynook-ai-123456-a1b2c3d4e5f6.json
```

### 第 5 步：在 Vercel 中配置环境变量

#### 方式一：在 Vercel Dashboard 配置（推荐）

1. 打开 https://vercel.com/dashboard
2. 选择 `mynook` 项目
3. 进入 **Settings** → **Environment Variables**
4. 添加以下变量：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `GOOGLE_GENAI_USE_VERTEXAI` | `true` | 启用 Vertex AI |
| `GOOGLE_CLOUD_PROJECT` | `mynook-ai-123456` | 你的项目 ID |
| `GOOGLE_CLOUD_LOCATION` | `us-central1` | 区域（推荐） |
| `GOOGLE_APPLICATION_CREDENTIALS_JSON` | `{完整JSON内容}` | 服务账号密钥 |

##### 如何填写 GOOGLE_APPLICATION_CREDENTIALS_JSON：

1. 用文本编辑器打开下载的 JSON 文件
2. 复制**完整内容**（包括所有大括号）
3. 粘贴到 Value 栏

**示例格式**（不要使用这个，用你自己的！）：
```json
{"type":"service_account","project_id":"mynook-ai-123456","private_key_id":"abc123...","private_key":"-----BEGIN PRIVATE KEY-----\nMIIE...真实密钥很长...\n-----END PRIVATE KEY-----\n","client_email":"mynook-vertex-ai@mynook-ai-123456.iam.gserviceaccount.com","client_id":"123456789","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs"}
```

#### 方式二：使用 Vercel CLI

```bash
vercel env add GOOGLE_GENAI_USE_VERTEXAI
# 输入: true

vercel env add GOOGLE_CLOUD_PROJECT
# 输入: mynook-ai-123456

vercel env add GOOGLE_CLOUD_LOCATION
# 输入: us-central1

vercel env add GOOGLE_APPLICATION_CREDENTIALS_JSON
# 输入: {粘贴完整JSON内容}
```

### 第 6 步：启用计费（重要！）

⚠️ Vertex AI 是付费服务，但：

- 🎁 **新用户有 $300 免费额度**（90天有效）
- 💰 `gemini-2.5-flash-image` 非常便宜（约 $0.0001/张）
- 📊 可以设置预算警报

**启用步骤**：

1. 在 Google Cloud Console 中，点击 "Billing"
2. 关联一个付费账户（需要信用卡）
3. 设置预算警报（推荐 $10）

## 重新部署

配置完成后，代码已经准备好，直接重新部署：

```bash
git add .
git commit -m "feat: 启用 Vertex AI 支持 gemini-2.5-flash-image"
git push
```

## 验证配置

部署完成后，在 Vercel Logs 中应该看到：

```
✅ Vertex AI configured: project=mynook-ai-123456, location=us-central1
🔧 Initializing Vertex AI client for user ...
🤖 Using model: gemini-2.5-flash-image (Vertex AI)
📤 Calling Vertex AI with 1 reference image(s)...
✅ Image generated successfully for user ...
```

## 故障排查

### 错误：Vertex AI is not configured

**原因**: 环境变量未设置

**解决**: 检查 Vercel 中的环境变量，确保：
- `GOOGLE_GENAI_USE_VERTEXAI=true`
- `GOOGLE_CLOUD_PROJECT` 已设置

### 错误：Permission denied

**原因**: 服务账号权限不足

**解决**: 
1. 进入 IAM & Admin → Service Accounts
2. 确认服务账号有 "Vertex AI User" 角色

### 错误：API not enabled

**原因**: Vertex AI API 未启用

**解决**: 
1. 搜索 "Vertex AI API"
2. 点击 "ENABLE"

### 错误：Billing account required

**原因**: 未启用计费

**解决**: 按照第 6 步启用计费账户

## 价格估算

假设每天生成 100 张图片：

- **gemini-2.5-flash-image**: 约 $0.01/天
- **每月**: 约 $0.30
- **使用 $300 免费额度**: 可用 1000 个月 😊

## 对比

| 方案 | 认证方式 | 模型 | 支持图像编辑 | 价格 |
|------|----------|------|--------------|------|
| **之前（API Key）** | API Key | imagen-3.0 | ❌ 不支持 | 中等 |
| **现在（Vertex AI）** | 服务账号 | gemini-2.5-flash-image | ✅ 支持 | 便宜 |

## 下一步

配置完成后：

1. ✅ 推送代码到 Vercel
2. ✅ 等待部署完成（1-2分钟）
3. ✅ 测试图像生成功能
4. ✅ 查看 Vercel Logs 确认一切正常

## 相关文件

- `api/generate-image.ts` - 已更新支持 Vertex AI
- `VERTEX_AI_配置指南.md` - 详细配置文档
- `package.json` - 依赖包（无需修改，`@google/genai` 已支持）

---

**需要帮助？** 查看详细文档：[VERTEX_AI_配置指南.md](./VERTEX_AI_配置指南.md)

