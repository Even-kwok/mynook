# å›¾ç‰‡ç”Ÿæˆé€Ÿåº¦ä¼˜åŒ– - 2025å¹´10æœˆ12æ—¥

## é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆï¼šéƒ¨ç½²åç¬¬ä¸€æ¬¡ç”Ÿæˆå›¾ç‰‡æ­£å¸¸ï¼Œç¬¬äºŒæ¬¡ç”Ÿæˆéœ€è¦å°†è¿‘2åˆ†é’Ÿï¼Œä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒã€‚

## é—®é¢˜åŸå› åˆ†æ

### 1. è¶…æ—¶é…ç½®ä¸åŒ¹é…
- **Vercelå‡½æ•°è¶…æ—¶**: 60ç§’
- **å‰ç«¯è¶…æ—¶**: 70ç§’ 
- **Vertex AIè°ƒç”¨**: æ— è¶…æ—¶é™åˆ¶

å½“Vercelå‡½æ•°åœ¨60ç§’è¶…æ—¶æ—¶ï¼Œå‰ç«¯ä»åœ¨ç­‰å¾…70ç§’ï¼Œå¯¼è‡´æ··ä¹±ã€‚

### 2. é‡è¯•æœºåˆ¶å¯¼è‡´æ—¶é—´è¿‡é•¿
- å‰ç«¯æœ‰3æ¬¡å°è¯•æœºåˆ¶ï¼ˆ1æ¬¡åˆå§‹ + 2æ¬¡é‡è¯•ï¼‰
- æ¯æ¬¡é‡è¯•é—´éš”3ç§’
- æ€»æ—¶é—´ï¼š70ç§’ + 3ç§’ + 70ç§’ â‰ˆ 143ç§’ï¼ˆæ¥è¿‘2åˆ†é’Ÿï¼‰

### 3. ä¸´æ—¶æ–‡ä»¶é‡å¤åˆ›å»º
- æ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºæ–°çš„å‡­æ®æ–‡ä»¶ï¼š`gcloud-creds-${userId}-${Date.now()}.json`
- æ¯æ¬¡è¯·æ±‚ç»“æŸéƒ½åˆ é™¤æ–‡ä»¶
- é‡å¤I/Oæ“ä½œæµªè´¹æ—¶é—´

## è§£å†³æ–¹æ¡ˆ

### 1. ä¼˜åŒ–è¶…æ—¶é…ç½®

#### vercel.json
```json
{
  "functions": {
    "api/generate-image.ts": {
      "maxDuration": 120,  // å›¾ç‰‡ç”Ÿæˆå•ç‹¬è®¾ç½®2åˆ†é’Ÿ
      "memory": 3008
    },
    "api/*.ts": {
      "maxDuration": 60,   // å…¶ä»–APIä¿æŒ60ç§’
      "memory": 3008
    }
  }
}
```

#### services/geminiService.ts
```typescript
const MAX_RETRIES = 1;      // å‡å°‘é‡è¯•æ¬¡æ•°ï¼š1æ¬¡åˆå§‹ + 1æ¬¡é‡è¯•
const TIMEOUT = 110000;     // 110ç§’ï¼ˆå°äºVercelçš„120ç§’ï¼‰
const RETRY_DELAY = 2000;   // 2ç§’å»¶è¿Ÿ
```

#### api/generate-image.ts
```typescript
// ä¸ºVertex AIè°ƒç”¨æ·»åŠ 100ç§’è¶…æ—¶
const requestTimeout = new Promise((_, reject) => {
  setTimeout(() => reject(new Error('Vertex AI request timeout after 100 seconds')), 100000);
});

const response = await Promise.race([generateRequest, requestTimeout]);
```

### 2. ä¼˜åŒ–å‡­æ®æ–‡ä»¶ç®¡ç†

**ä¿®æ”¹å‰**ï¼š
```typescript
// æ¯æ¬¡åˆ›å»ºæ–°æ–‡ä»¶
const tempCredPath = join('/tmp', `gcloud-creds-${userId}-${Date.now()}.json`);
writeFileSync(tempCredPath, credentialsJson);

// ç»“æŸæ—¶åˆ é™¤
finally {
  unlinkSync(tempCredPath);
}
```

**ä¿®æ”¹å**ï¼š
```typescript
// ä½¿ç”¨é¡¹ç›®IDä½œä¸ºæ–‡ä»¶åï¼Œé‡ç”¨å·²æœ‰æ–‡ä»¶
const tempCredPath = join('/tmp', `gcloud-creds-${credentials.project_id}.json`);

// åªåœ¨æ–‡ä»¶ä¸å­˜åœ¨æ—¶æ‰å†™å…¥
if (!existsSync(tempCredPath)) {
  writeFileSync(tempCredPath, credentialsJson);
  console.log('âœ… Credentials written to temp file');
} else {
  console.log('âœ… Reusing existing credentials file');
}

// ä¿ç•™æ–‡ä»¶ä¾›åç»­è¯·æ±‚ä½¿ç”¨ï¼Œä¸åˆ é™¤
finally {
  console.log('âœ… Request completed, credentials file retained for reuse');
}
```

### 3. æ·»åŠ æ€§èƒ½ç›‘æ§æ—¥å¿—

```typescript
const startTime = Date.now();
console.log(`ğŸ”§ [${startTime}] Initializing Vertex AI client...`);

// ... å¤„ç†è¿‡ç¨‹ ...

const prepTime = Date.now() - startTime;
console.log(`ğŸ¤– Using model: ${modelName} (prep: ${prepTime}ms)`);

// ... ç”Ÿæˆå®Œæˆ ...

const totalTime = Date.now() - startTime;
console.log(`âœ… Image generated in ${totalTime}ms (${(totalTime/1000).toFixed(1)}s)`);
```

## é¢„æœŸæ•ˆæœ

### ç¬¬ä¸€æ¬¡è¯·æ±‚
- åˆ›å»ºå‡­æ®æ–‡ä»¶ï¼š~50ms
- Vertex AIç”Ÿæˆï¼š30-60ç§’
- **æ€»æ—¶é—´**ï¼š30-60ç§’

### ç¬¬äºŒæ¬¡åŠåç»­è¯·æ±‚
- é‡ç”¨å‡­æ®æ–‡ä»¶ï¼š~5msï¼ˆèŠ‚çœ45msï¼‰
- Vertex AIç”Ÿæˆï¼š30-60ç§’
- **æ€»æ—¶é—´**ï¼š30-60ç§’

### è¶…æ—¶ä¿æŠ¤
- å•æ¬¡å°è¯•æœ€é•¿ï¼š110ç§’
- æœ€å¤šé‡è¯•ï¼š1æ¬¡
- **æœ€é•¿æ€»æ—¶é—´**ï¼š110ç§’ + 2ç§’ + 110ç§’ = 222ç§’ï¼ˆä»…æç«¯æƒ…å†µï¼‰

## éƒ¨ç½²æ­¥éª¤

1. **æäº¤ä»£ç åˆ°Git**
   ```bash
   git add .
   git commit -m "ä¼˜åŒ–å›¾ç‰‡ç”Ÿæˆé€Ÿåº¦ï¼šè°ƒæ•´è¶…æ—¶é…ç½®å’Œå‡­æ®æ–‡ä»¶ç®¡ç†"
   git push
   ```

2. **Vercelè‡ªåŠ¨éƒ¨ç½²**
   - Vercelä¼šè‡ªåŠ¨æ£€æµ‹åˆ°æ›´æ”¹å¹¶é‡æ–°éƒ¨ç½²
   - æ–°çš„è¶…æ—¶é…ç½®ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ

3. **éªŒè¯æµ‹è¯•**
   - ç¬¬ä¸€æ¬¡ç”Ÿæˆï¼šè§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—
   - ç¬¬äºŒæ¬¡ç”Ÿæˆï¼šåº”è¯¥çœ‹åˆ°"Reusing existing credentials file"
   - å¯¹æ¯”ä¸¤æ¬¡ç”Ÿæˆæ—¶é—´ï¼Œç¬¬äºŒæ¬¡åº”è¯¥ç±»ä¼¼ç¬¬ä¸€æ¬¡

## ç›‘æ§æŒ‡æ ‡

éƒ¨ç½²åæŸ¥çœ‹Vercelæ—¥å¿—ï¼Œå…³æ³¨ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **å‡­æ®æ–‡ä»¶é‡ç”¨**
   ```
   âœ… Reusing existing credentials file: /tmp/gcloud-creds-PROJECT_ID.json
   ```

2. **å‡†å¤‡æ—¶é—´**
   ```
   ğŸ¤– Using model: gemini-2.5-flash-image (prep: XXXms)
   ```

3. **æ€»ç”Ÿæˆæ—¶é—´**
   ```
   âœ… Image generated successfully for user XXX in XXXXXms (XX.Xs)
   ```

## æ³¨æ„äº‹é¡¹

1. **Vercelå…è´¹ç‰ˆé™åˆ¶**
   - å…è´¹ç‰ˆæœ€å¤§è¶…æ—¶ï¼š10ç§’
   - éœ€è¦Proç‰ˆæ”¯æŒ120ç§’è¶…æ—¶
   - ç¡®ä¿é¡¹ç›®æ˜¯Proç‰ˆè®¢é˜…

2. **Vertex AIé…é¢**
   - æ³¨æ„Google Cloudçš„APIé…é¢
   - å¦‚æœ‰å¤§é‡è¯·æ±‚ï¼Œè€ƒè™‘å¢åŠ é…é¢

3. **åç»­ä¼˜åŒ–æ–¹å‘**
   - è€ƒè™‘æ·»åŠ è¯·æ±‚é˜Ÿåˆ—ï¼Œé¿å…å¹¶å‘é™åˆ¶
   - å®ç°ç¼“å­˜æœºåˆ¶ï¼Œç›¸ä¼¼è¯·æ±‚ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ
   - æ·»åŠ é¢„çƒ­æœºåˆ¶ï¼Œå®šæœŸè°ƒç”¨APIä¿æŒçƒ­å¯åŠ¨

## ç›¸å…³æ–‡ä»¶

- âœ… `vercel.json` - Vercelå‡½æ•°é…ç½®
- âœ… `api/generate-image.ts` - åç«¯å›¾ç‰‡ç”ŸæˆAPI
- âœ… `services/geminiService.ts` - å‰ç«¯æœåŠ¡å±‚

## çŠ¶æ€

âš ï¸ **å·²æ›´æ–°** - 2025å¹´10æœˆ12æ—¥

ä»£ç å·²ä¿®æ”¹å¹¶è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚ç”±äºå‘ç°ç¬¬ä¸‰æ¬¡è¯·æ±‚å¡ä½é—®é¢˜ï¼Œå·²è¿›è¡Œé¢å¤–è°ƒæ•´ï¼š
- ç¦ç”¨é‡è¯•æœºåˆ¶ï¼ˆä»2æ¬¡å‡å°‘åˆ°0æ¬¡ï¼‰
- ç¼©çŸ­è¶…æ—¶æ—¶é—´ï¼ˆä»120ç§’å‡å°‘åˆ°100ç§’ï¼‰
- è¯¦ç»†æ—¥å¿—è¿½è¸ª

**æœ€æ–°é…ç½®**ï¼š
- Vercelå‡½æ•°ï¼š100ç§’
- åç«¯Vertex AIï¼š90ç§’è¶…æ—¶
- å‰ç«¯Fetchï¼š100ç§’è¶…æ—¶
- é‡è¯•æ¬¡æ•°ï¼š0æ¬¡ï¼ˆç¦ç”¨ï¼‰

è¯¦è§ï¼š`FREE_CANVAS_è¶…æ—¶ä¿®å¤_2025_10_12.md`

