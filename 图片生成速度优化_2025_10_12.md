# 图片生成速度优化 - 2025年10月12日

## 问题描述
用户反馈：部署后第一次生成图片正常，第二次生成需要将近2分钟，严重影响用户体验。

## 问题原因分析

### 1. 超时配置不匹配
- **Vercel函数超时**: 60秒
- **前端超时**: 70秒 
- **Vertex AI调用**: 无超时限制

当Vercel函数在60秒超时时，前端仍在等待70秒，导致混乱。

### 2. 重试机制导致时间过长
- 前端有3次尝试机制（1次初始 + 2次重试）
- 每次重试间隔3秒
- 总时间：70秒 + 3秒 + 70秒 ≈ 143秒（接近2分钟）

### 3. 临时文件重复创建
- 每次请求都创建新的凭据文件：`gcloud-creds-${userId}-${Date.now()}.json`
- 每次请求结束都删除文件
- 重复I/O操作浪费时间

## 解决方案

### 1. 优化超时配置

#### vercel.json
```json
{
  "functions": {
    "api/generate-image.ts": {
      "maxDuration": 120,  // 图片生成单独设置2分钟
      "memory": 3008
    },
    "api/*.ts": {
      "maxDuration": 60,   // 其他API保持60秒
      "memory": 3008
    }
  }
}
```

#### services/geminiService.ts
```typescript
const MAX_RETRIES = 1;      // 减少重试次数：1次初始 + 1次重试
const TIMEOUT = 110000;     // 110秒（小于Vercel的120秒）
const RETRY_DELAY = 2000;   // 2秒延迟
```

#### api/generate-image.ts
```typescript
// 为Vertex AI调用添加100秒超时
const requestTimeout = new Promise((_, reject) => {
  setTimeout(() => reject(new Error('Vertex AI request timeout after 100 seconds')), 100000);
});

const response = await Promise.race([generateRequest, requestTimeout]);
```

### 2. 优化凭据文件管理

**修改前**：
```typescript
// 每次创建新文件
const tempCredPath = join('/tmp', `gcloud-creds-${userId}-${Date.now()}.json`);
writeFileSync(tempCredPath, credentialsJson);

// 结束时删除
finally {
  unlinkSync(tempCredPath);
}
```

**修改后**：
```typescript
// 使用项目ID作为文件名，重用已有文件
const tempCredPath = join('/tmp', `gcloud-creds-${credentials.project_id}.json`);

// 只在文件不存在时才写入
if (!existsSync(tempCredPath)) {
  writeFileSync(tempCredPath, credentialsJson);
  console.log('✅ Credentials written to temp file');
} else {
  console.log('✅ Reusing existing credentials file');
}

// 保留文件供后续请求使用，不删除
finally {
  console.log('✅ Request completed, credentials file retained for reuse');
}
```

### 3. 添加性能监控日志

```typescript
const startTime = Date.now();
console.log(`🔧 [${startTime}] Initializing Vertex AI client...`);

// ... 处理过程 ...

const prepTime = Date.now() - startTime;
console.log(`🤖 Using model: ${modelName} (prep: ${prepTime}ms)`);

// ... 生成完成 ...

const totalTime = Date.now() - startTime;
console.log(`✅ Image generated in ${totalTime}ms (${(totalTime/1000).toFixed(1)}s)`);
```

## 预期效果

### 第一次请求
- 创建凭据文件：~50ms
- Vertex AI生成：30-60秒
- **总时间**：30-60秒

### 第二次及后续请求
- 重用凭据文件：~5ms（节省45ms）
- Vertex AI生成：30-60秒
- **总时间**：30-60秒

### 超时保护
- 单次尝试最长：110秒
- 最多重试：1次
- **最长总时间**：110秒 + 2秒 + 110秒 = 222秒（仅极端情况）

## 部署步骤

1. **提交代码到Git**
   ```bash
   git add .
   git commit -m "优化图片生成速度：调整超时配置和凭据文件管理"
   git push
   ```

2. **Vercel自动部署**
   - Vercel会自动检测到更改并重新部署
   - 新的超时配置会自动生效

3. **验证测试**
   - 第一次生成：观察控制台日志
   - 第二次生成：应该看到"Reusing existing credentials file"
   - 对比两次生成时间，第二次应该类似第一次

## 监控指标

部署后查看Vercel日志，关注以下信息：

1. **凭据文件重用**
   ```
   ✅ Reusing existing credentials file: /tmp/gcloud-creds-PROJECT_ID.json
   ```

2. **准备时间**
   ```
   🤖 Using model: gemini-2.5-flash-image (prep: XXXms)
   ```

3. **总生成时间**
   ```
   ✅ Image generated successfully for user XXX in XXXXXms (XX.Xs)
   ```

## 注意事项

1. **Vercel免费版限制**
   - 免费版最大超时：10秒
   - 需要Pro版支持120秒超时
   - 确保项目是Pro版订阅

2. **Vertex AI配额**
   - 注意Google Cloud的API配额
   - 如有大量请求，考虑增加配额

3. **后续优化方向**
   - 考虑添加请求队列，避免并发限制
   - 实现缓存机制，相似请求直接返回缓存结果
   - 添加预热机制，定期调用API保持热启动

## 相关文件

- ✅ `vercel.json` - Vercel函数配置
- ✅ `api/generate-image.ts` - 后端图片生成API
- ✅ `services/geminiService.ts` - 前端服务层

## 状态

⚠️ **已更新** - 2025年10月12日

代码已修改并进一步优化。由于发现第三次请求卡住问题，已进行额外调整：
- 禁用重试机制（从2次减少到0次）
- 缩短超时时间（从120秒减少到100秒）
- 详细日志追踪

**最新配置**：
- Vercel函数：100秒
- 后端Vertex AI：90秒超时
- 前端Fetch：100秒超时
- 重试次数：0次（禁用）

详见：`FREE_CANVAS_超时修复_2025_10_12.md`

