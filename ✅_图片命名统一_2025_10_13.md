# ✅ 图片命名统一完成 - 2025-10-13

## 📋 问题描述

**用户反馈**：批量下载和单独下载的图片文件名格式不一致

### 修改前

- **单独下载**：`Modern_Minimalist_1760360118928.png`
- **批量下载**：`style_living-room_modern-minimalist_1760360118928.png`

❌ **问题**：格式不统一，影响后续批量上传时的识别

---

## ✅ 已完成的修改

### 1. 统一命名格式

修改 `App.tsx` 中的 `handleDownload` 函数，使用相同的命名规范：

```typescript
const handleDownload = (imageUrl: string, baseName: string) => {
    // 从 generationHistory 中查找这张图片的完整信息，使用统一的命名格式
    let fileName = `${baseName.replace(/\s+/g, '_')}_${Date.now()}.png`;
    
    // 尝试找到对应的 batch 和 image
    for (const batch of generationHistory) {
        const image = batch.results.find(r => r.imageUrl === imageUrl);
        if (image) {
            // 使用与批量下载相同的命名格式: type_roomTypeId_templateName_timestamp
            const parts = [
                batch.type,
                batch.roomTypeId || batch.buildingTypeId || 'no-room',
                image.id,
                batch.id,
            ];
            
            fileName = parts
                .map(p => String(p).toLowerCase().replace(/[^a-z0-9]+/g, '-'))
                .join('_') + '.png';
            break;
        }
    }
    
    const link = document.createElement('a');
    link.href = imageUrl;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};
```

### 2. 统一后的格式

现在**单独下载**和**批量下载**都使用相同的格式：

```
type_roomTypeId_templateName_timestamp.png
```

**示例**：
- `style_living-room_modern-minimalist_1760360118928.png`
- `style_living-room_latte-creamy-style-living-room_1760360118928.png`
- `exterior_villa_mediterranean-villa_1760360118928.png`

---

## 📦 命名规范详解

### 文件名结构（4部分）

```
[功能类型]_[房间类型]_[模板名称]_[时间戳].png
```

| 部分 | 说明 | 示例 |
|------|------|------|
| **功能类型** | style, exterior, wall_paint, floor_style, garden, festive | `style` |
| **房间类型** | living-room, bedroom, kitchen, villa, townhouse | `living-room` |
| **模板名称** | 模板的唯一标识符（已转换为 URL 友好格式） | `modern-minimalist` |
| **时间戳** | 生成批次的时间戳（batch.id） | `1760360118928` |

### 命名规则

1. **小写转换**：所有字符转为小写
2. **特殊字符替换**：非字母数字字符替换为 `-`
3. **分隔符**：使用 `_` 连接各部分
4. **扩展名**：固定为 `.png`

---

## 🎯 优势

### ✅ 统一性
- 单独下载和批量下载使用完全相同的命名格式
- 便于管理和识别

### ✅ 可读性
- 文件名包含完整的上下文信息
- 易于理解图片来源

### ✅ 自动化
- 标准化的命名便于脚本自动解析
- 支持批量上传到 Supabase

### ✅ 可追溯
- 包含时间戳，便于追踪生成时间
- 可以通过文件名还原生成信息

---

## 🔄 配套工具

### 自动上传脚本

`scripts/upload-thumbnails.ts` 已支持解析统一后的文件名格式：

```typescript
interface ParsedFileName {
    type: string;              // 功能类型
    roomTypeId: string;        // 房间类型
    templateName: string;      // 模板名称
    timestamp: string;         // 时间戳
    originalName: string;      // 原始文件名
}

function parseFileName(fileName: string): ParsedFileName | null {
    const baseName = fileName.replace(/\.png$/i, '');
    const parts = baseName.split('_');
    
    if (parts.length < 4) {
        console.warn(`⚠️  无效的文件名格式: ${fileName}`);
        return null;
    }
    
    return {
        type: parts[0],
        roomTypeId: parts[1],
        templateName: parts[2],
        timestamp: parts[3],
        originalName: fileName
    };
}
```

---

## 📝 使用流程

### 1. 生成图片
在应用中生成室内设计图片

### 2. 下载图片
- **单独下载**：点击图片的下载按钮
- **批量下载**：点击 "Download All" 按钮

### 3. 验证文件名
检查下载的文件名格式是否统一：
```
style_living-room_modern-minimalist_1760360118928.png ✅
style_living-room_latte-creamy-style-living-room_1760360118928.png ✅
```

### 4. 批量上传
将下载的图片放到 `upload/` 文件夹，运行上传脚本：
```bash
npx tsx scripts/upload-thumbnails.ts
```

---

## 🚀 部署状态

- ✅ 代码已提交
- ✅ 推送到 GitHub (`feature/thumbnail-generation` 分支)
- 🔄 Vercel 自动部署中...

---

## 📊 测试清单

### 单独下载测试

1. [ ] 生成一张室内设计图片
2. [ ] 点击单独下载按钮
3. [ ] 验证文件名格式：`type_roomtype_templatename_timestamp.png`
4. [ ] 确认文件可以正常打开

### 批量下载测试

1. [ ] 生成多张不同风格的图片
2. [ ] 点击 "Download All" 按钮
3. [ ] 验证所有文件名格式一致
4. [ ] 确认下载数量正确

### 格式一致性测试

1. [ ] 同一张图片分别用单独下载和批量下载
2. [ ] 对比两个文件名的格式（除时间戳外应相同）
3. [ ] 确认格式完全一致 ✅

### 上传测试

1. [ ] 将下载的图片放到 `upload/` 文件夹
2. [ ] 运行 `npx tsx scripts/upload-thumbnails.ts`
3. [ ] 验证文件名可以正确解析
4. [ ] 确认图片上传到正确的路径
5. [ ] 验证数据库 `image_url` 更新成功

---

## 🎉 完成总结

### 修改范围
- **文件**：`App.tsx`
- **函数**：`handleDownload`
- **行数**：+23 / -1

### 改进效果
1. **统一性** ✅ - 单独下载和批量下载格式完全一致
2. **可读性** ✅ - 文件名包含完整上下文信息
3. **自动化** ✅ - 支持脚本自动解析和上传
4. **可维护性** ✅ - 标准化命名便于管理

### 下一步
- 等待 Vercel 部署完成
- 在线测试新的命名格式
- 验证单独下载和批量下载的一致性

---

## 📖 相关文档

- 📦 [批量下载上传工作流程](./📦_批量下载上传工作流程_2025_10_13.md)
- 🚀 [快速开始指南](./🚀_快速开始_批量下载上传.md)
- 📋 [项目进度总结](./📋_项目进度总结_2025_10_13.md)

