# 信用点动态刷新修复

## 问题描述

用户生成完图片后，Header 中的信用点显示不会自动更新，需要刷新整个页面（F5）才能看到更新后的信用点数量。

## 原因分析

1. **信用点显示来源**：Header 中显示的信用点来自 `auth.profile.credits`
2. **后端扣除**：图片生成时，后端 API 会自动扣除信用点
3. **缺少同步**：前端在图片生成完成后，没有调用 `auth.refreshProfile()` 来同步最新的用户信息
4. **空函数**：之前的 `handleUpdateUser` 函数只是一个 console.log，没有实际功能

## 解决方案

### 1. 修改 `handleUpdateUser` 函数

**位置**：`App.tsx` 第 1358-1368 行

**修改内容**：
- 将函数改为异步函数
- 在信用点更新时，调用 `auth.refreshProfile()` 刷新用户信息
- 添加 500ms 延迟，确保后端完成扣除操作

```typescript
const handleUpdateUser = async (userId: string, updates: Partial<User>) => {
    // 如果是更新信用点，刷新当前用户信息以同步显示
    if (updates.credits !== undefined && userId === currentUser?.id) {
        // 等待一小段时间，确保后端已经完成信用点扣除
        await new Promise(resolve => setTimeout(resolve, 500));
        // 刷新用户信息以显示最新的信用点
        await auth.refreshProfile();
    }
    console.log('Update user:', userId, updates);
};
```

### 2. 在所有图片生成功能中添加刷新逻辑

在以下函数中，图片生成成功后调用 `handleUpdateUser`：

1. **Interior Design / Exterior Design**（`handleGenerateClick`）
   - 位置：App.tsx 第 1827 行
   - 在生成完成并保存到 history 后，刷新信用点

2. **Item Replace**（`handleItemReplaceClick`）
   - 位置：App.tsx 第 1892 行
   - 在成功生成并保存到 history 后，刷新信用点

3. **Reference Style Match**（`handleStyleMatchClick`）
   - 位置：App.tsx 第 1962 行
   - 在成功生成并保存到 history 后，刷新信用点

4. **Multi-Item Preview**（`handleMultiItemClick`）
   - 位置：App.tsx 第 2034 行
   - 在成功生成并保存到 history 后，刷新信用点

5. **AI Design Advisor**（`handleAskAdvisor`）
   - 位置：App.tsx 第 2136 行
   - 在成功生成响应并保存到 history 后，刷新信用点

6. **Regenerate**（`handleRegenerate`）
   - 位置：App.tsx 第 2174 行
   - 在成功重新生成后，刷新信用点

7. **Free Canvas**（`FreeCanvasPage`）
   - 位置：components/FreeCanvasPage.tsx 第 1378-1380 行
   - 在成功生成并保存到 history 后，调用 `onUpdateUser` 刷新信用点

### 3. 修改时机

**关键改动**：
- **之前**：在图片生成**开始前**调用 `handleUpdateUser`（但函数为空）
- **现在**：在图片生成**成功后**调用 `handleUpdateUser`（会刷新用户信息）

这样做的好处：
1. 只在生成成功时才刷新，避免失败时的不一致
2. 给后端足够时间完成信用点扣除操作
3. 确保显示的信用点与数据库一致

## 测试清单

### 1. Interior Design
- [ ] 选择模板生成图片
- [ ] 生成完成后，观察 Header 中的信用点是否自动减少
- [ ] 无需刷新页面即可看到更新

### 2. Free Canvas
- [ ] 上传图片并生成
- [ ] 生成完成后，观察信用点是否自动更新

### 3. Item Replace
- [ ] 上传房间图片和物品图片
- [ ] 生成完成后，观察信用点是否自动更新

### 4. Reference Style Match
- [ ] 上传房间图片和风格参考图片
- [ ] 生成完成后，观察信用点是否自动更新

### 5. Multi-Item Preview
- [ ] 上传房间图片和多个物品图片
- [ ] 生成完成后，观察信用点是否自动更新

### 6. AI Design Advisor
- [ ] 输入问题并选择顾问
- [ ] 生成完成后，观察信用点是否自动更新

### 7. Regenerate
- [ ] 对已生成的图片点击重新生成
- [ ] 生成完成后，观察信用点是否自动更新

## 技术细节

### 信用点流程

```
用户点击生成
    ↓
检查信用点是否足够
    ↓
开始生成（loading）
    ↓
调用后端 API（后端自动扣除信用点）
    ↓
生成成功
    ↓
保存到 history
    ↓
调用 handleUpdateUser
    ↓
等待 500ms
    ↓
调用 auth.refreshProfile()
    ↓
从数据库获取最新的用户信息
    ↓
更新 AuthContext 中的 profile
    ↓
Header 自动显示更新后的信用点
```

### AuthContext 刷新机制

`auth.refreshProfile()` 会：
1. 调用 `getUserProfile(userId)` 从 Supabase 获取最新数据
2. 更新 AuthContext 中的 `profile` state
3. 触发所有使用 `useAuth()` 的组件重新渲染
4. Header 中的 `user.credits` 自动更新

## 注意事项

1. **500ms 延迟**：为了确保后端完成信用点扣除，添加了 500ms 的延迟。这个时间可以根据实际情况调整。

2. **失败处理**：如果图片生成失败，不会调用 `handleUpdateUser`，因此信用点不会被扣除，这与后端逻辑一致。

3. **网络问题**：如果刷新用户信息时出现网络错误，不会影响图片生成的结果，只是信用点显示可能需要稍后刷新。

## 相关文件

- `App.tsx` - 主要修改文件
- `components/FreeCanvasPage.tsx` - Free Canvas 功能
- `context/AuthContext.tsx` - 用户认证和信息管理

## 完成时间

2025年10月12日

## 状态

✅ **已完成** - 所有图片生成功能都已添加动态刷新逻辑

