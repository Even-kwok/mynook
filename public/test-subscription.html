<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyNook Subscription Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      color: #333;
    }
    h1 {
      margin-bottom: 10px;
      font-size: 32px;
      color: #667eea;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s;
    }
    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .success { border-left-color: #4caf50; background: #f1f8f4; }
    .error { border-left-color: #f44336; background: #fef1f0; }
    .section {
      margin: 30px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    .section h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 20px;
    }
    select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      margin: 10px 0;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    .status-badge.online { background: #4caf50; color: white; }
    .status-badge.offline { background: #f44336; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ MyNook Subscription Test Tool</h1>
    <p class="subtitle">æµ‹è¯•è®¢é˜…ç³»ç»Ÿå’Œ API åŠŸèƒ½</p>

    <!-- Section 1: Login Status -->
    <div class="section">
      <h2>ğŸ“Š ç™»å½•çŠ¶æ€</h2>
      <button onclick="checkLoginStatus()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
      <div id="login-result" class="result" style="display:none;"></div>
    </div>

    <!-- Section 2: API Health Check -->
    <div class="section">
      <h2>ğŸ¥ API å¥åº·æ£€æŸ¥</h2>
      <button onclick="testHealthAPI()">æµ‹è¯• Health API</button>
      <button onclick="testConnectionAPI()">æµ‹è¯• Connection API</button>
      <div id="health-result" class="result" style="display:none;"></div>
    </div>

    <!-- Section 3: Subscription Test -->
    <div class="section">
      <h2>ğŸ’³ è®¢é˜…åŠŸèƒ½æµ‹è¯•</h2>
      <label>é€‰æ‹©å¥—é¤:</label>
      <select id="planType">
        <option value="pro">Pro Plan ($17/æœˆ)</option>
        <option value="premium" selected>Premium Plan ($42/æœˆ)</option>
        <option value="business">Business Plan ($142/æœˆ)</option>
      </select>
      <label>é€‰æ‹©å‘¨æœŸ:</label>
      <select id="billingCycle">
        <option value="monthly" selected>Monthly (æŒ‰æœˆ)</option>
        <option value="yearly">Yearly (æŒ‰å¹´çœ50%)</option>
      </select>
      <button onclick="testSubscription()">æµ‹è¯•è®¢é˜… API</button>
      <div id="subscription-result" class="result" style="display:none;"></div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;

    function showResult(elementId, data, isError = false) {
      const element = document.getElementById(elementId);
      element.style.display = 'block';
      element.className = 'result ' + (isError ? 'error' : 'success');
      element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }

    async function checkLoginStatus() {
      try {
        // å°è¯•ä» localStorage è·å– Supabase session
        const keys = Object.keys(localStorage).filter(k => k.includes('supabase') || k.includes('auth-token'));
        
        if (keys.length === 0) {
          showResult('login-result', 'âŒ æœªæ‰¾åˆ°ç™»å½•ä¿¡æ¯ã€‚è¯·å…ˆåœ¨ä¸»é¡µç™»å½•ã€‚', true);
          return;
        }

        let sessionData = null;
        for (const key of keys) {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            if (data && data.access_token) {
              sessionData = data;
              break;
            }
          } catch (e) {
            continue;
          }
        }

        if (sessionData) {
          showResult('login-result', {
            status: 'âœ… å·²ç™»å½•',
            token_preview: sessionData.access_token?.substring(0, 50) + '...',
            user_email: sessionData.user?.email || 'N/A'
          });
        } else {
          showResult('login-result', 'âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ sessionã€‚è¯·å…ˆåœ¨ä¸»é¡µç™»å½•ã€‚', true);
        }
      } catch (error) {
        showResult('login-result', `âŒ é”™è¯¯: ${error.message}`, true);
      }
    }

    async function testHealthAPI() {
      try {
        const response = await fetch(`${API_BASE}/api/health`);
        const data = await response.json();
        showResult('health-result', data, !response.ok);
      } catch (error) {
        showResult('health-result', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, true);
      }
    }

    async function testConnectionAPI() {
      try {
        const response = await fetch(`${API_BASE}/api/test-connection`);
        const data = await response.json();
        showResult('health-result', data, !response.ok);
      } catch (error) {
        showResult('health-result', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, true);
      }
    }

    async function testSubscription() {
      try {
        // è·å– session token
        const keys = Object.keys(localStorage).filter(k => k.includes('supabase') || k.includes('auth-token'));
        let sessionData = null;
        
        for (const key of keys) {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            if (data && data.access_token) {
              sessionData = data;
              break;
            }
          } catch (e) {
            continue;
          }
        }

        if (!sessionData || !sessionData.access_token) {
          showResult('subscription-result', 'âŒ æœªç™»å½•ã€‚è¯·å…ˆåœ¨ä¸»é¡µç™»å½•ï¼Œç„¶ååˆ·æ–°æ­¤é¡µé¢ã€‚', true);
          return;
        }

        const planType = document.getElementById('planType').value;
        const billingCycle = document.getElementById('billingCycle').value;

        showResult('subscription-result', 'â³ æ­£åœ¨æµ‹è¯•è®¢é˜… API...', false);

        const response = await fetch(`${API_BASE}/api/create-checkout-session`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${sessionData.access_token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ planType, billingCycle })
        });

        const data = await response.json();
        
        if (response.ok) {
          showResult('subscription-result', {
            status: 'âœ… è®¢é˜… API æˆåŠŸ',
            response: data
          }, false);
        } else {
          showResult('subscription-result', {
            status: 'âŒ è®¢é˜… API å¤±è´¥',
            httpStatus: response.status,
            error: data
          }, true);
        }
      } catch (error) {
        showResult('subscription-result', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, true);
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç™»å½•çŠ¶æ€
    window.addEventListener('load', () => {
      console.log('ğŸ”§ Subscription Test Tool Ready');
      checkLoginStatus();
    });
  </script>
</body>
</html>

