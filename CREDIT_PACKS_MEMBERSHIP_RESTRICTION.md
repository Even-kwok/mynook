# ä¿¡ç”¨ç‚¹åŒ…ä¼šå‘˜ç­‰çº§é™åˆ¶åŠŸèƒ½

## ğŸ“… æ›´æ–°æ—¥æœŸ
2025-10-11

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°
ä¿¡ç”¨ç‚¹åŒ…ï¼ˆCredit Packsï¼‰ç°åœ¨ä»…é™ **Proã€Premium å’Œ Business** ä¼šå‘˜è´­ä¹°ï¼Œå…è´¹ç”¨æˆ·æ— æ³•è´­ä¹°ä¿¡ç”¨ç‚¹åŒ…ã€‚

## ğŸ”§ å®ç°å†…å®¹

### 1. å‰ç«¯é™åˆ¶ (PricingPage.tsx)

#### åŠŸèƒ½ç‚¹ï¼š
- âœ… åœ¨ `handlePurchaseCredits` å‡½æ•°ä¸­æ·»åŠ ä¼šå‘˜ç­‰çº§æ£€æŸ¥
- âœ… å…è´¹ç”¨æˆ·ç‚¹å‡»è´­ä¹°æ—¶æ˜¾ç¤ºé”™è¯¯æç¤º
- âœ… å…è´¹ç”¨æˆ·çœ‹åˆ°çš„è´­ä¹°æŒ‰é’®æ˜¾ç¤ºä¸º "ğŸ”’ Upgrade Required" å¹¶ç¦ç”¨
- âœ… åœ¨æ¯ä¸ªä¿¡ç”¨ç‚¹åŒ…å¡ç‰‡ä¸Šæ·»åŠ ä¼šå‘˜å‡çº§æç¤º

#### ç”¨æˆ·ä½“éªŒï¼š
- å…è´¹ç”¨æˆ·çœ‹åˆ°çš„ä¿¡ç”¨ç‚¹åŒ…ï¼š
  - è´­ä¹°æŒ‰é’®æ˜¾ç¤ºä¸º "ğŸ”’ Upgrade Required" (ç¦ç”¨çŠ¶æ€)
  - æŒ‰é’®ä¸Šæ–¹æ˜¾ç¤ºæç¤ºä¿¡æ¯ï¼š
    ```
    â­ Upgrade to Pro, Premium or Business to purchase credits
    ```
  - ç‚¹å‡»æŒ‰é’®æ—¶æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼š
    ```
    Credit packs are only available for Pro, Premium, and Business members. 
    Please upgrade your plan first.
    ```

- ä»˜è´¹ä¼šå‘˜ï¼ˆPro/Premium/Businessï¼‰çœ‹åˆ°çš„ä¿¡ç”¨ç‚¹åŒ…ï¼š
  - æ­£å¸¸æ˜¾ç¤º "Buy Now" æŒ‰é’®
  - å¯ä»¥æ­£å¸¸è´­ä¹°

### 2. åç«¯éªŒè¯ (api/purchase-credits.js)

#### å®‰å…¨æªæ–½ï¼š
- âœ… åœ¨æ•°æ®åº“æŸ¥è¯¢æ—¶åŒ…å« `membership_tier` å­—æ®µ
- âœ… éªŒè¯ç”¨æˆ·ä¼šå‘˜ç­‰çº§ï¼Œå…è´¹ç”¨æˆ·ç›´æ¥è¿”å› 403 é”™è¯¯
- âœ… è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯å’Œ `requiresUpgrade: true` æ ‡å¿—

#### é”™è¯¯å“åº”ç¤ºä¾‹ï¼š
```json
{
  "error": "Credit packs are only available for Pro, Premium, and Business members",
  "message": "Please upgrade your plan to purchase credit packs",
  "requiresUpgrade": true
}
```

#### æ—¥å¿—è®°å½•ï¼š
```
âœ… User data retrieved, current credits: X, membership: free
âŒ Free user attempted to purchase credits
```

## ğŸ” å®‰å…¨æ€§

### å‰åç«¯åŒé‡éªŒè¯
1. **å‰ç«¯éªŒè¯**ï¼šæä¾›å³æ—¶çš„ç”¨æˆ·ä½“éªŒåé¦ˆ
2. **åç«¯éªŒè¯**ï¼šç¡®ä¿å®‰å…¨æ€§ï¼Œé˜²æ­¢ç»•è¿‡å‰ç«¯æ£€æŸ¥

### ä¼šå‘˜ç­‰çº§æ£€æŸ¥é€»è¾‘
```javascript
// å‰ç«¯
if (membershipTier === 'free') {
  // æ˜¾ç¤ºé”™è¯¯ + ç¦ç”¨æŒ‰é’®
}

// åç«¯
if (userData.membership_tier === 'free') {
  return 403 Forbidden
}
```

## ğŸ“Š æ”¯æŒçš„ä¼šå‘˜ç­‰çº§

### âœ… å¯ä»¥è´­ä¹°ä¿¡ç”¨ç‚¹åŒ…ï¼š
- â­ **Pro** - æœˆè®¢é˜…ç”¨æˆ·
- ğŸ‘‘ **Premium** - æœˆè®¢é˜…ç”¨æˆ·  
- ğŸ’¼ **Business** - æœˆè®¢é˜…ç”¨æˆ·

### âŒ ä¸èƒ½è´­ä¹°ä¿¡ç”¨ç‚¹åŒ…ï¼š
- ğŸ†“ **Free** - å…è´¹ç”¨æˆ·

## ğŸ’¡ æ¨èè´­ä¹°æµç¨‹

### å¯¹äºå…è´¹ç”¨æˆ·ï¼š
1. è®¿é—® Pricing é¡µé¢
2. çœ‹åˆ° "Plans & pricing" éƒ¨åˆ†çš„ä¼šå‘˜è®¡åˆ’
3. é€‰æ‹©å¹¶è®¢é˜… Proã€Premium æˆ– Business è®¡åˆ’
4. è®¢é˜…æˆåŠŸåï¼Œå¯ä»¥è´­ä¹°ä¿¡ç”¨ç‚¹åŒ…ä½œä¸ºé¢å¤–è¡¥å……

### å¯¹äºä»˜è´¹ç”¨æˆ·ï¼š
1. è®¿é—® Pricing é¡µé¢  
2. æ»šåŠ¨åˆ° "Top up your credits" éƒ¨åˆ†
3. é€‰æ‹©ä¿¡ç”¨ç‚¹åŒ…å¹¶ç‚¹å‡» "Buy Now"
4. å®Œæˆæ”¯ä»˜

## ğŸ¨ UI æ”¹è¿›

### ä¿¡ç”¨ç‚¹åŒ…å¡ç‰‡å˜åŒ–ï¼š

**å…è´¹ç”¨æˆ·çœ‹åˆ°çš„å¡ç‰‡ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ğŸ’                 â”‚
â”‚  300 Credits Pack       â”‚
â”‚  Great for small...     â”‚
â”‚                         â”‚
â”‚  [300 Credits]          â”‚
â”‚                         â”‚
â”‚     $24.99              â”‚
â”‚  $0.083 per credit      â”‚
â”‚                         â”‚
â”‚ â­ Upgrade to Pro,...   â”‚  â† æ–°å¢æç¤º
â”‚                         â”‚
â”‚ [ğŸ”’ Upgrade Required]   â”‚  â† ç¦ç”¨æŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»˜è´¹ç”¨æˆ·çœ‹åˆ°çš„å¡ç‰‡ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ğŸ’                 â”‚
â”‚  300 Credits Pack       â”‚
â”‚  Great for small...     â”‚
â”‚                         â”‚
â”‚  [300 Credits]          â”‚
â”‚                         â”‚
â”‚     $24.99              â”‚
â”‚  $0.083 per credit      â”‚
â”‚                         â”‚
â”‚    [Buy Now]            â”‚  â† å¯ç‚¹å‡»
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ä»£ç å˜æ›´æ‘˜è¦

### å‰ç«¯ (PricingPage.tsx)
```tsx
// 1. ä» AuthContext è·å– membershipTier
const { user, setShowLoginModal, membershipTier, profile } = useContext(AuthContext);

// 2. è´­ä¹°å‡½æ•°ä¸­æ·»åŠ æ£€æŸ¥
if (membershipTier === 'free') {
  setError('Credit packs are only available for Pro, Premium, and Business members...');
  return;
}

// 3. UI ä¸­æ ¹æ®ä¼šå‘˜ç­‰çº§æ˜¾ç¤ºä¸åŒçŠ¶æ€
const isFreeUser = membershipTier === 'free';
const isDisabled = loadingPackId !== null || isFreeUser;
```

### åç«¯ (purchase-credits.js)
```javascript
// 1. æŸ¥è¯¢ç”¨æˆ·æ—¶åŒ…å« membership_tier
.select('id, email, credits, membership_tier')

// 2. éªŒè¯ä¼šå‘˜ç­‰çº§
if (userData.membership_tier === 'free') {
  return res.status(403).json({ 
    error: 'Credit packs are only available for Pro, Premium, and Business members',
    message: 'Please upgrade your plan to purchase credit packs',
    requiresUpgrade: true
  });
}
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ï¼š

1. **å…è´¹ç”¨æˆ·æµ‹è¯•ï¼š**
   - ç™»å½•ä¸ºå…è´¹ç”¨æˆ·
   - è®¿é—® Pricing é¡µé¢
   - éªŒè¯ä¿¡ç”¨ç‚¹åŒ…æŒ‰é’®æ˜¾ç¤ºä¸º "ğŸ”’ Upgrade Required" ä¸”ç¦ç”¨
   - å°è¯•ç‚¹å‡»ï¼ˆä¸åº”è§¦å‘è´­ä¹°æµç¨‹ï¼‰

2. **Pro ç”¨æˆ·æµ‹è¯•ï¼š**
   - å‡çº§/ç™»å½•ä¸º Pro ç”¨æˆ·
   - è®¿é—® Pricing é¡µé¢
   - éªŒè¯ä¿¡ç”¨ç‚¹åŒ…æŒ‰é’®æ˜¾ç¤ºä¸º "Buy Now" ä¸”å¯ç‚¹å‡»
   - å®Œæˆè´­ä¹°æµç¨‹

3. **Premium/Business ç”¨æˆ·æµ‹è¯•ï¼š**
   - åŒ Pro ç”¨æˆ·æµ‹è¯•æµç¨‹

4. **å®‰å…¨æµ‹è¯•ï¼š**
   - å°è¯•ä½¿ç”¨ API å·¥å…·ç›´æ¥è°ƒç”¨ `/api/purchase-credits` 
   - ä½¿ç”¨å…è´¹ç”¨æˆ·çš„ token
   - åº”è¯¥æ”¶åˆ° 403 é”™è¯¯å“åº”

## ğŸ“– ç›¸å…³æ–‡æ¡£
- [ä¼šå‘˜ç³»ç»Ÿæ›´æ–°è¯´æ˜.md](./ä¼šå‘˜ç³»ç»Ÿæ›´æ–°è¯´æ˜.md)
- [MEMBERSHIP_CREDITS_UPDATE.md](./MEMBERSHIP_CREDITS_UPDATE.md)
- [CREDITS_INTEGRATION_GUIDE.md](./CREDITS_INTEGRATION_GUIDE.md)

## âœ… åŠŸèƒ½çŠ¶æ€
- âœ… å‰ç«¯ä¼šå‘˜ç­‰çº§æ£€æŸ¥ - å·²å®Œæˆ
- âœ… åç«¯ä¼šå‘˜ç­‰çº§éªŒè¯ - å·²å®Œæˆ  
- âœ… UI æç¤ºå’Œç¦ç”¨çŠ¶æ€ - å·²å®Œæˆ
- âœ… é”™è¯¯æ¶ˆæ¯æç¤º - å·²å®Œæˆ
- âœ… å®‰å…¨æ€§éªŒè¯ - å·²å®Œæˆ

## ğŸš€ éƒ¨ç½²å»ºè®®

### éƒ¨ç½²åˆ° Vercelï¼š
```bash
# 1. æäº¤ä»£ç 
git add .
git commit -m "feat: é™åˆ¶ä¿¡ç”¨ç‚¹åŒ…è´­ä¹°ä»…é™Pro/Premium/Businessä¼šå‘˜"

# 2. æ¨é€åˆ° GitHub
git push origin main

# 3. Vercel å°†è‡ªåŠ¨éƒ¨ç½²
```

### ç¯å¢ƒå˜é‡æ£€æŸ¥ï¼š
ç¡®ä¿ä»¥ä¸‹ç¯å¢ƒå˜é‡å·²é…ç½®ï¼š
- âœ… `SUPABASE_URL`
- âœ… `SUPABASE_SERVICE_KEY`
- âœ… `CREEM_API_KEY`

## ğŸ’¬ ç”¨æˆ·æ²Ÿé€š

### å»ºè®®çš„è¥é”€ç­–ç•¥ï¼š
1. åœ¨å…è´¹ç”¨æˆ·çœ‹åˆ°é™åˆ¶æ—¶ï¼Œå¼ºè°ƒä¼šå‘˜çš„å…¶ä»–ä¼˜åŠ¿
2. æä¾›æ¸…æ™°çš„å‡çº§è·¯å¾„
3. çªå‡ºæ˜¾ç¤ºæ¯ä¸ªä¼šå‘˜ç­‰çº§çš„ä¿¡ç”¨ç‚¹é¢åº¦

### ç¤ºä¾‹ç”¨æˆ·é€šçŸ¥ï¼š
```
ğŸ’¡ æƒ³è´­ä¹°æ›´å¤šä¿¡ç”¨ç‚¹ï¼Ÿ

å‡çº§åˆ° Proã€Premium æˆ– Business è®¡åˆ’ï¼Œä¸ä»…å¯ä»¥ï¼š
âœ¨ è´­ä¹°é¢å¤–çš„ä¿¡ç”¨ç‚¹åŒ…
âœ¨ æ¯æœˆè·å¾—å›ºå®šä¿¡ç”¨ç‚¹é¢åº¦
âœ¨ è§£é”æ›´å¤šä¸“å±åŠŸèƒ½

ç«‹å³å‡çº§ â†’
```

## ğŸ”„ æœªæ¥æ”¹è¿›å»ºè®®

1. **åŠ¨æ€æç¤º**ï¼šæ ¹æ®ç”¨æˆ·å½“å‰ä¿¡ç”¨ç‚¹ä½¿ç”¨æƒ…å†µï¼Œæ™ºèƒ½æ¨èæœ€é€‚åˆçš„è®¡åˆ’
2. **é™æ—¶ä¼˜æƒ **ï¼šä¸ºå…è´¹ç”¨æˆ·æä¾›é¦–æ¬¡å‡çº§æŠ˜æ‰£
3. **ä¿¡ç”¨ç‚¹é¢„ä¼°**ï¼šå¸®åŠ©ç”¨æˆ·è®¡ç®—éœ€è¦å¤šå°‘ä¿¡ç”¨ç‚¹
4. **è‡ªåŠ¨ç»­è®¢æé†’**ï¼šæé†’ç”¨æˆ·ä¼šå‘˜åˆ°æœŸå‰è´­ä¹°ä¿¡ç”¨ç‚¹åŒ…

---

**å®ç°å®Œæˆ** âœ…  
**æµ‹è¯•çŠ¶æ€**ï¼šç­‰å¾…åœ¨ Vercel ä¸Šæµ‹è¯•  
**å½±å“èŒƒå›´**ï¼šä¿¡ç”¨ç‚¹è´­ä¹°åŠŸèƒ½ã€ä¼šå‘˜æƒé™ç³»ç»Ÿ

