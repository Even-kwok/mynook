# ✅ 批量下载与上传功能 - 完成

**完成时间**: 2025年10月13日  
**功能**: 批量下载生成的图片并上传到 Supabase 模板缩略图数据库

---

## 📋 实现内容

### 1. 前端批量下载功能

#### 位置
`components/FreeCanvasPage.tsx` - `MyDesignsSidebar` 组件

#### 功能特点
- ✅ 在 My Designs 侧边栏顶部添加"批量下载全部 (n)"按钮
- ✅ 根据图片路径信息自动生成规范的文件名
- ✅ 文件名格式: `{type}_{roomTypeId}_{templateId}_{batchId}_{imageId}.png`
- ✅ 逐个下载（每次间隔100ms避免浏览器阻止）
- ✅ 显示下载进度和结果

#### 代码实现 (约167-219行)
```typescript
const handleBatchDownload = async () => {
    const allImages = allGalleryImages.filter(img => img.status === 'success' && img.imageUrl);
    
    if (allImages.length === 0) {
        alert('没有可下载的图片');
        return;
    }

    if (!confirm(\`准备下载 \${allImages.length} 张图片，确定继续吗？\`)) {
        return;
    }

    let downloadCount = 0;
    
    for (const image of allImages) {
        const batch = generationHistory.find(b => b.id === image.batchInfo.id);
        if (!batch) continue;

        // 构建文件名
        const parts = [
            batch.type,
            batch.roomTypeId || batch.buildingTypeId || 'no-room',
            image.templateId || 'no-template',
            batch.id,
            image.id,
        ];
        
        const fileName = parts
            .map(p => String(p).toLowerCase().replace(/[^a-z0-9]+/g, '-'))
            .join('_') + '.png';

        // 下载
        await new Promise(resolve => setTimeout(resolve, 100));
        const link = document.createElement('a');
        link.href = image.imageUrl!;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        downloadCount++;
    }

    alert(\`成功下载 \${downloadCount} / \${allImages.length} 张图片\`);
};
```

---

### 2. 文件命名规范

#### 命名格式
```
{type}_{roomTypeId}_{templateId}_{batchId}_{imageId}.png
```

#### 示例

**Interior Design - Living Room**
```
style_living-room_modern-minimalist_1728835200000_modern-minimalist.png
```

**Exterior Design - House**
```
exterior_house_contemporary_1728835300000_contemporary.png
```

**Garden Design**
```
garden_no-room_japanese-zen-garden_1728835400000_japanese-zen-garden.png
```

#### 命名规则
- 所有字母转小写
- 空格和特殊字符转为连字符 `-`
- 各部分用下划线 `_` 连接

---

### 3. 批量上传脚本

#### 位置
`scripts/upload-thumbnails.ts`

#### 功能
1. 读取 `downloaded-images/` 文件夹中的图片
2. 解析文件名获取元数据
3. 上传到 Supabase Storage (`template-thumbnails` bucket)
4. 更新 `templates` 表的 `imageUrl` 字段

#### 配置选项
```typescript
// 本地图片文件夹路径
const IMAGES_FOLDER = './downloaded-images';

// Supabase Storage Bucket 名称
const STORAGE_BUCKET = 'template-thumbnails';

// 测试模式（不实际上传）
const DRY_RUN = false;
```

#### 使用方法
```bash
# 1. 创建图片文件夹
mkdir downloaded-images

# 2. 将下载的图片放入文件夹
# (从浏览器下载文件夹复制过来)

# 3. 设置环境变量
export VITE_SUPABASE_URL="your-supabase-url"
export SUPABASE_SERVICE_ROLE_KEY="your-service-key"

# 4. 运行上传脚本
npx tsx scripts/upload-thumbnails.ts
```

---

## 🎯 完整工作流程

### 步骤1: 前端生成和下载

1. 在网站上生成多张图片
2. 打开右侧 **My Designs** 侧边栏
3. 点击 **"批量下载全部 (n)"** 按钮
4. 确认下载
5. 图片会自动下载到浏览器默认下载文件夹

**效果**:
```
下载文件夹/
├── style_living-room_modern-minimalist_1728835200000_modern-minimalist.png
├── style_bedroom_scandinavian_1728835201000_scandinavian.png
├── exterior_house_contemporary_1728835202000_contemporary.png
└── ...
```

---

### 步骤2: 组织文件

```bash
# 在项目根目录
cd mynook

# 创建存放图片的文件夹
mkdir downloaded-images

# 将下载的图片移动到这个文件夹
mv ~/Downloads/style_*.png downloaded-images/
mv ~/Downloads/exterior_*.png downloaded-images/
mv ~/Downloads/garden_*.png downloaded-images/

# 查看文件
ls downloaded-images/
```

---

### 步骤3: 准备Supabase

#### 创建 Storage Bucket（如果还没有）

在 Supabase Dashboard:
1. 进入 Storage
2. 创建新 Bucket: `template-thumbnails`
3. 设置为 Public（公开访问）

或使用 SQL:
```sql
-- 创建 bucket
INSERT INTO storage.buckets (id, name, public)
VALUES ('template-thumbnails', 'template-thumbnails', true);

-- 设置访问策略（允许公开读取）
CREATE POLICY "Public Access"
ON storage.objects FOR SELECT
USING ( bucket_id = 'template-thumbnails' );

-- 允许服务密钥上传
CREATE POLICY "Service Role Upload"
ON storage.objects FOR INSERT
WITH CHECK ( bucket_id = 'template-thumbnails' );
```

#### 检查 templates 表结构

```sql
-- 查看现有字段
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'templates';

-- 如果没有 imageUrl 字段，添加它
ALTER TABLE templates 
ADD COLUMN IF NOT EXISTS imageUrl TEXT;
```

---

### 步骤4: 运行上传脚本

```bash
# 方式1: 使用环境变量
export VITE_SUPABASE_URL="https://your-project.supabase.co"
export SUPABASE_SERVICE_ROLE_KEY="your-service-role-key"
npx tsx scripts/upload-thumbnails.ts

# 方式2: 创建 .env 文件
# 在项目根目录创建 .env.local
echo "VITE_SUPABASE_URL=https://your-project.supabase.co" >> .env.local
echo "SUPABASE_SERVICE_ROLE_KEY=your-service-role-key" >> .env.local
npx tsx scripts/upload-thumbnails.ts
```

#### 输出示例
```
🚀 批量上传缩略图工具

📁 图片文件夹: /Users/xxx/mynook/downloaded-images
🗄️  Storage Bucket: template-thumbnails
✅ 生产模式

✅ Supabase 客户端创建成功

📊 找到 15 个图片文件

[1/15] 处理: style_living-room_modern-minimalist_1728835200000_modern-minimalist.png
   📋 元数据:
      - 功能类型: style
      - 房间类型: living-room
      - 模板ID: modern-minimalist
   📤 上传: style_living-room_modern-minimalist_1728835200000_modern-minimalist.png → style/living-room/modern-minimalist_1728835200000.png
   ✅ 上传成功: https://xxx.supabase.co/storage/v1/object/public/template-thumbnails/style/living-room/modern-minimalist_1728835200000.png
   ✅ 数据库更新成功: Modern Minimalist

[2/15] 处理: style_bedroom_scandinavian_1728835201000_scandinavian.png
...

📊 上传统计

总文件数: 15
✅ 上传成功: 15
❌ 上传失败: 0
✅ 数据库更新成功: 15
❌ 数据库更新失败: 0

✨ 完成!
```

---

### 步骤5: 验证结果

#### 检查 Storage
访问 Supabase Dashboard → Storage → `template-thumbnails`

应该看到：
```
template-thumbnails/
├── style/
│   ├── living-room/
│   │   ├── modern-minimalist_xxx.png
│   │   └── scandinavian_xxx.png
│   └── bedroom/
│       └── bohemian_xxx.png
├── exterior/
│   └── house/
│       └── contemporary_xxx.png
└── garden/
    └── no-room/
        └── japanese-zen-garden_xxx.png
```

#### 检查数据库
```sql
-- 查看已上传缩略图的模板
SELECT id, name, category, room_type, imageUrl 
FROM templates 
WHERE imageUrl IS NOT NULL
ORDER BY updated_at DESC
LIMIT 20;
```

#### 测试图片访问
访问返回的 URL，确认图片可以正常显示。

---

## 📊 UI 显示效果

### 批量下载按钮

```
┌─────────────────────────────────┐
│ My Designs              🔲 🔳 🔲│
├─────────────────────────────────┤
│                                 │
│  ┌───────────────────────────┐  │
│  │   📥 批量下载全部 (15)   │  │ ← 新增按钮
│  └───────────────────────────┘  │
│                                 │
│  ▼ Interior Designs (12)        │
│    ┌───┐ ┌───┐ ┌───┐           │
│    │ 🖼 │ │ 🖼 │ │ 🖼 │          │
│    └───┘ └───┘ └───┘           │
│                                 │
│  ▼ Exterior Designs (3)         │
│    ┌───┐ ┌───┐                 │
│    │ 🖼 │ │ 🖼 │                │
│    └───┘ └───┘                 │
└─────────────────────────────────┘
```

### 按钮样式
- **颜色**: 蓝紫色 (Indigo 600)
- **位置**: My Designs 标题下方
- **图标**: 下载图标
- **文字**: 显示图片数量

---

## 🧪 测试步骤

### 1. 测试前端下载

- [ ] 生成3-5张不同类型的图片
- [ ] 点击"批量下载全部"按钮
- [ ] 确认下载
- [ ] 检查浏览器下载文件夹
- [ ] 验证文件名格式正确

### 2. 测试文件名解析

```bash
# 在项目根目录
cd mynook

# 创建测试文件夹
mkdir downloaded-images

# 放入一些测试图片
# 然后运行测试模式
npx tsx -e "
import * as fs from 'fs';
const files = fs.readdirSync('./downloaded-images');
files.forEach(f => {
    const parts = f.replace('.png', '').split('_');
    console.log(f, '=>', {
        type: parts[0],
        room: parts[1],
        template: parts[2]
    });
});
"
```

### 3. 测试上传（测试模式）

```bash
# 修改脚本中的 DRY_RUN = true
# 然后运行
npx tsx scripts/upload-thumbnails.ts

# 应该看到解析信息但不实际上传
```

### 4. 测试上传（生产模式）

```bash
# 修改脚本中的 DRY_RUN = false
# 设置环境变量
# 运行上传
npx tsx scripts/upload-thumbnails.ts

# 检查 Supabase Storage 和数据库
```

---

## ⚠️ 注意事项

### 1. 浏览器下载限制
- 现代浏览器可能阻止批量下载
- 首次使用时需要允许该网站多次下载
- Chrome: 设置 → 隐私和安全 → 网站设置 → 自动下载

### 2. 文件命名
- 模板ID必须匹配数据库中的 `id` 字段
- 如果匹配不上，数据库更新会失败
- 检查控制台警告: "⚠️ 未找到模板"

### 3. Storage 权限
- 需要 Service Role Key 才能上传
- 不要在前端代码中使用 Service Role Key
- 上传脚本只在服务器端运行

### 4. 文件大小
- 建议单张图片不超过 500KB
- 太大的文件会上传很慢
- 可以考虑在前端压缩后再下载

---

## 📝 故障排查

### Q: 浏览器阻止了下载？
**A**: 点击浏览器地址栏右侧的下载图标，选择"允许多次下载"

### Q: 文件名中有很多连字符？
**A**: 这是正常的，中文和特殊字符都会转换为连字符，确保文件名兼容

### Q: 上传脚本报错 "Missing Supabase environment variables"？
**A**: 设置环境变量或创建 .env.local 文件

### Q: 上传成功但数据库未更新？
**A**: 检查 templateId 是否与数据库中的 `id` 字段匹配

### Q: Storage Bucket 不存在？
**A**: 在 Supabase Dashboard 创建 `template-thumbnails` bucket

---

## 🚀 后续优化建议

### 1. ZIP 打包下载
安装 jszip 库实现：
```bash
npm install jszip
```

### 2. 云端直接上传
从前端直接上传到 Supabase，省略本地下载步骤

### 3. 自动化工作流
- GitHub Actions 监听提交
- 自动运行上传脚本
- 自动更新数据库

### 4. 图片优化
- 自动压缩图片
- 生成多种尺寸
- WebP 格式转换

---

## ✅ 完成清单

- [x] 前端批量下载功能
- [x] 文件命名规范
- [x] 文件名解析逻辑
- [x] Supabase 上传脚本
- [x] 数据库更新逻辑
- [x] 使用文档
- [ ] 在 Vercel 上测试
- [ ] 实际上传测试
- [ ] 创建 Storage Bucket
- [ ] 验证缩略图显示

---

## 🎉 功能完成！

现在你有了完整的批量下载和上传解决方案：

1. **前端**: 一键下载所有图片，自动规范命名
2. **本地**: 组织文件，准备上传
3. **服务端**: 批量上传到 Supabase，自动更新数据库

**下一步**: 测试完整流程，验证缩略图显示正确！

