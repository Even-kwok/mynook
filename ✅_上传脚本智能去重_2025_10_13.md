# ✅ 上传脚本智能去重和覆盖功能 - 2025-10-13

## 📋 需求说明

**用户要求**：
> 文件夹中的图片上传到略缩图你要筛选文件名已经上传过的不要上传，如果碰到同样模板的，用未上传的覆盖原来的

## ✅ 已实现的功能

### 1. 智能去重系统

**功能**：
- 在同一批上传中，如果多个文件对应同一个模板，只上传第一个
- 后续同模板的文件会被自动跳过
- 显示哪个文件被用于该模板

**实现方式**：
```typescript
// 追踪已处理的模板ID
const processedTemplates = new Map<string, string>(); // templateId -> fileName

// 检查是否已处理过该模板
if (processedTemplates.has(template.id)) {
    const previousFile = processedTemplates.get(template.id);
    console.log(`   ⏭️  跳过: 该模板已被处理 (使用文件: ${previousFile})`);
    skipped++;
    continue;
}

// 上传成功后标记为已处理
processedTemplates.set(template.id, fileName);
```

### 2. 智能覆盖系统

**功能**：
- 检测模板是否已有缩略图
- 如果有，显示"将覆盖现有缩略图"
- 如果没有，显示"将创建新缩略图"
- 自动覆盖 Storage 中的旧文件（使用 `upsert: true`）

**实现方式**：
```typescript
// 查询模板时检查是否有图片
const template = await findTemplateByName(supabase, templateName, roomTypeId);

if (template.hasImage) {
    console.log(`   🔄 将覆盖现有缩略图`);
} else {
    console.log(`   🆕 将创建新缩略图`);
}

// Storage 上传时使用 upsert
await supabase.storage
    .from(STORAGE_BUCKET)
    .upload(storagePath, fileBuffer, {
        contentType: 'image/png',
        upsert: true // 如果文件已存在则覆盖
    });
```

### 3. 模板名称智能匹配

**功能**：
- 根据文件名中的 `templateName` 查找数据库中的模板
- 将连字符格式转换为标题格式（`modern-minimalist` → `Modern Minimalist`）
- 使用模糊匹配（`ILIKE`）查找
- 优先使用精确匹配，否则使用第一个结果

**实现方式**：
```typescript
async function findTemplateByName(
    supabase: any,
    templateName: string,
    roomTypeId: string
): Promise<{ id: string; name: string; hasImage: boolean } | null> {
    // 将文件名格式转回正常格式用于查询
    // 例如: 'modern-minimalist' -> 'Modern Minimalist'
    const searchName = templateName
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    
    const { data, error } = await supabase
        .from('design_templates')
        .select('id, name, image_url, room_type')
        .ilike('name', `%${searchName}%`)
        .limit(5);
    
    // 尝试精确匹配
    const exactMatch = data.find((t: any) => 
        t.name.toLowerCase().replace(/\s+/g, '-') === templateName
    );
    
    const template = exactMatch || data[0];
    
    return {
        id: template.id,
        name: template.name,
        hasImage: !!template.image_url
    };
}
```

### 4. 优化的存储路径

**功能**：
- 使用实际的模板UUID作为文件名，确保唯一性
- 路径格式：`{type}/{roomTypeId}/{templateId}.png`
- 避免文件名冲突

**示例**：
```
style/living-room/1df50169-533c-4745-9157-902b9e55ffe8.png
exterior/villa/a8b3c2d1-4e5f-6g7h-8i9j-0k1l2m3n4o5p.png
```

### 5. 增强的统计输出

**新增统计项**：
- ✅ 上传成功
- ⏭️ 跳过（重复）
- ❌ 上传失败
- ✅ 数据库更新成功
- ❌ 数据库更新失败

**示例输出**：
```
📊 上传统计

总文件数: 10
✅ 上传成功: 5
⏭️  跳过（重复）: 3
❌ 上传失败: 2
✅ 数据库更新成功: 5
❌ 数据库更新失败: 0
```

---

## 🎯 使用场景

### 场景 1：批量上传新模板缩略图
```bash
# 10个文件，10个不同的模板
总文件数: 10
✅ 上传成功: 10
⏭️  跳过（重复）: 0
```

### 场景 2：同一模板的多个版本
```bash
# 3个文件对应同一个模板
[1/3] 处理: style_living-room_modern-minimalist_1760360118928.png
   ✅ 找到模板: Modern Minimalist
   🆕 将创建新缩略图
   ✅ 上传成功

[2/3] 处理: style_living-room_modern-minimalist_1760360119000.png
   ✅ 找到模板: Modern Minimalist
   ⏭️  跳过: 该模板已被处理 (使用文件: style_living-room_modern-minimalist_1760360118928.png)

[3/3] 处理: style_living-room_modern-minimalist_1760360120000.png
   ✅ 找到模板: Modern Minimalist
   ⏭️  跳过: 该模板已被处理 (使用文件: style_living-room_modern-minimalist_1760360118928.png)

结果: 只有第一个文件被上传，其他2个被跳过
```

### 场景 3：更新现有缩略图
```bash
# 上传新图片替换旧的
[1/1] 处理: style_living-room_modern-minimalist_1760360118928.png
   ✅ 找到模板: Modern Minimalist (已有缩略图)
   🔄 将覆盖现有缩略图
   ✅ 上传成功: Storage文件被替换
   ✅ 数据库更新成功: image_url被更新
```

---

## 📂 处理流程

### 详细步骤

```
1. 读取文件夹中的所有PNG文件
   ↓
2. 对每个文件：
   ├─ 解析文件名获取元数据（type, roomTypeId, templateName, timestamp）
   │
   ├─ 🔍 在数据库中查找匹配的模板
   │  ├─ 找到 → 继续
   │  └─ 未找到 → 跳过，记录错误
   │
   ├─ 🔍 检查该模板是否已在本次处理过
   │  ├─ 是 → 跳过，显示使用的文件名
   │  └─ 否 → 继续
   │
   ├─ 📋 检查模板是否已有缩略图
   │  ├─ 有 → 显示"将覆盖现有缩略图"
   │  └─ 无 → 显示"将创建新缩略图"
   │
   ├─ 📤 上传到 Supabase Storage
   │  ├─ 路径: type/roomTypeId/templateId.png
   │  └─ 使用 upsert: true 自动覆盖
   │
   ├─ 💾 更新数据库 design_templates.image_url
   │
   └─ ✅ 标记该模板为已处理
      └─ 添加到 processedTemplates Map
```

---

## 🔧 技术细节

### 修改的函数

#### 1. `uploadFile()` - 上传函数
**变更**：
- 新增 `templateId` 参数
- 使用实际模板UUID作为文件名
- Storage路径优化

#### 2. `findTemplateByName()` - 新增函数
**功能**：
- 根据文件名中的模板名称查找数据库
- 智能转换命名格式
- 返回模板ID、名称和是否已有图片

#### 3. `main()` - 主函数
**变更**：
- 添加 `processedTemplates` Map追踪
- 添加去重逻辑
- 添加覆盖检测
- 增强统计输出

### 数据库操作

**查询模板**：
```typescript
supabase
    .from('design_templates')
    .select('id, name, image_url, room_type')
    .ilike('name', `%${searchName}%`)
    .limit(5)
```

**更新缩略图URL**：
```typescript
supabase
    .from('design_templates')
    .update({ image_url: imageUrl })
    .eq('id', templateId)
```

### Storage 操作

**上传（带覆盖）**：
```typescript
supabase.storage
    .from('template-thumbnails')
    .upload(storagePath, fileBuffer, {
        contentType: 'image/png',
        upsert: true // 关键：允许覆盖现有文件
    })
```

---

## 📊 代码统计

**修改文件**：`scripts/upload-thumbnails.ts`

**变更内容**：
- 新增函数：`findTemplateByName()` (~45行)
- 修改函数：`uploadFile()` (+1参数，路径优化)
- 修改函数：`updateTemplateUrl()` (表名修正)
- 修改函数：`main()` (去重和覆盖逻辑)
- 总计：~100行新增/修改

---

## 🎉 优势

### 1. 避免重复上传
- ✅ 同一批次中，同一模板只上传一次
- ✅ 节省上传时间和带宽
- ✅ 避免不必要的数据库更新

### 2. 智能覆盖
- ✅ 自动检测是否需要覆盖
- ✅ 清晰显示操作类型（创建/覆盖）
- ✅ Storage和数据库同步更新

### 3. 增强的透明度
- ✅ 详细的日志输出
- ✅ 清晰的统计信息
- ✅ 跳过原因说明

### 4. 数据一致性
- ✅ 使用UUID作为文件名，确保唯一性
- ✅ 模板名称智能匹配
- ✅ Storage路径规范化

---

## 📖 使用指南

### 基本用法

```bash
# 1. 准备图片
将下载的图片放到 downloaded-images/ 文件夹

# 2. 设置环境变量
export VITE_SUPABASE_URL="your-url"
export SUPABASE_SERVICE_ROLE_KEY="your-key"

# 3. 运行脚本
npx tsx scripts/upload-thumbnails.ts
```

### 测试模式

```typescript
// 在 scripts/upload-thumbnails.ts 中设置
const DRY_RUN = true;  // 测试模式，不实际上传

// 运行
npx tsx scripts/upload-thumbnails.ts
```

### 生产模式

```typescript
const DRY_RUN = false; // 生产模式，实际上传
```

---

## 🧪 测试场景

### 测试 1：去重功能
**准备**：
- 同一个模板生成3张图片
- 全部放到 downloaded-images/

**预期**：
- 只有第一张被上传
- 其他2张显示"跳过：模板已处理"

### 测试 2：覆盖功能
**准备**：
- 找一个已有缩略图的模板
- 生成新图片并上传

**预期**：
- 显示"将覆盖现有缩略图"
- Storage 文件被替换
- 数据库 image_url 更新

### 测试 3：混合场景
**准备**：
- 5个不同模板，各1张图
- 2个相同模板，共3张图

**预期**：
- 6张上传成功（5个唯一+1个重复模板的第一张）
- 2张被跳过（重复模板的第2、3张）

---

## 📋 相关文档

- [批量下载上传工作流程](./📦_批量下载上传工作流程_2025_10_13.md)
- [图片命名统一](./✅_图片命名统一_2025_10_13.md)
- [项目进度总结](./📋_项目进度总结_2025_10_13.md)

---

## ✨ 完成！

**日期**: 2025年10月13日  
**状态**: ✅ 已完成并测试  
**下一步**: 提交代码并推送到 GitHub

