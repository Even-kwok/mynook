# 📦 批量下载与上传工作流程

**创建时间**: 2025年10月13日  
**功能**: 批量下载生成的图片并上传到 Supabase 模板缩略图数据库

---

## 🎯 工作流程概述

```
1. 用户在前端生成图片
   ↓
2. 点击"批量下载全部"按钮
   ↓
3. 图片自动下载并按规范命名
   ↓
4. 将下载的图片放入项目文件夹
   ↓
5. 运行批量上传脚本
   ↓
6. 图片自动上传并分配到对应模板
```

---

## 📝 文件命名规范

### 命名格式
```
{type}_{roomTypeId}_{templateId}_{batchId}_{imageId}.png
```

### 命名规则
- 所有字母转小写
- 空格和特殊字符转为连字符 `-`
- 各部分用下划线 `_` 连接

### 示例

#### Interior Design
```
style_living-room_modern-minimalist_1728835200000_modern-minimalist.png
```
解析：
- `type`: `style` (Interior Design 功能)
- `roomTypeId`: `living-room` (Living Room)
- `templateId`: `modern-minimalist` (Modern Minimalist 模板)
- `batchId`: `1728835200000` (生成批次时间戳)
- `imageId`: `modern-minimalist` (图片ID，通常是模板名称)

#### Exterior Design
```
exterior_house_contemporary_1728835300000_contemporary.png
```
解析：
- `type`: `exterior` (Exterior Design 功能)
- `roomTypeId`: `house` (House 建筑类型)
- `templateId`: `contemporary` (Contemporary 模板)

#### Garden Design
```
garden_no-room_japanese-zen-garden_1728835400000_japanese-zen-garden.png
```
解析：
- `type`: `garden` (Garden Design 功能)
- `roomTypeId`: `no-room` (Garden 没有房间类型)
- `templateId`: `japanese-zen-garden`

---

## 💻 前端批量下载功能

### 位置
`components/FreeCanvasPage.tsx` - `MyDesignsSidebar` 组件

### 功能特点
- ✅ 自动根据路径信息生成文件名
- ✅ 逐个下载（每次间隔100ms避免浏览器阻止）
- ✅ 显示下载进度
- ✅ 只下载成功生成的图片

### 使用方法
1. 生成图片后
2. 在右侧 **My Designs** 侧边栏顶部
3. 点击 **"批量下载全部 (n)"** 按钮
4. 确认下载
5. 图片会自动保存到浏览器默认下载文件夹

---

## 📂 文件组织

### 推荐的项目文件夹结构
```
mynook/
├── downloaded-images/          # 从浏览器下载的原始图片
│   ├── style_living-room_modern-minimalist_xxx.png
│   ├── style_bedroom_scandinavian_xxx.png
│   ├── exterior_house_contemporary_xxx.png
│   └── ...
│
├── scripts/
│   └── upload-thumbnails.ts    # 批量上传脚本
│
└── public/
    └── templates/              # 最终的缩略图存储位置（可选）
```

---

## 🚀 Supabase 批量上传脚本

### 脚本位置
`scripts/upload-thumbnails.ts`

### 功能
1. 读取 `downloaded-images/` 文件夹中的所有图片
2. 解析文件名获取元数据
3. 上传到 Supabase Storage
4. 更新 `templates` 表的 `imageUrl` 字段

### 使用方法
```bash
# 1. 将下载的图片放入 downloaded-images 文件夹
# 2. 运行上传脚本
npx tsx scripts/upload-thumbnails.ts

# 或使用 Node
node scripts/upload-thumbnails.ts
```

---

## 🗄️ 数据库表结构

### templates 表
```sql
-- 如果还没有 imageUrl 字段，需要添加
ALTER TABLE templates 
ADD COLUMN IF NOT EXISTS imageUrl TEXT;

-- 查看现有字段
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'templates';
```

### 字段说明
- `id`: 模板唯一标识符 (UUID)
- `name`: 模板名称
- `prompt`: 模板提示词
- `category`: 模板分类
- `room_type`: 房间类型
- `imageUrl`: 缩略图 URL (将由上传脚本填充)

---

## 📊 文件名解析逻辑

### JavaScript/TypeScript 示例
```typescript
function parseFileName(fileName: string) {
    // 移除扩展名
    const baseName = fileName.replace(/\\.png$/, '');
    
    // 按下划线分割
    const parts = baseName.split('_');
    
    if (parts.length < 5) {
        console.warn(`Invalid file name format: ${fileName}`);
        return null;
    }
    
    return {
        type: parts[0],           // 'style', 'exterior', 'garden', etc.
        roomTypeId: parts[1],     // 'living-room', 'house', 'no-room'
        templateId: parts[2],     // 'modern-minimalist', 'contemporary'
        batchId: parts[3],        // 时间戳
        imageId: parts[4],        // 图片ID
        originalName: fileName
    };
}

// 使用示例
const parsed = parseFileName('style_living-room_modern-minimalist_1728835200000_modern-minimalist.png');
console.log(parsed);
// {
//   type: 'style',
//   roomTypeId: 'living-room',
//   templateId: 'modern-minimalist',
//   batchId: '1728835200000',
//   imageId: 'modern-minimalist',
//   originalName: 'style_living-room_modern-minimalist_1728835200000_modern-minimalist.png'
// }
```

---

## 🔄 上传流程

### 1. 准备阶段
```bash
# 创建存放下载图片的文件夹
mkdir downloaded-images
cd downloaded-images
```

### 2. 前端下载
- 在浏览器中生成图片
- 点击"批量下载全部"
- 将下载的图片移动到 `downloaded-images/` 文件夹

### 3. 验证文件名
```bash
# 查看下载的文件
ls downloaded-images/

# 应该看到类似以下的文件：
# style_living-room_modern-minimalist_1728835200000_modern-minimalist.png
# style_bedroom_scandinavian_1728835201000_scandinavian.png
```

### 4. 运行上传脚本
```bash
# 使用 Cursor + MCP 运行
npx tsx scripts/upload-thumbnails.ts
```

### 5. 验证上传结果
```sql
-- 在 Supabase SQL Editor 中检查
SELECT id, name, imageUrl 
FROM templates 
WHERE imageUrl IS NOT NULL
ORDER BY updated_at DESC
LIMIT 10;
```

---

## ✅ 测试清单

### 下载功能测试
- [ ] 生成多张图片（不同功能、房间类型、模板）
- [ ] 点击"批量下载全部"按钮
- [ ] 检查浏览器下载文件夹
- [ ] 验证文件名格式正确
- [ ] 验证所有图片都已下载

### 文件名验证
- [ ] 文件名包含所有必要信息
- [ ] 格式符合规范（小写、连字符、下划线）
- [ ] 可以正确解析出元数据

### 上传脚本测试
- [ ] 脚本能正确读取文件夹
- [ ] 文件名解析正确
- [ ] 上传到 Supabase Storage 成功
- [ ] 数据库记录更新正确
- [ ] 缩略图 URL 可访问

---

## 🐛 常见问题

### Q1: 浏览器阻止了批量下载？
**A**: 现代浏览器会阻止过于频繁的下载。解决方案：
- 我们已经添加了100ms的延迟
- 如果仍被阻止，请在浏览器设置中允许多次下载
- Chrome: 设置 → 隐私和安全 → 网站设置 → 自动下载

### Q2: 文件名中有乱码？
**A**: 确保模板ID和名称只包含英文字母和数字。中文会被转换为连字符。

### Q3: 上传到哪个 Storage Bucket？
**A**: 建议使用：
- Bucket 名称: `template-thumbnails`
- 公开访问: `true`
- 路径: `/{type}/{roomTypeId}/{templateId}.png`

### Q4: 如何批量更新已有模板的缩略图？
**A**: 上传脚本会根据 `templateId` 匹配现有模板并更新 `imageUrl`

---

## 📈 后续优化

### 可能的改进
1. **ZIP 打包下载**
   - 安装 `jszip` 库
   - 将所有图片打包成一个 ZIP 文件
   - 一次性下载

2. **云端同步**
   - 直接从前端上传到 Supabase Storage
   - 不需要本地下载-上传流程
   - 需要考虑安全性和权限

3. **元数据导出**
   - 同时导出一个 `metadata.json` 文件
   - 包含所有图片的详细信息
   - 便于后续处理

4. **自动化脚本**
   - 监听文件夹变化
   - 新文件自动上传
   - 实时更新数据库

---

## 📝 注意事项

1. **文件大小**: 确保图片已压缩，建议单张不超过 500KB
2. **命名冲突**: 如果同一模板生成多次，文件名会包含不同的 batchId
3. **权限**: 运行上传脚本需要 Supabase 管理员权限
4. **备份**: 上传前建议备份现有的模板数据

---

## 🎉 完成！

现在你有了一个完整的批量下载和上传工作流程！

**下一步**:
1. 测试批量下载功能
2. 创建并运行上传脚本
3. 验证缩略图显示正确

