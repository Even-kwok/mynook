# Businessä¼šå‘˜ä¿¡ç”¨ç‚¹ç³»ç»Ÿä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼šBusinessæƒé™æ˜¾ç¤ºé”™è¯¯ï¼Œbusinessä¼šå‘˜åº”è¯¥æŒ‰ç…§ä¿¡ç”¨ç‚¹è®¡ç®—ï¼Œä½†ç³»ç»Ÿæ²¡æœ‰æ­£ç¡®è¿æ¥businessç”¨æˆ·çš„ä¿¡ç”¨ç‚¹æ•°æ®åº“ã€‚

## æ ¹æœ¬åŸå› 

ç³»ç»Ÿä¸­æœ‰æ—§çš„é€»è¾‘ï¼Œå°†Businessä¼šå‘˜è§†ä¸º"æ— é™ä¿¡ç”¨ç‚¹"ç”¨æˆ·ï¼Œä½†æ ¹æ®æ–°çš„ä¼šå‘˜ç³»ç»Ÿè®¾è®¡ï¼ŒBusinessä¼šå‘˜åº”è¯¥ï¼š
- æ‹¥æœ‰25,000ä¿¡ç”¨ç‚¹ï¼ˆé»˜è®¤é…ç½®ï¼‰
- éœ€è¦æ­£å¸¸æ‰£é™¤å’Œæ˜¾ç¤ºä¿¡ç”¨ç‚¹
- æŒ‰ç…§ä¿¡ç”¨ç‚¹æ¶ˆè€—è§„åˆ™ä½¿ç”¨åŠŸèƒ½

## å·²ä¿®å¤çš„é—®é¢˜

### 1. âœ… å‰ç«¯æ˜¾ç¤ºé€»è¾‘ (App.tsx)

**ä¿®æ”¹ä½ç½®**ï¼š`App.tsx` ç¬¬573è¡Œ

**æ—§ä»£ç **ï¼š
```typescript
<span>{user.permissionLevel === 4 ? 'âˆ' : user.credits}</span>
```

**æ–°ä»£ç **ï¼š
```typescript
<span>{user.credits.toLocaleString()}</span>
```

**è¯´æ˜**ï¼š
- ç§»é™¤äº†Businessä¼šå‘˜æ˜¾ç¤º"âˆ"ï¼ˆæ— é™ç¬¦å·ï¼‰çš„ç‰¹æ®Šé€»è¾‘
- æ‰€æœ‰ä¼šå‘˜ç­‰çº§ç°åœ¨éƒ½æ˜¾ç¤ºå®é™…çš„ä¿¡ç”¨ç‚¹æ•°
- ä½¿ç”¨`toLocaleString()`æ ¼å¼åŒ–æ•°å­—ï¼Œæ”¹å–„å¤§æ•°å­—æ˜¾ç¤ºï¼ˆå¦‚25,000ï¼‰

### 2. âœ… åç«¯ä¿¡ç”¨ç‚¹æ£€æŸ¥é€»è¾‘ (api/lib/creditsService.ts)

**ä¿®æ”¹ä½ç½®**ï¼š`checkCreditsAvailable`å‡½æ•°ï¼ˆç¬¬91-104è¡Œï¼‰

**æ—§ä»£ç **ï¼š
```typescript
// Business ä¼šå‘˜æ— é™åˆ¶
if (membershipTier === 'business') {
  return { available: true, currentCredits: credits, membershipTier, error: null };
}

// å…¶ä»–ä¼šå‘˜æ£€æŸ¥ä½™é¢
const available = credits >= requiredCredits;
return { available, currentCredits: credits, membershipTier, error: null };
```

**æ–°ä»£ç **ï¼š
```typescript
// æ‰€æœ‰ä¼šå‘˜éƒ½éœ€è¦æ£€æŸ¥ä¿¡ç”¨ç‚¹ä½™é¢
const available = credits >= requiredCredits;
return { available, currentCredits: credits, membershipTier, error: null };
```

**è¯´æ˜**ï¼š
- ç§»é™¤äº†Businessä¼šå‘˜çš„ç‰¹æ®Šæ£€æŸ¥é€»è¾‘
- æ‰€æœ‰ä¼šå‘˜ç­‰çº§ç»Ÿä¸€æŒ‰ç…§ä¿¡ç”¨ç‚¹ä½™é¢æ£€æŸ¥

### 3. âœ… åç«¯ä¿¡ç”¨ç‚¹æ‰£é™¤é€»è¾‘ (api/lib/creditsService.ts)

**ä¿®æ”¹ä½ç½®**ï¼š`deductCredits`å‡½æ•°ï¼ˆç¬¬128-129è¡Œï¼‰

**æ—§ä»£ç **ï¼š
```typescript
// Business ä¼šå‘˜ä¸æ‰£é™¤ä¿¡ç”¨ç‚¹
const newCredits = userData.membership_tier === 'business' 
  ? userData.credits
  : userData.credits - amount;
```

**æ–°ä»£ç **ï¼š
```typescript
// æ‰€æœ‰ä¼šå‘˜éƒ½éœ€è¦æ‰£é™¤ä¿¡ç”¨ç‚¹
const newCredits = userData.credits - amount;
```

**è¯´æ˜**ï¼š
- Businessä¼šå‘˜ç°åœ¨æ­£å¸¸æ‰£é™¤ä¿¡ç”¨ç‚¹
- ä¸å…¶ä»–ä¼šå‘˜ç­‰çº§ä½¿ç”¨ç›¸åŒçš„æ‰£é™¤é€»è¾‘

### 4. âœ… åç«¯ä¿¡ç”¨ç‚¹å›æ»šé€»è¾‘ (api/lib/creditsService.ts)

**ä¿®æ”¹ä½ç½®**ï¼š`refundCredits`å‡½æ•°ï¼ˆç¬¬174è¡Œï¼‰

**æ—§ä»£ç **ï¼š
```typescript
// Business ä¼šå‘˜ä¸éœ€è¦å›æ»š
if (userData.membership_tier === 'business') {
  return { success: true, error: null };
}

const { error: updateError } = await supabaseAdmin
```

**æ–°ä»£ç **ï¼š
```typescript
// æ‰€æœ‰ä¼šå‘˜éƒ½éœ€è¦å›æ»šä¿¡ç”¨ç‚¹
const { error: updateError } = await supabaseAdmin
```

**è¯´æ˜**ï¼š
- Businessä¼šå‘˜åœ¨æ“ä½œå¤±è´¥æ—¶ä¹Ÿä¼šæ­£å¸¸å›æ»šä¿¡ç”¨ç‚¹
- ç¡®ä¿ä¿¡ç”¨ç‚¹æ‰£é™¤çš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§

## æ•°æ®åº“è¿ç§»

### åˆ›å»ºçš„SQLè„šæœ¬

æ–‡ä»¶ï¼š`supabase/migrations/fix_business_credits.sql`

**åŠŸèƒ½**ï¼š
1. æŸ¥çœ‹å½“å‰Businessç”¨æˆ·çš„ä¿¡ç”¨ç‚¹æƒ…å†µ
2. æ›´æ–°æ‰€æœ‰Businessç”¨æˆ·çš„ä¿¡ç”¨ç‚¹ä¸º25,000ï¼ˆå¦‚æœéœ€è¦ï¼‰
3. æŸ¥çœ‹æ›´æ–°åçš„ç»Ÿè®¡ä¿¡æ¯
4. æŸ¥çœ‹æ‰€æœ‰ä¼šå‘˜ç­‰çº§çš„ç”¨æˆ·åˆ†å¸ƒ

### å¦‚ä½•ä½¿ç”¨

1. **ç™»å½•Supabaseæ§åˆ¶å°**ï¼š
   - è®¿é—® https://supabase.com
   - é€‰æ‹©æ‚¨çš„é¡¹ç›®

2. **æ‰“å¼€SQLç¼–è¾‘å™¨**ï¼š
   - ç‚¹å‡»å·¦ä¾§èœå•çš„"SQL Editor"
   - ç‚¹å‡»"New Query"

3. **æ‰§è¡Œæ£€æŸ¥æŸ¥è¯¢**ï¼š
   ```sql
   -- æŸ¥çœ‹å½“å‰Businessç”¨æˆ·çš„ä¿¡ç”¨ç‚¹æƒ…å†µ
   SELECT 
       id,
       email,
       membership_tier,
       credits,
       total_generations,
       created_at,
       updated_at
   FROM users
   WHERE membership_tier = 'business'
   ORDER BY created_at DESC;
   ```

4. **å¦‚æœéœ€è¦æ›´æ–°**ï¼Œå–æ¶ˆæ³¨é‡Šå¹¶æ‰§è¡Œæ›´æ–°è¯­å¥ï¼š
   ```sql
   UPDATE users 
   SET 
       credits = 25000,
       updated_at = NOW()
   WHERE membership_tier = 'business'
     AND (credits IS NULL OR credits != 25000);
   ```

## ä¼šå‘˜ç­‰çº§é…ç½®ï¼ˆç¡®è®¤ï¼‰

æ ¹æ®`types/database.ts`ï¼Œå½“å‰é…ç½®æ­£ç¡®ï¼š

| ç­‰çº§ | å›¾æ ‡ | é»˜è®¤ä¿¡ç”¨ç‚¹ | æ¯æ¬¡ç”Ÿæˆå›¾ç‰‡æ•° | ä¸»è¦æƒé™ |
|------|------|-----------|----------------|----------|
| Free ğŸ†“ | å…è´¹ç”¨æˆ· | 0 ç‚¹ | 0 | åªèƒ½æµè§ˆ |
| Pro â­ | é«˜çº§ç”¨æˆ· | 1,000 ç‚¹ | 1 | è®¾è®¡ç”Ÿå›¾ |
| Premium ğŸ‘‘ | é«˜çº§ä¼šå‘˜ | 5,000 ç‚¹ | 9 | Free Canvas + ä¼˜å…ˆé˜Ÿåˆ— |
| Business ğŸ’¼ | å•†ä¸šä¼šå‘˜ | **25,000 ç‚¹** | 18 | æ‰€æœ‰åŠŸèƒ½ + æœ€ä½å•ä»· |

## ä¿¡ç”¨ç‚¹æ¶ˆè€—è§„åˆ™

æ ¹æ®`api/lib/creditsService.ts`ï¼š
- æ–‡æœ¬ç”Ÿæˆï¼š1 ä¿¡ç”¨ç‚¹/æ¬¡
- å›¾ç‰‡ç”Ÿæˆï¼š1 ä¿¡ç”¨ç‚¹/å¼ 
- å›¾ç‰‡ç¼–è¾‘ï¼š3 ä¿¡ç”¨ç‚¹/æ¬¡

## æµ‹è¯•å»ºè®®

### 1. å‰ç«¯æ˜¾ç¤ºæµ‹è¯•
- [x] æ£€æŸ¥Businessç”¨æˆ·ç™»å½•åï¼Œé¡¶éƒ¨æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºä¿¡ç”¨ç‚¹æ•°ï¼ˆå¦‚"25,000"ï¼‰
- [x] ç¡®è®¤ä¸å†æ˜¾ç¤º"âˆ"ç¬¦å·

### 2. åŠŸèƒ½æµ‹è¯•
- [ ] Businessç”¨æˆ·ç”Ÿæˆå›¾ç‰‡åï¼Œä¿¡ç”¨ç‚¹åº”è¯¥å‡å°‘1ç‚¹
- [ ] å½“Businessç”¨æˆ·ä¿¡ç”¨ç‚¹è€—å°½æ—¶ï¼Œåº”è¯¥æ— æ³•ç»§ç»­ç”Ÿæˆ
- [ ] æ•°å­—æ˜¾ç¤ºæ ¼å¼åº”è¯¥æ¸…æ™°ï¼ˆå¦‚25,000è€Œä¸æ˜¯25000ï¼‰

### 3. æ•°æ®åº“æµ‹è¯•
- [ ] åœ¨Supabaseä¸­æ£€æŸ¥Businessç”¨æˆ·çš„creditså­—æ®µ
- [ ] ç¡®è®¤æ–°æ³¨å†Œçš„Businessç”¨æˆ·é»˜è®¤è·å¾—25,000ç‚¹
- [ ] ç¡®è®¤ç”Ÿæˆå›¾ç‰‡åcreditsæ­£ç¡®æ‰£é™¤

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

1. âœ… `App.tsx` - ä¿®å¤ä¿¡ç”¨ç‚¹æ˜¾ç¤ºé€»è¾‘
2. âœ… `api/lib/creditsService.ts` - ä¿®å¤ä¿¡ç”¨ç‚¹æ£€æŸ¥ã€æ‰£é™¤ã€å›æ»šé€»è¾‘
3. âœ… `supabase/migrations/fix_business_credits.sql` - åˆ›å»ºæ•°æ®åº“æ£€æŸ¥å’Œæ›´æ–°è„šæœ¬
4. âœ… `BUSINESS_CREDITS_FIX.md` - æœ¬è¯´æ˜æ–‡æ¡£

## åç»­æ­¥éª¤

### å¿…è¦æ­¥éª¤ï¼ˆç”¨æˆ·éœ€è¦æ“ä½œï¼‰

1. **æ£€æŸ¥Supabaseæ•°æ®åº“**ï¼š
   - æ‰§è¡Œ`fix_business_credits.sql`ä¸­çš„æŸ¥è¯¢
   - æ£€æŸ¥ç°æœ‰Businessç”¨æˆ·çš„ä¿¡ç”¨ç‚¹
   - å¦‚æœ‰éœ€è¦ï¼Œæ‰§è¡Œæ›´æ–°è¯­å¥

2. **æµ‹è¯•åº”ç”¨**ï¼š
   - ä½¿ç”¨Businessè´¦æˆ·ç™»å½•
   - æ£€æŸ¥ä¿¡ç”¨ç‚¹æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®
   - ç”Ÿæˆå›¾ç‰‡æµ‹è¯•ä¿¡ç”¨ç‚¹æ‰£é™¤

3. **éƒ¨ç½²æ›´æ–°**ï¼š
   - æäº¤ä»£ç æ›´æ”¹
   - éƒ¨ç½²åˆ°Vercelï¼ˆå¦‚æœæ­£åœ¨ä½¿ç”¨ï¼‰
   - åœ¨ç”Ÿäº§ç¯å¢ƒéªŒè¯

### å¯é€‰æ­¥éª¤

1. **ç›‘æ§æ—¥å¿—**ï¼š
   - å…³æ³¨ä¿¡ç”¨ç‚¹æ‰£é™¤çš„é”™è¯¯æ—¥å¿—
   - æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸æƒ…å†µ

2. **ç”¨æˆ·é€šçŸ¥**ï¼š
   - å¦‚æœæœ‰ç°æœ‰Businessç”¨æˆ·ï¼Œå¯èƒ½éœ€è¦é€šçŸ¥ä»–ä»¬ä¿¡ç”¨ç‚¹ç³»ç»Ÿçš„å˜æ›´
   - è§£é‡Šæ–°çš„ä¿¡ç”¨ç‚¹è§„åˆ™

## æŠ€æœ¯ç»†èŠ‚

### ä¼šå‘˜ç­‰çº§æ˜ å°„

ç³»ç»Ÿä¸­ä½¿ç”¨ä¸¤ç§æ–¹å¼è¡¨ç¤ºä¼šå‘˜ç­‰çº§ï¼š

1. **permissionLevel**ï¼ˆæ—§ç³»ç»Ÿï¼‰ï¼š
   - 1 = Free
   - 2 = Pro
   - 3 = Premium
   - 4 = Business

2. **membership_tier**ï¼ˆæ–°ç³»ç»Ÿï¼‰ï¼š
   - 'free'
   - 'pro'
   - 'premium'
   - 'business'

ä¸¤ç§æ–¹å¼åœ¨ä»£ç ä¸­éƒ½æœ‰ä½¿ç”¨ï¼Œå¹¶é€šè¿‡`getUserMembershipTier()`å‡½æ•°è¿›è¡Œè½¬æ¢ã€‚

### æ•°æ®æµ

1. **ç”¨æˆ·ç™»å½•** â†’ AuthContextè·å–profile
2. **profile.credits** â†’ æ˜¾ç¤ºåœ¨App.tsxé¡¶éƒ¨
3. **ç”Ÿæˆå›¾ç‰‡** â†’ è°ƒç”¨API â†’ creditsService.deductCredits
4. **æ›´æ–°æ•°æ®åº“** â†’ è¿”å›æ–°çš„creditä½™é¢
5. **åˆ·æ–°å‰ç«¯** â†’ æ›´æ–°æ˜¾ç¤º

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤ç¡®ä¿äº†Businessä¼šå‘˜çš„ä¿¡ç”¨ç‚¹ç³»ç»Ÿä¸å…¶ä»–ä¼šå‘˜ç­‰çº§ä¿æŒä¸€è‡´ï¼š
- âœ… æ­£ç¡®æ˜¾ç¤ºå®é™…ä¿¡ç”¨ç‚¹æ•°
- âœ… æ­£ç¡®æ‰£é™¤ä¿¡ç”¨ç‚¹
- âœ… æ­£ç¡®æ£€æŸ¥ä¿¡ç”¨ç‚¹ä½™é¢
- âœ… æä¾›æ•°æ®åº“æ£€æŸ¥å’Œæ›´æ–°å·¥å…·

Businessä¼šå‘˜ä»ç„¶ä¿æŒå…¶ä¼˜åŠ¿ï¼ˆ25,000ç‚¹æ˜¯æœ€é«˜é…é¢ï¼‰ï¼Œä½†ç°åœ¨éµå¾ªç»Ÿä¸€çš„ä¿¡ç”¨ç‚¹ç®¡ç†è§„åˆ™ã€‚

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025-10-10  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶å°±ç»ª  
**æµ‹è¯•çŠ¶æ€**ï¼šâ³ å¾…ç”¨æˆ·éªŒè¯

