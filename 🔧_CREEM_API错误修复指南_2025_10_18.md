# 🔧 CREEM API 错误修复指南

**日期**: 2025年10月18日  
**分支**: public-beta  
**提交**: `f344ebd`  
**状态**: ✅ 代码已修复，需要配置环境变量

---

## 🚨 错误分析

### 错误 1: 400 Bad Request
```json
{
  "status": 400,
  "error": "Bad Request",
  "message": ["URL must be valid, e.g., http://localhost or https://example.com"]
}
```

**原因**: `success_url` 和 `cancel_url` 格式不正确或为空

### 错误 2: 403 Forbidden
```json
{
  "status": 403,
  "error": "Forbidden"
}
```

**原因**: CREEM API Key 不正确或权限不足

---

## ✅ 代码修复

### 1. 改进 Base URL 构建逻辑

**修改文件**: `api/purchase-credits.js`

```javascript
// ❌ 旧代码（可能失败）
const baseUrl = process.env.VERCEL_URL 
  ? `https://${process.env.VERCEL_URL}` 
  : 'http://localhost:3000';

// ✅ 新代码（多重后备方案）
const baseUrl = process.env.NEXT_PUBLIC_SITE_URL 
  || (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : null)
  || (req.headers.origin)
  || (req.headers.host ? `https://${req.headers.host}` : null)
  || 'https://mynook-ai.vercel.app';  // 最终后备

console.log('🌐 Base URL:', baseUrl);
```

**优先级顺序**:
1. `NEXT_PUBLIC_SITE_URL` (环境变量 - 最可靠)
2. `VERCEL_URL` (Vercel 自动注入)
3. `req.headers.origin` (请求来源)
4. `req.headers.host` (请求主机)
5. 硬编码域名 (最终后备)

### 2. 添加详细日志

```javascript
const successUrl = `${baseUrl}/?message=credits-purchased&credits=${pack.credits}`;
const cancelUrl = `${baseUrl}/?message=purchase-cancelled`;

console.log('📦 CREEM Request Details:');
console.log('  - Product ID:', pack.productId);
console.log('  - Success URL:', successUrl);
console.log('  - Cancel URL:', cancelUrl);
console.log('  - Customer:', userData.email);
```

### 3. 改进错误处理

```javascript
if (!creemResponse.ok) {
  const errorData = await creemResponse.json().catch(() => ({}));
  console.error('❌ CREEM API error:', {
    status: creemResponse.status,
    statusText: creemResponse.statusText,
    error: errorData
  });
  
  return res.status(500).json({
    error: 'Payment system error',
    message: errorData.message,
    details: errorData,
    debug: { baseUrl, successUrl, cancelUrl, productId }
  });
}
```

---

## 🔧 Vercel 环境变量配置

### 必需的环境变量

在 **Vercel Dashboard → Settings → Environment Variables** 添加：

#### 1. `NEXT_PUBLIC_SITE_URL` ⭐ 推荐
```
名称: NEXT_PUBLIC_SITE_URL
值: https://your-domain.vercel.app
环境: Production, Preview, Development
```

**说明**: 最可靠的方式，明确指定你的网站 URL

#### 2. `CREEM_API_KEY` 🔑 必需
```
名称: CREEM_API_KEY
值: creem_live_xxxxxxxxxxxxxxxx
环境: Production, Preview
```

**获取方式**:
1. 登录 CREEM Dashboard: https://dashboard.creem.io
2. 进入 Settings → API Keys
3. 复制 Live API Key (以 `creem_live_` 开头)

⚠️ **注意**: 
- Production 使用 Live Key
- Development 使用 Test Key (以 `creem_test_` 开头)

#### 3. `CREEM_API_URL` (可选)
```
名称: CREEM_API_URL
值: https://api.creem.io
环境: Production, Preview, Development
```

**说明**: 通常不需要设置，代码中有默认值

---

## 📋 完整配置检查清单

### Vercel 环境变量检查

- [ ] `SUPABASE_URL` - Supabase 项目 URL
- [ ] `SUPABASE_SERVICE_KEY` - Supabase Service Role Key (服务端)
- [ ] `VITE_SUPABASE_URL` - Supabase 项目 URL (客户端)
- [ ] `VITE_SUPABASE_ANON_KEY` - Supabase Anon Key (客户端)
- [ ] `CREEM_API_KEY` - CREEM API Key ⭐ 新增/检查
- [ ] `NEXT_PUBLIC_SITE_URL` - 网站 URL ⭐ 新增

### CREEM Dashboard 检查

1. **API Key 权限**:
   - [ ] API Key 已激活
   - [ ] 权限包含 `checkouts.create`
   - [ ] 没有 IP 白名单限制（或已添加 Vercel IP）

2. **产品配置**:
   - [ ] 产品 ID 正确：
     - 100 Credits: `prod_22tEVFxJtOQU8cm5H10bZc`
     - 300 Credits: `prod_3E171a5TGDhmBhtYM0Gbk3`
     - 1000 Credits: `prod_MmthQ5RlRKNalU3rEsowB`
   - [ ] 产品状态为 Active
   - [ ] 产品类型为 One-time purchase

3. **Webhook 配置** (用于接收支付成功通知):
   - [ ] Webhook URL: `https://your-domain.vercel.app/api/creem-webhook`
   - [ ] 事件: `checkout.completed`
   - [ ] 状态: Active

---

## 🧪 测试步骤

### 1. 查看服务器日志

部署后在 Vercel 中查看实时日志：

```
Dashboard → Deployments → [最新部署] → Functions → purchase-credits
```

应该看到：
```
========== Credits Purchase API Called ==========
✅ Token received
✅ Supabase credentials found
✅ Supabase client created
✅ User authenticated: xxx
✅ User data retrieved, current credits: xxx
✅ User has valid membership tier for credit purchases
✅ Calling CREEM API for credit pack...
🌐 Base URL: https://your-domain.vercel.app
📦 CREEM Request Details:
  - Product ID: prod_3E171a5TGDhmBhtYM0Gbk3
  - Success URL: https://your-domain.vercel.app/?message=credits-purchased&credits=300
  - Cancel URL: https://your-domain.vercel.app/?message=purchase-cancelled
  - Customer: user@example.com
📤 Sending to CREEM: {...}
✅ CREEM checkout session created: checkout_xxx
```

### 2. 前端测试

1. **打开控制台** (F12)
2. **以 PRO 用户身份登录**
3. **点击信用点+号**
4. **选择任意信用包**
5. **查看控制台日志**

预期看到：
```
💎 Credit pack button clicked: 300 canPurchase: true
📞 Calling onPurchase with: 300
🔄 UserMenu handlePurchaseCredits called with: 300
✅ onPurchaseCredits callback exists, calling it...
🛒 Purchase Credits clicked: 300
👤 User info: { tier: 'pro', permissionLevel: 2 }
✅ User has paid tier - proceeding with purchase
✅ Session obtained, calling purchase credits API...
```

6. **页面应该跳转到 CREEM 支付页面**

---

## 🚨 常见问题排查

### 问题 1: 仍然 400 Bad Request

**检查**:
1. `NEXT_PUBLIC_SITE_URL` 是否正确设置
2. URL 是否包含协议 (`https://`)
3. URL 是否没有尾部斜杠

**测试**:
```bash
# 在 Vercel 函数日志中查找
🌐 Base URL: ???
```

### 问题 2: 仍然 403 Forbidden

**检查**:
1. CREEM API Key 是否正确
2. 是否使用 Live Key (不是 Test Key)
3. API Key 权限是否足够
4. CREEM 账户是否已激活

**测试**:
```bash
# 使用 curl 测试 API Key
curl -X POST https://api.creem.io/v1/checkouts \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "product_id": "prod_3E171a5TGDhmBhtYM0Gbk3",
    "units": 1,
    "customer": { "email": "test@example.com" },
    "success_url": "https://example.com/success",
    "cancel_url": "https://example.com/cancel"
  }'
```

### 问题 3: 环境变量不生效

**原因**: 修改环境变量后需要重新部署

**解决**:
1. 修改环境变量
2. 点击 **Redeploy** 按钮
3. 或推送新的代码触发自动部署

---

## 📦 部署信息

- **提交 ID**: `f344ebd`
- **分支**: `public-beta`
- **状态**: ✅ 已推送成功
- **部署时间**: 1-2 分钟

---

## 🎯 下一步

### 立即操作

1. **在 Vercel 添加环境变量**:
   ```
   NEXT_PUBLIC_SITE_URL = https://your-actual-domain.vercel.app
   CREEM_API_KEY = creem_live_xxxxxxxxxxxxxx
   ```

2. **重新部署** Vercel 项目

3. **测试购买流程**

### 验证成功的标志

- ✅ 点击购买按钮后跳转到 CREEM 支付页面
- ✅ 服务器日志显示正确的 URL
- ✅ 没有 400 或 403 错误

---

## 💡 最佳实践

### URL 配置建议

**推荐使用自定义域名**:
```
NEXT_PUBLIC_SITE_URL = https://mynook.ai
```

**而不是 Vercel 域名**:
```
NEXT_PUBLIC_SITE_URL = https://mynook-ai-xxx.vercel.app
```

### 安全建议

1. ✅ 使用环境变量存储敏感信息
2. ✅ Production 使用 Live Key
3. ✅ Development 使用 Test Key
4. ❌ 不要在代码中硬编码 API Key
5. ❌ 不要将 .env 文件提交到 git

---

**备注**: 这次更新改进了 URL 构建逻辑和错误处理。但最重要的是在 Vercel 中正确配置环境变量，特别是 `NEXT_PUBLIC_SITE_URL` 和 `CREEM_API_KEY`。配置完成后，信用点购买功能应该可以正常工作了！🎉


