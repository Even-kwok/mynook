# ğŸ”§ CREEM API é”™è¯¯ä¿®å¤æŒ‡å—

**æ—¥æœŸ**: 2025å¹´10æœˆ18æ—¥  
**åˆ†æ”¯**: public-beta  
**æäº¤**: `f344ebd`  
**çŠ¶æ€**: âœ… ä»£ç å·²ä¿®å¤ï¼Œéœ€è¦é…ç½®ç¯å¢ƒå˜é‡

---

## ğŸš¨ é”™è¯¯åˆ†æ

### é”™è¯¯ 1: 400 Bad Request
```json
{
  "status": 400,
  "error": "Bad Request",
  "message": ["URL must be valid, e.g., http://localhost or https://example.com"]
}
```

**åŸå› **: `success_url` å’Œ `cancel_url` æ ¼å¼ä¸æ­£ç¡®æˆ–ä¸ºç©º

### é”™è¯¯ 2: 403 Forbidden
```json
{
  "status": 403,
  "error": "Forbidden"
}
```

**åŸå› **: CREEM API Key ä¸æ­£ç¡®æˆ–æƒé™ä¸è¶³

---

## âœ… ä»£ç ä¿®å¤

### 1. æ”¹è¿› Base URL æ„å»ºé€»è¾‘

**ä¿®æ”¹æ–‡ä»¶**: `api/purchase-credits.js`

```javascript
// âŒ æ—§ä»£ç ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
const baseUrl = process.env.VERCEL_URL 
  ? `https://${process.env.VERCEL_URL}` 
  : 'http://localhost:3000';

// âœ… æ–°ä»£ç ï¼ˆå¤šé‡åå¤‡æ–¹æ¡ˆï¼‰
const baseUrl = process.env.NEXT_PUBLIC_SITE_URL 
  || (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : null)
  || (req.headers.origin)
  || (req.headers.host ? `https://${req.headers.host}` : null)
  || 'https://mynook-ai.vercel.app';  // æœ€ç»ˆåå¤‡

console.log('ğŸŒ Base URL:', baseUrl);
```

**ä¼˜å…ˆçº§é¡ºåº**:
1. `NEXT_PUBLIC_SITE_URL` (ç¯å¢ƒå˜é‡ - æœ€å¯é )
2. `VERCEL_URL` (Vercel è‡ªåŠ¨æ³¨å…¥)
3. `req.headers.origin` (è¯·æ±‚æ¥æº)
4. `req.headers.host` (è¯·æ±‚ä¸»æœº)
5. ç¡¬ç¼–ç åŸŸå (æœ€ç»ˆåå¤‡)

### 2. æ·»åŠ è¯¦ç»†æ—¥å¿—

```javascript
const successUrl = `${baseUrl}/?message=credits-purchased&credits=${pack.credits}`;
const cancelUrl = `${baseUrl}/?message=purchase-cancelled`;

console.log('ğŸ“¦ CREEM Request Details:');
console.log('  - Product ID:', pack.productId);
console.log('  - Success URL:', successUrl);
console.log('  - Cancel URL:', cancelUrl);
console.log('  - Customer:', userData.email);
```

### 3. æ”¹è¿›é”™è¯¯å¤„ç†

```javascript
if (!creemResponse.ok) {
  const errorData = await creemResponse.json().catch(() => ({}));
  console.error('âŒ CREEM API error:', {
    status: creemResponse.status,
    statusText: creemResponse.statusText,
    error: errorData
  });
  
  return res.status(500).json({
    error: 'Payment system error',
    message: errorData.message,
    details: errorData,
    debug: { baseUrl, successUrl, cancelUrl, productId }
  });
}
```

---

## ğŸ”§ Vercel ç¯å¢ƒå˜é‡é…ç½®

### å¿…éœ€çš„ç¯å¢ƒå˜é‡

åœ¨ **Vercel Dashboard â†’ Settings â†’ Environment Variables** æ·»åŠ ï¼š

#### 1. `NEXT_PUBLIC_SITE_URL` â­ æ¨è
```
åç§°: NEXT_PUBLIC_SITE_URL
å€¼: https://your-domain.vercel.app
ç¯å¢ƒ: Production, Preview, Development
```

**è¯´æ˜**: æœ€å¯é çš„æ–¹å¼ï¼Œæ˜ç¡®æŒ‡å®šä½ çš„ç½‘ç«™ URL

#### 2. `CREEM_API_KEY` ğŸ”‘ å¿…éœ€
```
åç§°: CREEM_API_KEY
å€¼: creem_live_xxxxxxxxxxxxxxxx
ç¯å¢ƒ: Production, Preview
```

**è·å–æ–¹å¼**:
1. ç™»å½• CREEM Dashboard: https://dashboard.creem.io
2. è¿›å…¥ Settings â†’ API Keys
3. å¤åˆ¶ Live API Key (ä»¥ `creem_live_` å¼€å¤´)

âš ï¸ **æ³¨æ„**: 
- Production ä½¿ç”¨ Live Key
- Development ä½¿ç”¨ Test Key (ä»¥ `creem_test_` å¼€å¤´)

#### 3. `CREEM_API_URL` (å¯é€‰)
```
åç§°: CREEM_API_URL
å€¼: https://api.creem.io
ç¯å¢ƒ: Production, Preview, Development
```

**è¯´æ˜**: é€šå¸¸ä¸éœ€è¦è®¾ç½®ï¼Œä»£ç ä¸­æœ‰é»˜è®¤å€¼

---

## ğŸ“‹ å®Œæ•´é…ç½®æ£€æŸ¥æ¸…å•

### Vercel ç¯å¢ƒå˜é‡æ£€æŸ¥

- [ ] `SUPABASE_URL` - Supabase é¡¹ç›® URL
- [ ] `SUPABASE_SERVICE_KEY` - Supabase Service Role Key (æœåŠ¡ç«¯)
- [ ] `VITE_SUPABASE_URL` - Supabase é¡¹ç›® URL (å®¢æˆ·ç«¯)
- [ ] `VITE_SUPABASE_ANON_KEY` - Supabase Anon Key (å®¢æˆ·ç«¯)
- [ ] `CREEM_API_KEY` - CREEM API Key â­ æ–°å¢/æ£€æŸ¥
- [ ] `NEXT_PUBLIC_SITE_URL` - ç½‘ç«™ URL â­ æ–°å¢

### CREEM Dashboard æ£€æŸ¥

1. **API Key æƒé™**:
   - [ ] API Key å·²æ¿€æ´»
   - [ ] æƒé™åŒ…å« `checkouts.create`
   - [ ] æ²¡æœ‰ IP ç™½åå•é™åˆ¶ï¼ˆæˆ–å·²æ·»åŠ  Vercel IPï¼‰

2. **äº§å“é…ç½®**:
   - [ ] äº§å“ ID æ­£ç¡®ï¼š
     - 100 Credits: `prod_22tEVFxJtOQU8cm5H10bZc`
     - 300 Credits: `prod_3E171a5TGDhmBhtYM0Gbk3`
     - 1000 Credits: `prod_MmthQ5RlRKNalU3rEsowB`
   - [ ] äº§å“çŠ¶æ€ä¸º Active
   - [ ] äº§å“ç±»å‹ä¸º One-time purchase

3. **Webhook é…ç½®** (ç”¨äºæ¥æ”¶æ”¯ä»˜æˆåŠŸé€šçŸ¥):
   - [ ] Webhook URL: `https://your-domain.vercel.app/api/creem-webhook`
   - [ ] äº‹ä»¶: `checkout.completed`
   - [ ] çŠ¶æ€: Active

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

éƒ¨ç½²ååœ¨ Vercel ä¸­æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼š

```
Dashboard â†’ Deployments â†’ [æœ€æ–°éƒ¨ç½²] â†’ Functions â†’ purchase-credits
```

åº”è¯¥çœ‹åˆ°ï¼š
```
========== Credits Purchase API Called ==========
âœ… Token received
âœ… Supabase credentials found
âœ… Supabase client created
âœ… User authenticated: xxx
âœ… User data retrieved, current credits: xxx
âœ… User has valid membership tier for credit purchases
âœ… Calling CREEM API for credit pack...
ğŸŒ Base URL: https://your-domain.vercel.app
ğŸ“¦ CREEM Request Details:
  - Product ID: prod_3E171a5TGDhmBhtYM0Gbk3
  - Success URL: https://your-domain.vercel.app/?message=credits-purchased&credits=300
  - Cancel URL: https://your-domain.vercel.app/?message=purchase-cancelled
  - Customer: user@example.com
ğŸ“¤ Sending to CREEM: {...}
âœ… CREEM checkout session created: checkout_xxx
```

### 2. å‰ç«¯æµ‹è¯•

1. **æ‰“å¼€æ§åˆ¶å°** (F12)
2. **ä»¥ PRO ç”¨æˆ·èº«ä»½ç™»å½•**
3. **ç‚¹å‡»ä¿¡ç”¨ç‚¹+å·**
4. **é€‰æ‹©ä»»æ„ä¿¡ç”¨åŒ…**
5. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**

é¢„æœŸçœ‹åˆ°ï¼š
```
ğŸ’ Credit pack button clicked: 300 canPurchase: true
ğŸ“ Calling onPurchase with: 300
ğŸ”„ UserMenu handlePurchaseCredits called with: 300
âœ… onPurchaseCredits callback exists, calling it...
ğŸ›’ Purchase Credits clicked: 300
ğŸ‘¤ User info: { tier: 'pro', permissionLevel: 2 }
âœ… User has paid tier - proceeding with purchase
âœ… Session obtained, calling purchase credits API...
```

6. **é¡µé¢åº”è¯¥è·³è½¬åˆ° CREEM æ”¯ä»˜é¡µé¢**

---

## ğŸš¨ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: ä»ç„¶ 400 Bad Request

**æ£€æŸ¥**:
1. `NEXT_PUBLIC_SITE_URL` æ˜¯å¦æ­£ç¡®è®¾ç½®
2. URL æ˜¯å¦åŒ…å«åè®® (`https://`)
3. URL æ˜¯å¦æ²¡æœ‰å°¾éƒ¨æ–œæ 

**æµ‹è¯•**:
```bash
# åœ¨ Vercel å‡½æ•°æ—¥å¿—ä¸­æŸ¥æ‰¾
ğŸŒ Base URL: ???
```

### é—®é¢˜ 2: ä»ç„¶ 403 Forbidden

**æ£€æŸ¥**:
1. CREEM API Key æ˜¯å¦æ­£ç¡®
2. æ˜¯å¦ä½¿ç”¨ Live Key (ä¸æ˜¯ Test Key)
3. API Key æƒé™æ˜¯å¦è¶³å¤Ÿ
4. CREEM è´¦æˆ·æ˜¯å¦å·²æ¿€æ´»

**æµ‹è¯•**:
```bash
# ä½¿ç”¨ curl æµ‹è¯• API Key
curl -X POST https://api.creem.io/v1/checkouts \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "product_id": "prod_3E171a5TGDhmBhtYM0Gbk3",
    "units": 1,
    "customer": { "email": "test@example.com" },
    "success_url": "https://example.com/success",
    "cancel_url": "https://example.com/cancel"
  }'
```

### é—®é¢˜ 3: ç¯å¢ƒå˜é‡ä¸ç”Ÿæ•ˆ

**åŸå› **: ä¿®æ”¹ç¯å¢ƒå˜é‡åéœ€è¦é‡æ–°éƒ¨ç½²

**è§£å†³**:
1. ä¿®æ”¹ç¯å¢ƒå˜é‡
2. ç‚¹å‡» **Redeploy** æŒ‰é’®
3. æˆ–æ¨é€æ–°çš„ä»£ç è§¦å‘è‡ªåŠ¨éƒ¨ç½²

---

## ğŸ“¦ éƒ¨ç½²ä¿¡æ¯

- **æäº¤ ID**: `f344ebd`
- **åˆ†æ”¯**: `public-beta`
- **çŠ¶æ€**: âœ… å·²æ¨é€æˆåŠŸ
- **éƒ¨ç½²æ—¶é—´**: 1-2 åˆ†é’Ÿ

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### ç«‹å³æ“ä½œ

1. **åœ¨ Vercel æ·»åŠ ç¯å¢ƒå˜é‡**:
   ```
   NEXT_PUBLIC_SITE_URL = https://your-actual-domain.vercel.app
   CREEM_API_KEY = creem_live_xxxxxxxxxxxxxx
   ```

2. **é‡æ–°éƒ¨ç½²** Vercel é¡¹ç›®

3. **æµ‹è¯•è´­ä¹°æµç¨‹**

### éªŒè¯æˆåŠŸçš„æ ‡å¿—

- âœ… ç‚¹å‡»è´­ä¹°æŒ‰é’®åè·³è½¬åˆ° CREEM æ”¯ä»˜é¡µé¢
- âœ… æœåŠ¡å™¨æ—¥å¿—æ˜¾ç¤ºæ­£ç¡®çš„ URL
- âœ… æ²¡æœ‰ 400 æˆ– 403 é”™è¯¯

---

## ğŸ’¡ æœ€ä½³å®è·µ

### URL é…ç½®å»ºè®®

**æ¨èä½¿ç”¨è‡ªå®šä¹‰åŸŸå**:
```
NEXT_PUBLIC_SITE_URL = https://mynook.ai
```

**è€Œä¸æ˜¯ Vercel åŸŸå**:
```
NEXT_PUBLIC_SITE_URL = https://mynook-ai-xxx.vercel.app
```

### å®‰å…¨å»ºè®®

1. âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
2. âœ… Production ä½¿ç”¨ Live Key
3. âœ… Development ä½¿ç”¨ Test Key
4. âŒ ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç  API Key
5. âŒ ä¸è¦å°† .env æ–‡ä»¶æäº¤åˆ° git

---

**å¤‡æ³¨**: è¿™æ¬¡æ›´æ–°æ”¹è¿›äº† URL æ„å»ºé€»è¾‘å’Œé”™è¯¯å¤„ç†ã€‚ä½†æœ€é‡è¦çš„æ˜¯åœ¨ Vercel ä¸­æ­£ç¡®é…ç½®ç¯å¢ƒå˜é‡ï¼Œç‰¹åˆ«æ˜¯ `NEXT_PUBLIC_SITE_URL` å’Œ `CREEM_API_KEY`ã€‚é…ç½®å®Œæˆåï¼Œä¿¡ç”¨ç‚¹è´­ä¹°åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼ğŸ‰


