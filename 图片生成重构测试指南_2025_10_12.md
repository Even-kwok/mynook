# 🧪 图片生成重构测试指南

**日期：** 2025年10月12日  
**测试环境：** Vercel 预览部署  
**分支：** feature/free-canvas-optimization

## 📋 测试前准备

### 1. 部署到Vercel
```bash
# 确保所有更改已提交
git add .
git commit -m "refactor: 简化图片生成逻辑，提升性能"
git push origin feature/free-canvas-optimization
```

### 2. 验证环境变量
确保Vercel项目中已配置：
- ✅ `GEMINI_API_KEY` - Google AI Studio API密钥
- ✅ 其他必需的环境变量

### 3. 准备测试账户
- 确保有足够的信用点（建议 ≥50 credits）
- 准备测试图片（室内场景、物品照片等）

## 🎯 核心测试项目

### Test 1: Virtual Staging（最重要）

**目的：** 验证并发生成多张图片的速度提升

**步骤：**
1. 登录系统
2. 进入 "Virtual Staging" 工具
3. 上传一张空房间照片
4. 选择 **3-5个** 不同的设计风格
5. 点击 "Generate" 按钮
6. **记录时间：** 从点击到所有图片生成完成

**预期结果：**
- ✅ 所有图片应该几乎同时开始生成（并发）
- ✅ 总耗时应该接近单张图片的生成时间
- ✅ 不应该看到明显的队列顺序生成
- ✅ 生成速度应该明显比之前快

**对比基准：**
- **之前：** 5张图片 ≈ 5 × 单张时间（队列顺序）
- **现在：** 5张图片 ≈ 单张时间（并发，受API限流）

**检查点：**
- [ ] 所有选中的风格都生成成功
- [ ] 没有超时错误
- [ ] 信用点正确扣除（每张5 credits）
- [ ] UI进度显示流畅
- [ ] 生成失败时有清晰的错误提示

---

### Test 2: Item Replace

**步骤：**
1. 进入 "Item Replace" 工具
2. 上传一张室内照片
3. 上传一张物品照片（如椅子、灯具）
4. 点击 "Replace" 生成

**预期结果：**
- ✅ 生成速度快（单张）
- ✅ 没有不必要的延迟
- ✅ 错误处理正常

**检查点：**
- [ ] 图片生成成功
- [ ] 生成速度感觉流畅
- [ ] 信用点扣除正确（5 credits）

---

### Test 3: Reference Style Match

**步骤：**
1. 进入 "Reference Style Match" 工具
2. 上传目标室内照片
3. 上传参考风格照片
4. 点击生成

**预期结果：**
- ✅ 单张生成快速
- ✅ API调用简洁高效

**检查点：**
- [ ] 风格匹配成功
- [ ] 生成速度正常
- [ ] 信用点扣除正确

---

### Test 4: Multi-Item Preview

**步骤：**
1. 进入 "Multi-Item Preview" 工具
2. 上传室内照片
3. 上传多张物品照片
4. 生成预览

**预期结果：**
- ✅ 能够处理多张输入图片
- ✅ 生成速度不受影响

**检查点：**
- [ ] 多物品组合成功
- [ ] 没有格式错误
- [ ] 信用点正确处理

---

### Test 5: Free Canvas

**目的：** 验证移除 onProgress 后的体验

**步骤：**
1. 进入 "Free Canvas" 工具
2. 上传或绘制图像
3. 添加prompt
4. 点击 "Generate"

**预期结果：**
- ✅ 进度提示显示 "Step 3: Generating your image..."
- ✅ 生成过程流畅
- ✅ 没有因移除回调导致的UI问题

**检查点：**
- [ ] 画布工具正常工作
- [ ] 生成按钮响应
- [ ] 进度文本更新
- [ ] 最终图片显示在画布上
- [ ] 可以继续编辑生成的图片

---

## 🔍 错误场景测试

### Test 6: 信用点不足

**步骤：**
1. 找一个信用点不足5的账户（或手动调整）
2. 尝试生成图片

**预期结果：**
- ✅ 显示清晰错误："Insufficient credits. You need 5 credits but only have X."
- ✅ 信用点不会被扣除
- ✅ 提示用户购买credits

---

### Test 7: 未登录用户

**步骤：**
1. 退出登录
2. 尝试使用任何生成工具

**预期结果：**
- ✅ 显示登录弹窗或提示："Authentication required. Please log in to use this feature."
- ✅ 不会发起API请求

---

### Test 8: 无效图片

**步骤：**
1. 上传损坏或格式错误的图片
2. 尝试生成

**预期结果：**
- ✅ 显示清晰错误提示
- ✅ 如果API调用失败，信用点应该被回滚

---

## 📊 性能对比记录表

### Virtual Staging 性能对比

| 测试场景 | 选择模板数 | 之前耗时 | 现在耗时 | 提升幅度 |
|---------|-----------|---------|---------|---------|
| 场景1   | 3个模板   | ___秒   | ___秒   | ___%    |
| 场景2   | 5个模板   | ___秒   | ___秒   | ___%    |
| 场景3   | 9个模板   | ___秒   | ___秒   | ___%    |

### 其他工具性能

| 工具名称 | 之前耗时 | 现在耗时 | 备注 |
|---------|---------|---------|------|
| Item Replace | ___秒 | ___秒 | 单图 |
| Style Match  | ___秒 | ___秒 | 单图 |
| Multi-Item   | ___秒 | ___秒 | 单图 |
| Free Canvas  | ___秒 | ___秒 | 单图 |

---

## ✅ 测试完成检查表

### 功能测试
- [ ] Virtual Staging - 并发生成正常
- [ ] Item Replace - 单图生成正常
- [ ] Reference Style Match - 风格匹配正常
- [ ] Multi-Item Preview - 多物品处理正常
- [ ] Free Canvas - 画布生成正常

### 错误处理
- [ ] 信用点不足 - 提示正确
- [ ] 未登录 - 提示正确
- [ ] 无效图片 - 错误处理正常
- [ ] API失败 - 信用点回滚正确

### 性能指标
- [ ] Virtual Staging 速度明显提升
- [ ] 其他工具没有性能退化
- [ ] UI响应流畅，无卡顿
- [ ] 没有控制台错误

### 用户体验
- [ ] 进度提示清晰
- [ ] 错误信息易懂
- [ ] 加载状态合理
- [ ] 操作流程顺畅

---

## 🐛 问题报告模板

如果发现问题，请记录：

```markdown
### 问题描述
[描述遇到的问题]

### 复现步骤
1. 
2. 
3. 

### 预期行为
[应该发生什么]

### 实际行为
[实际发生了什么]

### 环境信息
- 浏览器：
- 测试账户：
- 信用点余额：
- 控制台错误（如有）：

### 截图
[如有，请附上截图]
```

---

## 📝 测试结论

**测试日期：** _____________  
**测试人员：** _____________  
**测试环境：** Vercel Preview  

**总体评价：**
- [ ] 通过 - 所有功能正常，性能提升明显
- [ ] 部分通过 - 大部分功能正常，个别问题
- [ ] 未通过 - 存在严重问题，需要修复

**主要发现：**
1. 
2. 
3. 

**下一步行动：**
- [ ] 合并到主分支
- [ ] 需要修复问题
- [ ] 需要进一步优化

---

## 💡 测试技巧

### 查看浏览器控制台
1. 按 F12 打开开发者工具
2. 切换到 "Console" 标签
3. 查看是否有错误或警告
4. 观察API调用时间

### 观察网络请求
1. 开发者工具 → "Network" 标签
2. 筛选 XHR/Fetch 请求
3. 查看 `/api/generate-image` 的响应时间
4. 确认并发请求是同时发起的

### 验证信用点
1. 生成前记录信用点数量
2. 生成后验证扣除是否正确
3. 如果失败，确认信用点是否回滚

---

**祝测试顺利！🎉**

如有任何问题或发现，请及时记录并反馈。

